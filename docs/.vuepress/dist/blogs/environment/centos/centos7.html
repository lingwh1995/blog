<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.49" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://vuepress-theme-hope-v2-demo.mrhope.site/blogs/environment/centos/centos7.html"><meta property="og:site_name" content="此生挚爱万宝路"><meta property="og:title" content="在Centos7上搭建开发环境"><meta property="og:description" content="本篇博客的内容主要介绍安装Centos7操作系统、以及在Centos操作系统上搭建常见的开发环境，如Jdk、Maven、Docker、Rancher、Minikube、Kubernetes、nginx、等软件的详细搭建过程，博客内容中图片较少，主要以实用为主，所有代码均经过严格测试，直接复制运行即可。"><meta property="og:type" content="article"><meta property="og:updated_time" content="2022-07-31T12:57:39.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:tag" content="linux"><meta property="article:tag" content="安装jdk"><meta property="article:tag" content="安装maven"><meta property="article:published_time" content="2020-01-01T00:00:00.000Z"><meta property="article:modified_time" content="2022-07-31T12:57:39.000Z"><link rel="icon" href="/images/headshot.jpg"><title>在Centos7上搭建开发环境 | 此生挚爱万宝路</title><meta name="description" content="本篇博客的内容主要介绍安装Centos7操作系统、以及在Centos操作系统上搭建常见的开发环境，如Jdk、Maven、Docker、Rancher、Minikube、Kubernetes、nginx、等软件的详细搭建过程，博客内容中图片较少，主要以实用为主，所有代码均经过严格测试，直接复制运行即可。">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.8560577a.css">
    <link rel="modulepreload" href="/assets/app.9b9d0ec1.js"><link rel="modulepreload" href="/assets/centos7.html.ec4aa359.js"><link rel="modulepreload" href="/assets/centos7.html.49d68a30.js"><link rel="prefetch" href="/assets/blog.html.11f6c7c8.js"><link rel="prefetch" href="/assets/cinema.html.6b362eb4.js"><link rel="prefetch" href="/assets/index.html.868c77ce.js"><link rel="prefetch" href="/assets/springcloud-eureka.html.f3430d93.js"><link rel="prefetch" href="/assets/404.html.62775fc8.js"><link rel="prefetch" href="/assets/index.html.d1f84df9.js"><link rel="prefetch" href="/assets/index.html.6de1677c.js"><link rel="prefetch" href="/assets/index.html.14a29c14.js"><link rel="prefetch" href="/assets/index.html.023f3067.js"><link rel="prefetch" href="/assets/index.html.0ffb4294.js"><link rel="prefetch" href="/assets/index.html.9ba4533e.js"><link rel="prefetch" href="/assets/index.html.36019b5c.js"><link rel="prefetch" href="/assets/index.html.af41ed0b.js"><link rel="prefetch" href="/assets/index.html.94812cd1.js"><link rel="prefetch" href="/assets/index.html.c5449d7e.js"><link rel="prefetch" href="/assets/index.html.a9925c46.js"><link rel="prefetch" href="/assets/blog.html.567adcc9.js"><link rel="prefetch" href="/assets/cinema.html.92a89a6d.js"><link rel="prefetch" href="/assets/index.html.a1984f29.js"><link rel="prefetch" href="/assets/springcloud-eureka.html.1aaee058.js"><link rel="prefetch" href="/assets/404.html.66a22408.js"><link rel="prefetch" href="/assets/index.html.67e064d9.js"><link rel="prefetch" href="/assets/index.html.0bb28d96.js"><link rel="prefetch" href="/assets/index.html.06e0b496.js"><link rel="prefetch" href="/assets/index.html.0ba55b75.js"><link rel="prefetch" href="/assets/index.html.7545a1c3.js"><link rel="prefetch" href="/assets/index.html.f2c4f902.js"><link rel="prefetch" href="/assets/index.html.4a561dc0.js"><link rel="prefetch" href="/assets/index.html.815f9b09.js"><link rel="prefetch" href="/assets/index.html.9ff8c0c4.js"><link rel="prefetch" href="/assets/index.html.8cf775f7.js"><link rel="prefetch" href="/assets/index.html.372c7ea8.js"><link rel="prefetch" href="/assets/404.2c25b02e.js"><link rel="prefetch" href="/assets/Layout.b61fe13d.js"><link rel="prefetch" href="/assets/Slide.f999bd9d.js"><link rel="prefetch" href="/assets/Blog.6e7204e0.js"><link rel="prefetch" href="/assets/giscus.1696b11c.js"><link rel="prefetch" href="/assets/photoswipe.esm.218074cd.js"><link rel="prefetch" href="/assets/markdown.esm.832a189d.js"><link rel="prefetch" href="/assets/reveal.esm.b96f05d8.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/" class="brand"><img class="logo" src="/images/headshot.jpg" alt="此生挚爱万宝路"><!----><span class="site-name hide-in-pad">此生挚爱万宝路</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="个人主页"><span class="icon iconfont icon-people"></span>个人主页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog.html" class="nav-link" aria-label="博客主页"><span class="icon iconfont icon-blog"></span>博客主页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/cinema.html" class="nav-link" aria-label="放映厅"><span class="icon iconfont icon-creative"></span>放映厅<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="后端"><span class="title"><span class="icon iconfont icon-java"></span>后端</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>springboot</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/posts/article9" class="nav-link" aria-label="springboot-1"><!---->springboot-1<!----></a></li><li class="dropdown-subitem"><a href="/backend/springboot/article2" class="nav-link" aria-label="springboot-2"><!---->springboot-2<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>springcloud</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blogs/backend/springcloud/springcloud-eureka.html" class="nav-link" aria-label="springcloud-eureka"><!---->springcloud-eureka<!----></a></li><li class="dropdown-subitem"><a href="/backend/springcloud/article/article6" class="nav-link" aria-label="springcloud-zookeeper"><!---->springcloud-zookeeper<!----></a></li><li class="dropdown-subitem"><a href="/backend/springcloud/article/article6" class="nav-link" aria-label="springcloud-consul"><!---->springcloud-consul<!----></a></li><li class="dropdown-subitem"><a href="/backend/springcloud/article/article6" class="nav-link" aria-label="springcloud-alibaba"><!---->springcloud-alibaba<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="前端"><span class="title"><span class="icon iconfont icon-html"></span>前端</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/xxx" class="nav-link" aria-label="ECMAScript 5"><!---->ECMAScript 5<!----></a></li><li class="dropdown-item"><a href="/xxx" class="nav-link" aria-label="ECMAScript 6"><!---->ECMAScript 6<!----></a></li><li class="dropdown-item"><a href="/xxx" class="nav-link" aria-label="Framework"><!---->Framework<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="数据库"><span class="title"><span class="icon iconfont icon-mysql"></span>数据库</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>关系型数据库</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/database/relational database/article1" class="nav-link" aria-label="mysql"><!---->mysql<!----></a></li><li class="dropdown-subitem"><a href="/database/relational database/article2" class="nav-link" aria-label="oracle"><!---->oracle<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>nosql</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/database/nosql/article/article5" class="nav-link" aria-label="monogodb"><!---->monogodb<!----></a></li><li class="dropdown-subitem"><a href="/database/nosql/article/article6" class="nav-link" aria-label="redis"><!---->redis<!----></a></li><li class="dropdown-subitem"><a href="/database/nosql/article/article6" class="nav-link" aria-label="etcd"><!---->etcd<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="环境搭建"><span class="title"><span class="icon iconfont icon-software"></span>环境搭建</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html" class="router-link-active router-link-exact-active nav-link active" aria-label="centos"><!---->centos<!----></a></li><li class="dropdown-item"><a href="/blogs/environment/windows/windows" class="nav-link" aria-label="windows"><!---->windows<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="https://github.com/lingwh1995" rel="noopener noreferrer" target="_blank" aria-label="GITHUB" class="nav-link"><span class="icon iconfont icon-github"></span>GITHUB<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="nav-item hide-in-mobile"><a href="https://gitee.com/lingwh1995" rel="noopener noreferrer" target="_blank" aria-label="GITEE" class="nav-link"><span class="icon iconfont icon-gitee"></span>GITEE<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!----></div><div class="navbar-right"><!----><!----><div class="nav-item"><a class="repo-link" href="https://gitee.com/lingwh1995" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon gitee-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="gitee icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm242.97-533.34H482.39a23.7 23.7 0 0 0-23.7 23.7l-.03 59.28c0 13.08 10.59 23.7 23.7 23.7h165.96a23.7 23.7 0 0 1 23.7 23.7v11.85a71.1 71.1 0 0 1-71.1 71.1H375.71a23.7 23.7 0 0 1-23.7-23.7V423.11a71.1 71.1 0 0 1 71.1-71.1h331.8a23.7 23.7 0 0 0 23.7-23.7l.06-59.25a23.73 23.73 0 0 0-23.7-23.73H423.11a177.78 177.78 0 0 0-177.78 177.75v331.83c0 13.08 10.62 23.7 23.7 23.7h349.62a159.99 159.99 0 0 0 159.99-159.99V482.33a23.7 23.7 0 0 0-23.7-23.7z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!----><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a aria-current="page" href="/blogs/environment/centos/centos7.html#博客介绍" class="router-link-active router-link-exact-active nav-link sidebar-link sidebar-heading" aria-label="博客介绍"><!---->博客介绍<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#博客内容概述" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="博客内容概述"><!---->博客内容概述<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#博客大纲" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="博客大纲"><!---->博客大纲<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#简单版博客内容大纲" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="简单版博客内容大纲"><!---->简单版博客内容大纲<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#详细版博客内容大纲" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="详细版博客内容大纲"><!---->详细版博客内容大纲<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/blogs/environment/centos/centos7.html#_1-安装linux操作系统" class="router-link-active router-link-exact-active nav-link sidebar-link sidebar-heading" aria-label="1.安装Linux操作系统"><!---->1.安装Linux操作系统<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_1-1章节大纲" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.1章节大纲"><!---->1.1章节大纲<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_1-1-linux重要目录介绍" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.1.Linux重要目录介绍"><!---->1.1.Linux重要目录介绍<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_1-2-centos镜像下载" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.2.Centos镜像下载"><!---->1.2.Centos镜像下载<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_1-3-安装前vmaware相关设置" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.3.安装前Vmaware相关设置"><!---->1.3.安装前Vmaware相关设置<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_1-3-安装时分区大小设置" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.3.安装时分区大小设置"><!---->1.3.安装时分区大小设置<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-linux操作系统初始设置" class="router-link-active router-link-exact-active nav-link sidebar-link sidebar-heading" aria-label="2.Linux操作系统初始设置"><!---->2.Linux操作系统初始设置<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-1章节大纲" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.1章节大纲"><!---->2.1章节大纲<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-1-配置静态ip地址" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.1.配置静态IP地址"><!---->2.1.配置静态IP地址<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-2-解决远程连接无法连接的问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.2.解决远程连接无法连接的问题"><!---->2.2.解决远程连接无法连接的问题<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-3-设置系统环境变量" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.3.设置系统环境变量"><!---->2.3.设置系统环境变量<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-4-安装curl" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.4.安装curl"><!---->2.4.安装curl<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-5-配置yml源" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.5.配置yml源"><!---->2.5.配置yml源<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-6-安装常用基础系统软件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.6.安装常用基础系统软件"><!---->2.6.安装常用基础系统软件<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-6-1-手动安装常用软件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.6.1.手动安装常用软件"><!---->2.6.1.手动安装常用软件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-6-2-使用脚本安装常用软件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.6.2.使用脚本安装常用软件"><!---->2.6.2.使用脚本安装常用软件<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/blogs/environment/centos/centos7.html#_3-搭建基础开发环境" class="router-link-active router-link-exact-active nav-link sidebar-link sidebar-heading" aria-label="3.搭建基础开发环境"><!---->3.搭建基础开发环境<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_3-1章节大纲" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.1章节大纲"><!---->3.1章节大纲<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_3-1-安装jdk" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.1.安装jdk"><!---->3.1.安装jdk<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_3-2-安装maven" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.2.安装maven"><!---->3.2.安装maven<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_3-3-安装mysql" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.3.安装mysql"><!---->3.3.安装mysql<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-centos搭建docker" class="router-link-active router-link-exact-active nav-link sidebar-link sidebar-heading" aria-label="4.Centos搭建docker"><!---->4.Centos搭建docker<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-1章节大纲" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.1章节大纲"><!---->4.1章节大纲<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-1-安装docker" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.1.安装docker"><!---->4.1.安装docker<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-1-1-在线安装docker" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.1.1.在线安装docker"><!---->4.1.1.在线安装docker<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-1-2-二进制包安装docker" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.1.2.二进制包安装docker"><!---->4.1.2.二进制包安装docker<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-2-docker启动故障解决" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.2.docker启动故障解决"><!---->4.2.docker启动故障解决<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-3-docker容器可视化" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.3.docker容器可视化"><!---->4.3.docker容器可视化<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-4-搭建docke私服" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.4.搭建docke私服"><!---->4.4.搭建docke私服<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-4-1搭建docke官方私服-不带有用户名和密码校验" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.4.1搭建docke官方私服（不带有用户名和密码校验）"><!---->4.4.1搭建docke官方私服（不带有用户名和密码校验）<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-4-2搭建docke官方私服-带有用户名和密码校验" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.4.2搭建docke官方私服（带有用户名和密码校验）"><!---->4.4.2搭建docke官方私服（带有用户名和密码校验）<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-4-3-搭建harbor私服" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.4.3.搭建harbor私服"><!---->4.4.3.搭建harbor私服<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-4-3-1-harbor简介" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.4.3.1.harbor简介"><!---->4.4.3.1.harbor简介<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-4-3-2-搭建docker-compose" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.4.3.2.搭建docker-compose"><!---->4.4.3.2.搭建docker-compose<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-4-3-3-安装harbor" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.4.3.3.安装harbor"><!---->4.4.3.3.安装harbor<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/blogs/environment/centos/centos7.html#_5-centos搭建rancher" class="router-link-active router-link-exact-active nav-link sidebar-link sidebar-heading" aria-label="5.Centos搭建Rancher"><!---->5.Centos搭建Rancher<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_5-1章节大纲" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.1章节大纲"><!---->5.1章节大纲<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-centos搭建minikube" class="router-link-active router-link-exact-active nav-link sidebar-link sidebar-heading" aria-label="6.Centos搭建Minikube"><!---->6.Centos搭建Minikube<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-1章节大纲" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6.1章节大纲"><!---->6.1章节大纲<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-1-minikube介绍" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6.1.minikube介绍"><!---->6.1.minikube介绍<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-2-版本说明" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6.2.版本说明"><!---->6.2.版本说明<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-3-开启vmware虚拟化" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6.3.开启Vmware虚拟化"><!---->6.3.开启Vmware虚拟化<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-4-安装kubectl" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6.4.安装kubectl"><!---->6.4.安装kubectl<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-5-安装minikube" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6.5.安装minikube"><!---->6.5.安装minikube<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-6-使用阿里云加速docker-hub" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6.6.使用阿里云加速docker hub"><!---->6.6.使用阿里云加速docker hub<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-7-启动minikube" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6.7.启动minikube"><!---->6.7.启动minikube<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-8-minikube常用命令" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6.8.minikube常用命令"><!---->6.8.minikube常用命令<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-kubeadm搭建kubernetes" class="router-link-active router-link-exact-active nav-link sidebar-link sidebar-heading" aria-label="7.kubeadm搭建Kubernetes"><!---->7.kubeadm搭建Kubernetes<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-1章节大纲" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.1章节大纲"><!---->7.1章节大纲<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-1-特别说明" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.1.特别说明"><!---->7.1.特别说明<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-2-所有节点设置对应主机名" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.2.所有节点设置对应主机名"><!---->7.2.所有节点设置对应主机名<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-3-所有节点修改hosts" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.3.所有节点修改hosts"><!---->7.3.所有节点修改hosts<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-4-所有节点关闭selinux" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.4.所有节点关闭SELinux"><!---->7.4.所有节点关闭SELinux<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-5-所有节点关闭防火墙" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.5.所有节点关闭防火墙"><!---->7.5.所有节点关闭防火墙<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-6-所有节点安装docker" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.6.所有节点安装docker"><!---->7.6.所有节点安装docker<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-7-所有节点安装k8s所需组件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.7.所有节点安装k8s所需组件"><!---->7.7.所有节点安装k8s所需组件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-8-所有节点启动kubelet和docker" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.8.所有节点启动kubelet和docker"><!---->7.8.所有节点启动kubelet和docker<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-9-所有关闭swap" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.9.所有关闭swap"><!---->7.9.所有关闭swap<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-10-用kubeadm-初始化集群" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.10.用kubeadm 初始化集群"><!---->7.10.用kubeadm 初始化集群<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-11-其他节点连接到master节点" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.11.其他节点连接到Master节点"><!---->7.11.其他节点连接到Master节点<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-12-在master节点上查看集群" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.12.在master节点上查看集群"><!---->7.12.在master节点上查看集群<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-13-安装网络插件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.13.安装网络插件"><!---->7.13.安装网络插件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-14-在master上查看集群节点" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.14.在master上查看集群节点"><!---->7.14.在master上查看集群节点<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-15-启动故障解决" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.15.启动故障解决"><!---->7.15.启动故障解决<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-16-基础命令" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.16.基础命令"><!---->7.16.基础命令<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-17-部署第一个程序到k8s中" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.17.部署第一个程序到k8s中"><!---->7.17.部署第一个程序到k8s中<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-18-可视化面板kuboard" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="7.18.可视化面板kuboard"><!---->7.18.可视化面板kuboard<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-二进制包搭建kubernetes" class="router-link-active router-link-exact-active nav-link sidebar-link sidebar-heading" aria-label="8.二进制包搭建Kubernetes"><!---->8.二进制包搭建Kubernetes<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-1章节大纲" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.1章节大纲"><!---->8.1章节大纲<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-1-环境配置清单" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.1.环境配置清单"><!---->8.1.环境配置清单<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-2-服务器规划和ip地址规划" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.2.服务器规划和IP地址规划"><!---->8.2.服务器规划和IP地址规划<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-2-1服务器规划" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.2.1服务器规划"><!---->8.2.1服务器规划<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-2-2-ip地址规划" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.2.2.IP地址规划"><!---->8.2.2.IP地址规划<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-3-安装前准备工作" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.3.安装前准备工作"><!---->8.3.安装前准备工作<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-3-1操作系统初始设置" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.3.1操作系统初始设置"><!---->8.3.1操作系统初始设置<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-3-2下载所有用到的软件包" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.3.2下载所有用到的软件包"><!---->8.3.2下载所有用到的软件包<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-4-安装cfssl证书生成工具" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.4.安装cfssl证书生成工具"><!---->8.4.安装cfssl证书生成工具<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-5-搭建etcd集群" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.5.搭建etcd集群"><!---->8.5.搭建etcd集群<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-5-1生成ca证书和https证书" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.5.1生成CA证书和https证书"><!---->8.5.1生成CA证书和https证书<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-5-2-部署etcd集群" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.5.2.部署etcd集群"><!---->8.5.2.部署etcd集群<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-5-4-拷贝etcd所需证书" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.5.4.拷贝etcd所需证书"><!---->8.5.4.拷贝etcd所需证书<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-5-5-让systemd管理etcd" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.5.5.让systemd管理etcd"><!---->8.5.5.让systemd管理etcd<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-5-6-拷贝etcd安装文件到worker-node" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.5.6.拷贝etcd安装文件到Worker Node"><!---->8.5.6.拷贝etcd安装文件到Worker Node<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-5-7-启动三个etcd并设置开机自启" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.5.7.启动三个etcd并设置开机自启"><!---->8.5.7.启动三个etcd并设置开机自启<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-6-安装配置docker" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.6.安装配置Docker"><!---->8.6.安装配置Docker<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-6-1在master1上安装docker" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.6.1在Master1上安装docker"><!---->8.6.1在Master1上安装docker<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-6-2在所有worker-node上安装docker" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.6.2在所有Worker Node上安装docker"><!---->8.6.2在所有Worker Node上安装docker<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-6-3启动三台机器上的docker" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.6.3启动三台机器上的docker"><!---->8.6.3启动三台机器上的docker<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-7-搭建kube-apiserver" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.7.搭建kube-apiserver"><!---->8.7.搭建kube-apiserver<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-7-1-生成ca证书和https证书" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.7.1.生成CA证书和Https证书"><!---->8.7.1.生成CA证书和Https证书<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-7-2-在master-node1上部署kube-apiserver" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.7.2.在Master Node1上部署kube-apiserver"><!---->8.7.2.在Master Node1上部署kube-apiserver<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-7-3-拷贝所需证书" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.7.3.拷贝所需证书"><!---->8.7.3.拷贝所需证书<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-7-4-启用tls-bootstrapping" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.7.4.启用TLS bootstrapping"><!---->8.7.4.启用TLS bootstrapping<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-7-5-让systemd管理apiserver" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.7.5.让systemd管理apiserver"><!---->8.7.5.让systemd管理apiserver<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-7-6-启动kube-apiserver" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.7.6.启动kube-apiserver"><!---->8.7.6.启动kube-apiserver<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-8-在master-node1上部署kube-controller-manager" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.8.在Master Node1上部署kube-controller-manager"><!---->8.8.在Master Node1上部署kube-controller-manager<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-8-1-切换目录并拷贝kube-controller-manager相关文件到-opt-kubernetes-bin" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.8.1.切换目录并拷贝kube-controller-manager相关文件到/opt/kubernetes/bin"><!---->8.8.1.切换目录并拷贝kube-controller-manager相关文件到/opt/kubernetes/bin<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-8-2-生成证书" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.8.2.生成证书"><!---->8.8.2.生成证书<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-8-2-创建kube-controller-manager配置文件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.8.2.创建kube-controller-manager配置文件"><!---->8.8.2.创建kube-controller-manager配置文件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-8-3-生成配置文件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.8.3.生成配置文件"><!---->8.8.3.生成配置文件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-8-4-让systemd管理controller-manager" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.8.4.让systemd管理controller-manager"><!---->8.8.4.让systemd管理controller-manager<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-8-5-启动kube-controller-manager" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.8.5.启动kube-controller-manager"><!---->8.8.5.启动kube-controller-manager<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-9-部署kube-scheduler" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.9.部署kube-scheduler"><!---->8.9.部署kube-scheduler<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-8-1-切换目录并拷贝kube-dcheduler相关文件到-opt-kubernetes-bin" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.8.1 切换目录并拷贝kube-dcheduler相关文件到/opt/kubernetes/bin"><!---->8.8.1 切换目录并拷贝kube-dcheduler相关文件到/opt/kubernetes/bin<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-9-2-生成证书" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.9.2.生成证书"><!---->8.9.2.生成证书<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-9-3-创建kube-scheduler-conf配置文件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.9.3.创建kube-scheduler.conf配置文件"><!---->8.9.3.创建kube-scheduler.conf配置文件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-9-4-生成kube-scheduler-kubeconfig文件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.9.4.生成kube-scheduler.kubeconfig文件"><!---->8.9.4.生成kube-scheduler.kubeconfig文件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-9-5-让systemd管理kube-scheduler" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.9.5.让systemd管理kube-scheduler"><!---->8.9.5.让systemd管理kube-scheduler<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-9-6-启动并设置开机启动" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.9.6.启动并设置开机启动"><!---->8.9.6.启动并设置开机启动<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-10-使用kubectl查看集群状态" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.10.使用kubectl查看集群状态"><!---->8.10.使用kubectl查看集群状态<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-10-1-生成所需证书" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.10.1.生成所需证书"><!---->8.10.1.生成所需证书<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-10-2-在-kube文件夹中生成config文件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.10.2.在.kube文件夹中生成config文件"><!---->8.10.2.在.kube文件夹中生成config文件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-10-3-通过kubectl工具查看集群组件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.10.3.通过kubectl工具查看集群组件"><!---->8.10.3.通过kubectl工具查看集群组件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-10-4-授权kubelet-bootstrap用户允许请求证书" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.10.4.授权kubelet-bootstrap用户允许请求证书"><!---->8.10.4.授权kubelet-bootstrap用户允许请求证书<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-在master-node1上部署第一个worker-node" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.11.在Master Node1上部署第一个Worker Node"><!---->8.11.在Master Node1上部署第一个Worker Node<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-2-在master-node1部署kubelet" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.11.2.在Master Node1部署kubelet"><!---->8.11.2.在Master Node1部署kubelet<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-2-1-创建kubelet配置文件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.11.2.1.创建kubelet配置文件"><!---->8.11.2.1.创建kubelet配置文件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-2-2-创建kubelet编排文件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.11.2.2.创建kubelet编排文件"><!---->8.11.2.2.创建kubelet编排文件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-2-3-生成kubelet初次加入集群引导kubeconfig文件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.11.2.3.生成kubelet初次加入集群引导kubeconfig文件"><!---->8.11.2.3.生成kubelet初次加入集群引导kubeconfig文件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-2-4-systemd管理kubelet" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.11.2.4.systemd管理kubelet"><!---->8.11.2.4.systemd管理kubelet<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-3-5-启动kubelet并设置开机启动" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.11.3.5.启动kubelet并设置开机启动"><!---->8.11.3.5.启动kubelet并设置开机启动<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-2-6-允许kubelet证书申请并加入集群" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.11.2.6.允许kubelet证书申请并加入集群"><!---->8.11.2.6.允许kubelet证书申请并加入集群<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-3-部署kube-proxy" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.11.3.部署kube-proxy"><!---->8.11.3.部署kube-proxy<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-3-1-创建kube-proxy配置文件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.11.3.1.创建kube-proxy配置文件"><!---->8.11.3.1.创建kube-proxy配置文件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-3-2-配置参数文件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.11.3.2.配置参数文件"><!---->8.11.3.2.配置参数文件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-3-3-生成kube-proxy证书文件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.11.3.3.生成kube-proxy证书文件"><!---->8.11.3.3.生成kube-proxy证书文件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-3-4-生成kube-proxy-kubeconfig文件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.11.3.4.生成kube-proxy.kubeconfig文件"><!---->8.11.3.4.生成kube-proxy.kubeconfig文件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-3-5-systemd管理kube-proxy" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.11.3.5.systemd管理kube-proxy"><!---->8.11.3.5.systemd管理kube-proxy<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-10-3-6-启动kube-proxy并设置开机自启" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.10.3.6.启动kube-proxy并设置开机自启"><!---->8.10.3.6.启动kube-proxy并设置开机自启<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-4-部署网络组件-calico" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.11.4.部署网络组件(Calico)"><!---->8.11.4.部署网络组件(Calico)<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-5-授权apiserver访问kubelet" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.11.5.授权apiserver访问kubelet"><!---->8.11.5.授权apiserver访问kubelet<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-增加worker-node" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.12.增加Worker Node"><!---->8.12.增加Worker Node<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-1-在所有worker-node创建工作目录并拷贝二进制文件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.12.1.在所有Worker Node创建工作目录并拷贝二进制文件"><!---->8.12.1.在所有Worker Node创建工作目录并拷贝二进制文件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-2拷贝master-node1上部署好的文件到worker-node" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.12.2拷贝Master Node1上部署好的文件到Worker Node"><!---->8.12.2拷贝Master Node1上部署好的文件到Worker Node<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-3-删除所有worker-node中kubelet证书和kubeconfig文件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.12.3.删除所有Worker Node中kubelet证书和kubeconfig文件"><!---->8.12.3.删除所有Worker Node中kubelet证书和kubeconfig文件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-4-修改worker-node1和worker-node2主机名" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.12.4. 修改Worker Node1和Worker Node2主机名"><!---->8.12.4. 修改Worker Node1和Worker Node2主机名<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-5-启动worker-node1和worker-node2中kubelet并设置开机自启" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.12.5.启动Worker Node1和Worker Node2中kubelet并设置开机自启"><!---->8.12.5.启动Worker Node1和Worker Node2中kubelet并设置开机自启<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-6-在master1上同意新的node-kubelet证书申请" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.12.6.在Master1上同意新的Node kubelet证书申请"><!---->8.12.6.在Master1上同意新的Node kubelet证书申请<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-7-在master1上部署kubernetes-dashboard" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.12.7.在Master1上部署kubernetes-dashboard"><!---->8.12.7.在Master1上部署kubernetes-dashboard<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-8-在master1上部署coredns" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.12.8.在Master1上部署CoreDNS"><!---->8.12.8.在Master1上部署CoreDNS<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-13-增加master2节点" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.13.增加Master2节点"><!---->8.13.增加Master2节点<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-13-1-kubernetes集群架构简介" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.13.1.Kubernetes集群架构简介"><!---->8.13.1.Kubernetes集群架构简介<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-13-2-给master-node2安装docker" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.13.2.给Master Node2安装Docker"><!---->8.13.2.给Master Node2安装Docker<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-13-5-给master-node2节点拷贝所有需要的证书" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.13.5.给Master Node2节点拷贝所有需要的证书"><!---->8.13.5.给Master Node2节点拷贝所有需要的证书<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-13-6-启动master所有服务并设置开机自启" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.13.6.启动Master所有服务并设置开机自启"><!---->8.13.6.启动Master所有服务并设置开机自启<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-13-7-在master查看集群组件状态" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.13.7.在Master查看集群组件状态"><!---->8.13.7.在Master查看集群组件状态<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-13-8-审批所有worker-node上的kubelet证书申请" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.13.8.审批所有Worker  Node上的kubelet证书申请"><!---->8.13.8.审批所有Worker  Node上的kubelet证书申请<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-部署nginx-keepalived高可用负载均衡器" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.14.部署Nginx+Keepalived高可用负载均衡器"><!---->8.14.部署Nginx+Keepalived高可用负载均衡器<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-1-nginx和keepalived简介" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.14.1.Nginx和Keepalived简介"><!---->8.14.1.Nginx和Keepalived简介<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-2-在两台master-node上安装软件" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.14.2.在两台Master Node上安装软件"><!---->8.14.2.在两台Master Node上安装软件<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-3-nginx增加steam模块" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.14.3.Nginx增加Steam模块"><!---->8.14.3.Nginx增加Steam模块<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-3-1-查看nginx版本模块" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.14.3.1.查看Nginx版本模块"><!---->8.14.3.1.查看Nginx版本模块<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-3-2-master1和master2安装stream模块" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.14.3.2.Master1和Master2安装Stream模块"><!---->8.14.3.2.Master1和Master2安装Stream模块<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-4-启动nginx、keepalived并设置开机自启-master1-master2" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.14.4.启动nginx、keepalived并设置开机自启(master1/master2)"><!---->8.14.4.启动nginx、keepalived并设置开机自启(master1/master2)<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-5-查看keepalived工作状态" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.14.5.查看keepalived工作状态"><!---->8.14.5.查看keepalived工作状态<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-6-nginx-keepalived高可用测试" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.14.6.Nginx+keepalived高可用测试"><!---->8.14.6.Nginx+keepalived高可用测试<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-7-测试负载均衡器" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.14.7.测试负载均衡器"><!---->8.14.7.测试负载均衡器<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-8-修改所有的worker-node连接lb-vip" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.14.8.修改所有的Worker Node连接LB VIP"><!---->8.14.8.修改所有的Worker Node连接LB VIP<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-15-部署常见问题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.15.部署常见问题"><!---->8.15.部署常见问题<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-15-1系统断电后-某个etcd节点无法启动" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.15.1系统断电后,某个etcd节点无法启动"><!---->8.15.1系统断电后,某个etcd节点无法启动<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-15-2-the-connection-to-the-server-localhost-8080-was-refused-did-you-specify-the-right-host-or-port" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.15.2 The connection to the server localhost:8080 was refused - did you specify the right host or port?"><!---->8.15.2 The connection to the server localhost:8080 was refused - did you specify the right host or port?<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-16-部署测试程序" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="8.16.部署测试程序"><!---->8.16.部署测试程序<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><span class="icon iconfont icon-linux"></span>在Centos7上搭建开发环境</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down" localizeddate="2020年1月1日" isoriginal="true" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://github.com/lingwh1995" target="_blank" rel="noopener noreferrer">lingwh</a></span><span property="author" content="lingwh"></span></span><span class="origin" localizeddate="2020年1月1日" pageview="false" pure="false">原创</span><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down" isoriginal="true" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2020年1月1日</span><meta property="datePublished" content="2020-01-01T00:00:00.000Z"></span><span class="category-info" aria-label="分类🌈" data-balloon-pos="down" localizeddate="2020年1月1日" isoriginal="true" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><ul class="categories-wrapper"><li class="category category7 clickable" role="navigation">环境搭建</li><meta property="articleSection" content="环境搭建"></ul></span><span aria-label="标签🏷" data-balloon-pos="down" localizeddate="2020年1月1日" isoriginal="true" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><ul class="tags-wrapper"><li class="tag tag6 clickable" role="navigation">linux</li><li class="tag tag8 clickable" role="navigation">安装jdk</li><li class="tag tag5 clickable" role="navigation">安装maven</li></ul><meta property="keywords" content="linux,安装jdk,安装maven"></span><span class="reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down" localizeddate="2020年1月1日" isoriginal="true" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewbox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 68 分钟</span><meta property="timeRequired" content="PT68M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#博客介绍" class="router-link-active router-link-exact-active toc-link level1">博客介绍</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#博客内容概述" class="router-link-active router-link-exact-active toc-link level2">博客内容概述</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#博客大纲" class="router-link-active router-link-exact-active toc-link level2">博客大纲</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#简单版博客内容大纲" class="router-link-active router-link-exact-active toc-link level3">简单版博客内容大纲</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#详细版博客内容大纲" class="router-link-active router-link-exact-active toc-link level3">详细版博客内容大纲</a></li><!----><!--]--></ul><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_1-安装linux操作系统" class="router-link-active router-link-exact-active toc-link level1">1.安装Linux操作系统</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_1-1章节大纲" class="router-link-active router-link-exact-active toc-link level2">1.1章节大纲</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_1-1-linux重要目录介绍" class="router-link-active router-link-exact-active toc-link level2">1.1.Linux重要目录介绍</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_1-2-centos镜像下载" class="router-link-active router-link-exact-active toc-link level2">1.2.Centos镜像下载</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_1-3-安装前vmaware相关设置" class="router-link-active router-link-exact-active toc-link level2">1.3.安装前Vmaware相关设置</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_1-3-安装时分区大小设置" class="router-link-active router-link-exact-active toc-link level2">1.3.安装时分区大小设置</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-linux操作系统初始设置" class="router-link-active router-link-exact-active toc-link level1">2.Linux操作系统初始设置</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-1章节大纲" class="router-link-active router-link-exact-active toc-link level2">2.1章节大纲</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-1-配置静态ip地址" class="router-link-active router-link-exact-active toc-link level2">2.1.配置静态IP地址</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-2-解决远程连接无法连接的问题" class="router-link-active router-link-exact-active toc-link level2">2.2.解决远程连接无法连接的问题</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-3-设置系统环境变量" class="router-link-active router-link-exact-active toc-link level2">2.3.设置系统环境变量</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-4-安装curl" class="router-link-active router-link-exact-active toc-link level2">2.4.安装curl</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-5-配置yml源" class="router-link-active router-link-exact-active toc-link level2">2.5.配置yml源</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-6-安装常用基础系统软件" class="router-link-active router-link-exact-active toc-link level2">2.6.安装常用基础系统软件</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-6-1-手动安装常用软件" class="router-link-active router-link-exact-active toc-link level3">2.6.1.手动安装常用软件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_2-6-2-使用脚本安装常用软件" class="router-link-active router-link-exact-active toc-link level3">2.6.2.使用脚本安装常用软件</a></li><!----><!--]--></ul><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_3-搭建基础开发环境" class="router-link-active router-link-exact-active toc-link level1">3.搭建基础开发环境</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_3-1章节大纲" class="router-link-active router-link-exact-active toc-link level2">3.1章节大纲</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_3-1-安装jdk" class="router-link-active router-link-exact-active toc-link level2">3.1.安装jdk</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_3-2-安装maven" class="router-link-active router-link-exact-active toc-link level2">3.2.安装maven</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_3-3-安装mysql" class="router-link-active router-link-exact-active toc-link level2">3.3.安装mysql</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-centos搭建docker" class="router-link-active router-link-exact-active toc-link level1">4.Centos搭建docker</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-1章节大纲" class="router-link-active router-link-exact-active toc-link level2">4.1章节大纲</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-1-安装docker" class="router-link-active router-link-exact-active toc-link level2">4.1.安装docker</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-1-1-在线安装docker" class="router-link-active router-link-exact-active toc-link level3">4.1.1.在线安装docker</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-1-2-二进制包安装docker" class="router-link-active router-link-exact-active toc-link level3">4.1.2.二进制包安装docker</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-2-docker启动故障解决" class="router-link-active router-link-exact-active toc-link level2">4.2.docker启动故障解决</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-3-docker容器可视化" class="router-link-active router-link-exact-active toc-link level2">4.3.docker容器可视化</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-4-搭建docke私服" class="router-link-active router-link-exact-active toc-link level2">4.4.搭建docke私服</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-4-1搭建docke官方私服-不带有用户名和密码校验" class="router-link-active router-link-exact-active toc-link level2">4.4.1搭建docke官方私服（不带有用户名和密码校验）</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-4-2搭建docke官方私服-带有用户名和密码校验" class="router-link-active router-link-exact-active toc-link level2">4.4.2搭建docke官方私服（带有用户名和密码校验）</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-4-3-搭建harbor私服" class="router-link-active router-link-exact-active toc-link level2">4.4.3.搭建harbor私服</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-4-3-1-harbor简介" class="router-link-active router-link-exact-active toc-link level3">4.4.3.1.harbor简介</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-4-3-2-搭建docker-compose" class="router-link-active router-link-exact-active toc-link level3">4.4.3.2.搭建docker-compose</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_4-4-3-3-安装harbor" class="router-link-active router-link-exact-active toc-link level3">4.4.3.3.安装harbor</a></li><!----><!--]--></ul><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_5-centos搭建rancher" class="router-link-active router-link-exact-active toc-link level1">5.Centos搭建Rancher</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_5-1章节大纲" class="router-link-active router-link-exact-active toc-link level2">5.1章节大纲</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-centos搭建minikube" class="router-link-active router-link-exact-active toc-link level1">6.Centos搭建Minikube</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-1章节大纲" class="router-link-active router-link-exact-active toc-link level2">6.1章节大纲</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-1-minikube介绍" class="router-link-active router-link-exact-active toc-link level2">6.1.minikube介绍</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-2-版本说明" class="router-link-active router-link-exact-active toc-link level2">6.2.版本说明</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-3-开启vmware虚拟化" class="router-link-active router-link-exact-active toc-link level2">6.3.开启Vmware虚拟化</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-4-安装kubectl" class="router-link-active router-link-exact-active toc-link level2">6.4.安装kubectl</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-5-安装minikube" class="router-link-active router-link-exact-active toc-link level2">6.5.安装minikube</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-6-使用阿里云加速docker-hub" class="router-link-active router-link-exact-active toc-link level2">6.6.使用阿里云加速docker hub</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-7-启动minikube" class="router-link-active router-link-exact-active toc-link level2">6.7.启动minikube</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_6-8-minikube常用命令" class="router-link-active router-link-exact-active toc-link level2">6.8.minikube常用命令</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-kubeadm搭建kubernetes" class="router-link-active router-link-exact-active toc-link level1">7.kubeadm搭建Kubernetes</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-1章节大纲" class="router-link-active router-link-exact-active toc-link level2">7.1章节大纲</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-1-特别说明" class="router-link-active router-link-exact-active toc-link level2">7.1.特别说明</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-2-所有节点设置对应主机名" class="router-link-active router-link-exact-active toc-link level2">7.2.所有节点设置对应主机名</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-3-所有节点修改hosts" class="router-link-active router-link-exact-active toc-link level2">7.3.所有节点修改hosts</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-4-所有节点关闭selinux" class="router-link-active router-link-exact-active toc-link level2">7.4.所有节点关闭SELinux</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-5-所有节点关闭防火墙" class="router-link-active router-link-exact-active toc-link level2">7.5.所有节点关闭防火墙</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-6-所有节点安装docker" class="router-link-active router-link-exact-active toc-link level2">7.6.所有节点安装docker</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-7-所有节点安装k8s所需组件" class="router-link-active router-link-exact-active toc-link level2">7.7.所有节点安装k8s所需组件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-8-所有节点启动kubelet和docker" class="router-link-active router-link-exact-active toc-link level2">7.8.所有节点启动kubelet和docker</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-9-所有关闭swap" class="router-link-active router-link-exact-active toc-link level2">7.9.所有关闭swap</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-10-用kubeadm-初始化集群" class="router-link-active router-link-exact-active toc-link level2">7.10.用kubeadm 初始化集群</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-11-其他节点连接到master节点" class="router-link-active router-link-exact-active toc-link level2">7.11.其他节点连接到Master节点</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-12-在master节点上查看集群" class="router-link-active router-link-exact-active toc-link level2">7.12.在master节点上查看集群</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-13-安装网络插件" class="router-link-active router-link-exact-active toc-link level2">7.13.安装网络插件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-14-在master上查看集群节点" class="router-link-active router-link-exact-active toc-link level2">7.14.在master上查看集群节点</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-15-启动故障解决" class="router-link-active router-link-exact-active toc-link level2">7.15.启动故障解决</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-16-基础命令" class="router-link-active router-link-exact-active toc-link level2">7.16.基础命令</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-17-部署第一个程序到k8s中" class="router-link-active router-link-exact-active toc-link level2">7.17.部署第一个程序到k8s中</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_7-18-可视化面板kuboard" class="router-link-active router-link-exact-active toc-link level2">7.18.可视化面板kuboard</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-二进制包搭建kubernetes" class="router-link-active router-link-exact-active toc-link level1">8.二进制包搭建Kubernetes</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-1章节大纲" class="router-link-active router-link-exact-active toc-link level2">8.1章节大纲</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-1-环境配置清单" class="router-link-active router-link-exact-active toc-link level2">8.1.环境配置清单</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-2-服务器规划和ip地址规划" class="router-link-active router-link-exact-active toc-link level2">8.2.服务器规划和IP地址规划</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-2-1服务器规划" class="router-link-active router-link-exact-active toc-link level3">8.2.1服务器规划</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-2-2-ip地址规划" class="router-link-active router-link-exact-active toc-link level3">8.2.2.IP地址规划</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-3-安装前准备工作" class="router-link-active router-link-exact-active toc-link level2">8.3.安装前准备工作</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-3-1操作系统初始设置" class="router-link-active router-link-exact-active toc-link level3">8.3.1操作系统初始设置</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-3-2下载所有用到的软件包" class="router-link-active router-link-exact-active toc-link level3">8.3.2下载所有用到的软件包</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-4-安装cfssl证书生成工具" class="router-link-active router-link-exact-active toc-link level2">8.4.安装cfssl证书生成工具</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-5-搭建etcd集群" class="router-link-active router-link-exact-active toc-link level2">8.5.搭建etcd集群</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-5-1生成ca证书和https证书" class="router-link-active router-link-exact-active toc-link level3">8.5.1生成CA证书和https证书</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-5-2-部署etcd集群" class="router-link-active router-link-exact-active toc-link level3">8.5.2.部署etcd集群</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-5-4-拷贝etcd所需证书" class="router-link-active router-link-exact-active toc-link level3">8.5.4.拷贝etcd所需证书</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-5-5-让systemd管理etcd" class="router-link-active router-link-exact-active toc-link level3">8.5.5.让systemd管理etcd</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-5-6-拷贝etcd安装文件到worker-node" class="router-link-active router-link-exact-active toc-link level3">8.5.6.拷贝etcd安装文件到Worker Node</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-5-7-启动三个etcd并设置开机自启" class="router-link-active router-link-exact-active toc-link level3">8.5.7.启动三个etcd并设置开机自启</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-6-安装配置docker" class="router-link-active router-link-exact-active toc-link level2">8.6.安装配置Docker</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-6-1在master1上安装docker" class="router-link-active router-link-exact-active toc-link level3">8.6.1在Master1上安装docker</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-6-2在所有worker-node上安装docker" class="router-link-active router-link-exact-active toc-link level3">8.6.2在所有Worker Node上安装docker</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-6-3启动三台机器上的docker" class="router-link-active router-link-exact-active toc-link level3">8.6.3启动三台机器上的docker</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-7-搭建kube-apiserver" class="router-link-active router-link-exact-active toc-link level2">8.7.搭建kube-apiserver</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-7-1-生成ca证书和https证书" class="router-link-active router-link-exact-active toc-link level3">8.7.1.生成CA证书和Https证书</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-7-2-在master-node1上部署kube-apiserver" class="router-link-active router-link-exact-active toc-link level3">8.7.2.在Master Node1上部署kube-apiserver</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-7-3-拷贝所需证书" class="router-link-active router-link-exact-active toc-link level3">8.7.3.拷贝所需证书</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-7-4-启用tls-bootstrapping" class="router-link-active router-link-exact-active toc-link level3">8.7.4.启用TLS bootstrapping</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-7-5-让systemd管理apiserver" class="router-link-active router-link-exact-active toc-link level3">8.7.5.让systemd管理apiserver</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-7-6-启动kube-apiserver" class="router-link-active router-link-exact-active toc-link level3">8.7.6.启动kube-apiserver</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-8-在master-node1上部署kube-controller-manager" class="router-link-active router-link-exact-active toc-link level2">8.8.在Master Node1上部署kube-controller-manager</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-8-1-切换目录并拷贝kube-controller-manager相关文件到-opt-kubernetes-bin" class="router-link-active router-link-exact-active toc-link level3">8.8.1.切换目录并拷贝kube-controller-manager相关文件到/opt/kubernetes/bin</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-8-2-生成证书" class="router-link-active router-link-exact-active toc-link level3">8.8.2.生成证书</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-8-2-创建kube-controller-manager配置文件" class="router-link-active router-link-exact-active toc-link level3">8.8.2.创建kube-controller-manager配置文件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-8-3-生成配置文件" class="router-link-active router-link-exact-active toc-link level3">8.8.3.生成配置文件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-8-4-让systemd管理controller-manager" class="router-link-active router-link-exact-active toc-link level3">8.8.4.让systemd管理controller-manager</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-8-5-启动kube-controller-manager" class="router-link-active router-link-exact-active toc-link level3">8.8.5.启动kube-controller-manager</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-9-部署kube-scheduler" class="router-link-active router-link-exact-active toc-link level2">8.9.部署kube-scheduler</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-8-1-切换目录并拷贝kube-dcheduler相关文件到-opt-kubernetes-bin" class="router-link-active router-link-exact-active toc-link level3">8.8.1 切换目录并拷贝kube-dcheduler相关文件到/opt/kubernetes/bin</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-9-2-生成证书" class="router-link-active router-link-exact-active toc-link level3">8.9.2.生成证书</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-9-3-创建kube-scheduler-conf配置文件" class="router-link-active router-link-exact-active toc-link level3">8.9.3.创建kube-scheduler.conf配置文件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-9-4-生成kube-scheduler-kubeconfig文件" class="router-link-active router-link-exact-active toc-link level3">8.9.4.生成kube-scheduler.kubeconfig文件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-9-5-让systemd管理kube-scheduler" class="router-link-active router-link-exact-active toc-link level3">8.9.5.让systemd管理kube-scheduler</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-9-6-启动并设置开机启动" class="router-link-active router-link-exact-active toc-link level3">8.9.6.启动并设置开机启动</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-10-使用kubectl查看集群状态" class="router-link-active router-link-exact-active toc-link level2">8.10.使用kubectl查看集群状态</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-10-1-生成所需证书" class="router-link-active router-link-exact-active toc-link level3">8.10.1.生成所需证书</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-10-2-在-kube文件夹中生成config文件" class="router-link-active router-link-exact-active toc-link level3">8.10.2.在.kube文件夹中生成config文件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-10-3-通过kubectl工具查看集群组件" class="router-link-active router-link-exact-active toc-link level3">8.10.3.通过kubectl工具查看集群组件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-10-4-授权kubelet-bootstrap用户允许请求证书" class="router-link-active router-link-exact-active toc-link level3">8.10.4.授权kubelet-bootstrap用户允许请求证书</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-在master-node1上部署第一个worker-node" class="router-link-active router-link-exact-active toc-link level2">8.11.在Master Node1上部署第一个Worker Node</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-2-在master-node1部署kubelet" class="router-link-active router-link-exact-active toc-link level3">8.11.2.在Master Node1部署kubelet</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-2-1-创建kubelet配置文件" class="router-link-active router-link-exact-active toc-link level4">8.11.2.1.创建kubelet配置文件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-2-2-创建kubelet编排文件" class="router-link-active router-link-exact-active toc-link level4">8.11.2.2.创建kubelet编排文件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-2-3-生成kubelet初次加入集群引导kubeconfig文件" class="router-link-active router-link-exact-active toc-link level4">8.11.2.3.生成kubelet初次加入集群引导kubeconfig文件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-2-4-systemd管理kubelet" class="router-link-active router-link-exact-active toc-link level4">8.11.2.4.systemd管理kubelet</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-3-5-启动kubelet并设置开机启动" class="router-link-active router-link-exact-active toc-link level4">8.11.3.5.启动kubelet并设置开机启动</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-2-6-允许kubelet证书申请并加入集群" class="router-link-active router-link-exact-active toc-link level4">8.11.2.6.允许kubelet证书申请并加入集群</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-3-部署kube-proxy" class="router-link-active router-link-exact-active toc-link level3">8.11.3.部署kube-proxy</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-3-1-创建kube-proxy配置文件" class="router-link-active router-link-exact-active toc-link level4">8.11.3.1.创建kube-proxy配置文件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-3-2-配置参数文件" class="router-link-active router-link-exact-active toc-link level4">8.11.3.2.配置参数文件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-3-3-生成kube-proxy证书文件" class="router-link-active router-link-exact-active toc-link level4">8.11.3.3.生成kube-proxy证书文件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-3-4-生成kube-proxy-kubeconfig文件" class="router-link-active router-link-exact-active toc-link level4">8.11.3.4.生成kube-proxy.kubeconfig文件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-3-5-systemd管理kube-proxy" class="router-link-active router-link-exact-active toc-link level4">8.11.3.5.systemd管理kube-proxy</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-10-3-6-启动kube-proxy并设置开机自启" class="router-link-active router-link-exact-active toc-link level4">8.10.3.6.启动kube-proxy并设置开机自启</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-4-部署网络组件-calico" class="router-link-active router-link-exact-active toc-link level3">8.11.4.部署网络组件(Calico)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-11-5-授权apiserver访问kubelet" class="router-link-active router-link-exact-active toc-link level3">8.11.5.授权apiserver访问kubelet</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-增加worker-node" class="router-link-active router-link-exact-active toc-link level2">8.12.增加Worker Node</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-1-在所有worker-node创建工作目录并拷贝二进制文件" class="router-link-active router-link-exact-active toc-link level3">8.12.1.在所有Worker Node创建工作目录并拷贝二进制文件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-2拷贝master-node1上部署好的文件到worker-node" class="router-link-active router-link-exact-active toc-link level3">8.12.2拷贝Master Node1上部署好的文件到Worker Node</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-3-删除所有worker-node中kubelet证书和kubeconfig文件" class="router-link-active router-link-exact-active toc-link level3">8.12.3.删除所有Worker Node中kubelet证书和kubeconfig文件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-4-修改worker-node1和worker-node2主机名" class="router-link-active router-link-exact-active toc-link level3">8.12.4. 修改Worker Node1和Worker Node2主机名</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-5-启动worker-node1和worker-node2中kubelet并设置开机自启" class="router-link-active router-link-exact-active toc-link level3">8.12.5.启动Worker Node1和Worker Node2中kubelet并设置开机自启</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-6-在master1上同意新的node-kubelet证书申请" class="router-link-active router-link-exact-active toc-link level3">8.12.6.在Master1上同意新的Node kubelet证书申请</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-7-在master1上部署kubernetes-dashboard" class="router-link-active router-link-exact-active toc-link level3">8.12.7.在Master1上部署kubernetes-dashboard</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-12-8-在master1上部署coredns" class="router-link-active router-link-exact-active toc-link level3">8.12.8.在Master1上部署CoreDNS</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-13-增加master2节点" class="router-link-active router-link-exact-active toc-link level2">8.13.增加Master2节点</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-13-1-kubernetes集群架构简介" class="router-link-active router-link-exact-active toc-link level3">8.13.1.Kubernetes集群架构简介</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-13-2-给master-node2安装docker" class="router-link-active router-link-exact-active toc-link level3">8.13.2.给Master Node2安装Docker</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-13-5-给master-node2节点拷贝所有需要的证书" class="router-link-active router-link-exact-active toc-link level3">8.13.5.给Master Node2节点拷贝所有需要的证书</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-13-6-启动master所有服务并设置开机自启" class="router-link-active router-link-exact-active toc-link level3">8.13.6.启动Master所有服务并设置开机自启</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-13-7-在master查看集群组件状态" class="router-link-active router-link-exact-active toc-link level3">8.13.7.在Master查看集群组件状态</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-13-8-审批所有worker-node上的kubelet证书申请" class="router-link-active router-link-exact-active toc-link level3">8.13.8.审批所有Worker  Node上的kubelet证书申请</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-部署nginx-keepalived高可用负载均衡器" class="router-link-active router-link-exact-active toc-link level2">8.14.部署Nginx+Keepalived高可用负载均衡器</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-1-nginx和keepalived简介" class="router-link-active router-link-exact-active toc-link level3">8.14.1.Nginx和Keepalived简介</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-2-在两台master-node上安装软件" class="router-link-active router-link-exact-active toc-link level3">8.14.2.在两台Master Node上安装软件</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-3-nginx增加steam模块" class="router-link-active router-link-exact-active toc-link level3">8.14.3.Nginx增加Steam模块</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-3-1-查看nginx版本模块" class="router-link-active router-link-exact-active toc-link level4">8.14.3.1.查看Nginx版本模块</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-3-2-master1和master2安装stream模块" class="router-link-active router-link-exact-active toc-link level4">8.14.3.2.Master1和Master2安装Stream模块</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-4-启动nginx、keepalived并设置开机自启-master1-master2" class="router-link-active router-link-exact-active toc-link level3">8.14.4.启动nginx、keepalived并设置开机自启(master1/master2)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-5-查看keepalived工作状态" class="router-link-active router-link-exact-active toc-link level3">8.14.5.查看keepalived工作状态</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-6-nginx-keepalived高可用测试" class="router-link-active router-link-exact-active toc-link level3">8.14.6.Nginx+keepalived高可用测试</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-7-测试负载均衡器" class="router-link-active router-link-exact-active toc-link level3">8.14.7.测试负载均衡器</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-14-8-修改所有的worker-node连接lb-vip" class="router-link-active router-link-exact-active toc-link level3">8.14.8.修改所有的Worker Node连接LB VIP</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-15-部署常见问题" class="router-link-active router-link-exact-active toc-link level2">8.15.部署常见问题</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-15-1系统断电后-某个etcd节点无法启动" class="router-link-active router-link-exact-active toc-link level3">8.15.1系统断电后,某个etcd节点无法启动</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-15-2-the-connection-to-the-server-localhost-8080-was-refused-did-you-specify-the-right-host-or-port" class="router-link-active router-link-exact-active toc-link level3">8.15.2 The connection to the server localhost:8080 was refused - did you specify the right host or port?</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/blogs/environment/centos/centos7.html#_8-16-部署测试程序" class="router-link-active router-link-exact-active toc-link level2">8.16.部署测试程序</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//@include(./Account.java)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h1 id="博客介绍" tabindex="-1"><a class="header-anchor" href="#博客介绍" aria-hidden="true">#</a> 博客介绍</h1><h2 id="博客内容概述" tabindex="-1"><a class="header-anchor" href="#博客内容概述" aria-hidden="true">#</a> 博客内容概述</h2><pre><code>本篇博客的内容主要介绍安装Centos7操作系统、以及在Centos操作系统上搭建常见的开发环境，如Jdk、Maven、Docker、
Rancher、Minikube、Kubernetes、nginx、等软件的详细搭建过程，博客内容中图片较少，主要以实用为主，所有代码均
经过严格测试，可直接复制运行即可。
</code></pre><h2 id="博客大纲" tabindex="-1"><a class="header-anchor" href="#博客大纲" aria-hidden="true">#</a> 博客大纲</h2><h3 id="简单版博客内容大纲" tabindex="-1"><a class="header-anchor" href="#简单版博客内容大纲" aria-hidden="true">#</a> 简单版博客内容大纲</h3><div><iframe src="/markmap/environment/centos/centos7-outline2.html" width="100%" height="400" frameborder="0" scrolling="No" leftmargin="0" topmargin="0"></iframe></div><h3 id="详细版博客内容大纲" tabindex="-1"><a class="header-anchor" href="#详细版博客内容大纲" aria-hidden="true">#</a> 详细版博客内容大纲</h3><div><iframe src="/markmap/environment/centos/centos7-outline3.html" width="100%" height="400" frameborder="0" scrolling="No" leftmargin="0" topmargin="0"></iframe></div><h1 id="_1-安装linux操作系统" tabindex="-1"><a class="header-anchor" href="#_1-安装linux操作系统" aria-hidden="true">#</a> 1.安装Linux操作系统</h1><h2 id="_1-1章节大纲" tabindex="-1"><a class="header-anchor" href="#_1-1章节大纲" aria-hidden="true">#</a> 1.1章节大纲</h2><div><iframe src="/markmap/environment/centos/chapter/centos7-outline5-chapter1.html" width="100%" height="400" frameborder="0" scrolling="No" leftmargin="0" topmargin="0"></iframe></div><h2 id="_1-1-linux重要目录介绍" tabindex="-1"><a class="header-anchor" href="#_1-1-linux重要目录介绍" aria-hidden="true">#</a> 1.1.Linux重要目录介绍</h2><pre><code>/usr → C:/Windows/ /*系统级的目录
/usr/lib → C:/Windows/System32
/usr/local → C:/Progrem Files/ /*用户级的程序目录，用户自己编译的软件默认会安装到这个目录下
/opt → D:/Software /*额外安装的可选应用程序包所放置的位置。一般情况下，我们可以把tomcat等都安装到这里。
/usr/src /*系统级的源码目录，linux内核的源代码就放在/usr/src/linux里。
/home 存放所有用户文件的根目录，是用户主目录的基点，比如用户user的主目录就是/home/user，可以用~user表示
/root 超级用户（系统管理员）的主目录（特权阶级^o^）
/mnt 系统管理员安装临时文件系统的安装点，系统提供这个目录是让用户临时挂载其他的文件系统。
/boot 存放用于系统引导时使用的各种文件
/tmp 用于存放各种临时文件，是公用的临时文件存储点。
/var 存放临时文件，如各种服务的日志文件。
</code></pre><h2 id="_1-2-centos镜像下载" tabindex="-1"><a class="header-anchor" href="#_1-2-centos镜像下载" aria-hidden="true">#</a> 1.2.Centos镜像下载</h2><pre><code>如何是学习环境，建议安装centos mini版镜像，生产环境可以安装完整版
下载地址
</code></pre><h2 id="_1-3-安装前vmaware相关设置" tabindex="-1"><a class="header-anchor" href="#_1-3-安装前vmaware相关设置" aria-hidden="true">#</a> 1.3.安装前Vmaware相关设置</h2><p><strong>虚拟机联网设置</strong></p><pre><code>导航栏-&gt;编辑-&gt;虚拟网络编辑器-&gt;VMnet8NAT模式-&gt;更改设置-&gt;VMnet8NAT模式
	-&gt;更改底部子网:192.168.0.0，子网掩码:255.255.255.0-&gt;NAT设置-&gt;网关IP:192.168.0.2	
</code></pre><p><strong>Vmware网卡说明</strong></p><pre><code>VMnet0：用于虚拟桥接网络下的虚拟交换机
VMnet1：用于虚拟Host-Only网络下的虚拟交换机
VMnet8：用于虚拟NAT网络下的虚拟交换机
VMware NetworkAdepter VMnet1：Host用于与Host-Only虚拟网络进行通信的虚拟网卡
VMware NetworkAdepter VMnet8：Host用于与NAT虚拟网络进行通信的虚拟网卡
</code></pre><h2 id="_1-3-安装时分区大小设置" tabindex="-1"><a class="header-anchor" href="#_1-3-安装时分区大小设置" aria-hidden="true">#</a> 1.3.安装时分区大小设置</h2><pre><code>/boot	/*存放系统启动引导文件，建议大小：512mb
/swap 	/*交换区，建议大小：2g
/*主分区，剩下的空间全部分给这个分区
</code></pre><h1 id="_2-linux操作系统初始设置" tabindex="-1"><a class="header-anchor" href="#_2-linux操作系统初始设置" aria-hidden="true">#</a> 2.Linux操作系统初始设置</h1><h2 id="_2-1章节大纲" tabindex="-1"><a class="header-anchor" href="#_2-1章节大纲" aria-hidden="true">#</a> 2.1章节大纲</h2><div><iframe src="/markmap/environment/centos/chapter/centos7-outline5-chapter2.html" width="100%" height="400" frameborder="0" scrolling="No" leftmargin="0" topmargin="0"></iframe></div><h2 id="_2-1-配置静态ip地址" tabindex="-1"><a class="header-anchor" href="#_2-1-配置静态ip地址" aria-hidden="true">#</a> 2.1.配置静态IP地址</h2><p><strong>修改网络配置</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">vi</span> /etc/sysconfig/network-scripts/ifcfg-ens32<span class="token punctuation">(</span>最后一个为网卡名称<span class="token punctuation">)</span>	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>修改后内容如下
bootproto=static
onboot=yes
#在最后加上几行，IP地址、子网掩码、网关、dns服务器，注意：和网关IP处于同一个网段
IPADDR=192.168.0.4
NETMASK=255.255.255.0
#和上面网关IP保持 一致
GATEWAY=192.168.0.2
DNS1=8.8.8.8
DNS2=8.8.4.4
</code></pre><p><strong>重启网络</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl restart network
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_2-2-解决远程连接无法连接的问题" tabindex="-1"><a class="header-anchor" href="#_2-2-解决远程连接无法连接的问题" aria-hidden="true">#</a> 2.2.解决远程连接无法连接的问题</h2><p><strong>修改sshd配置文件</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>vim /etc/ssh/sshd_config
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>说明：sshd_config里面的UseDNS=no【原本为yes】
</code></pre><p><strong>重启ssh服务</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl restart sshd.service
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_2-3-设置系统环境变量" tabindex="-1"><a class="header-anchor" href="#_2-3-设置系统环境变量" aria-hidden="true">#</a> 2.3.设置系统环境变量</h2><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>echo &quot;export LC_ALL=en_US.UTF-8&quot;  &gt;&gt;  /etc/profile &amp;&amp;
source /etc/profile
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-4-安装curl" tabindex="-1"><a class="header-anchor" href="#_2-4-安装curl" aria-hidden="true">#</a> 2.4.安装curl</h2><pre><code>后面的操作需要curl，所以首先安装curl
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum -y install curl
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_2-5-配置yml源" tabindex="-1"><a class="header-anchor" href="#_2-5-配置yml源" aria-hidden="true">#</a> 2.5.配置yml源</h2><pre><code>下载阿里源，并上传到/opt/software/package
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>curl http://mirrors.aliyun.com/repo/Centos-7.repo -o Centos-7.repo
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>进入/etc/yum.repos.d目录中，备份CentOS-Base.repo
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd /etc/yum.repos.d &amp;&amp; cp CentOS-Base.repo CentOS-Base.repo.bak
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>复制/opt/software/package/Centos-7.repo到当前目录并重命名为CentOS-Base.repo
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cp /opt/software/package/Centos-7.repo /CentOS-Base.repo
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>生成yum源缓存并更新yum源
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum makecache &amp;&amp; yum update
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_2-6-安装常用基础系统软件" tabindex="-1"><a class="header-anchor" href="#_2-6-安装常用基础系统软件" aria-hidden="true">#</a> 2.6.安装常用基础系统软件</h2><h3 id="_2-6-1-手动安装常用软件" tabindex="-1"><a class="header-anchor" href="#_2-6-1-手动安装常用软件" aria-hidden="true">#</a> 2.6.1.手动安装常用软件</h3><p><strong>vim</strong></p><pre><code>安装vim	
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum -y install vim*
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>配置vim	
set nu         # 设置显示行号
set showmode   #设置在命令行界面最下面显示当前模式等
set ruler      #在右下角显示光标所在的行数等信息
set autoindent #设置每次单击Enter键后，光标移动到下一行时与上一行的起始字符对齐
syntax on      #即设置语法检测，当编辑C或者Shell脚本时，关键字会用特殊颜色显示		
</code></pre><p><strong>wget</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum -y install wget
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>telnet</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum -y install telnet
yum -y install telnet-server
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>git</strong></p><pre><code>卸载旧版本	
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum remove git
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>安装 yum 源的 Git 版本
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum install -y git
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看版本
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>git version 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_2-6-2-使用脚本安装常用软件" tabindex="-1"><a class="header-anchor" href="#_2-6-2-使用脚本安装常用软件" aria-hidden="true">#</a> 2.6.2.使用脚本安装常用软件</h3><pre><code>脚本介绍
这个脚本中包含了centos设置yum源并且安装了一些的常用软件，如vim、git、wget、curl、等，会定时更新

安装curl
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum -y install curl
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>下载脚本并
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>curl https://gitee.com/lingwh1995/config-center/raw/master/centos/centos-init.sh -o centos-init.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>赋予可运行权限并运行该脚本
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>chmod +x centos-init.sh &amp;&amp;
./centos-init.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_3-搭建基础开发环境" tabindex="-1"><a class="header-anchor" href="#_3-搭建基础开发环境" aria-hidden="true">#</a> 3.搭建基础开发环境</h1><h2 id="_3-1章节大纲" tabindex="-1"><a class="header-anchor" href="#_3-1章节大纲" aria-hidden="true">#</a> 3.1章节大纲</h2><div><iframe src="/markmap/environment/centos/chapter/centos7-outline5-chapter3.html" width="100%" height="400" frameborder="0" scrolling="No" leftmargin="0" topmargin="0"></iframe></div><h2 id="_3-1-安装jdk" tabindex="-1"><a class="header-anchor" href="#_3-1-安装jdk" aria-hidden="true">#</a> 3.1.安装jdk</h2><pre><code>查看当前安装的java版本
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum list installed | grep java
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>卸载旧版本jdk
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum -y remove xxx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>创建存放安装包的目录-&gt;切换到该目录-&gt;在该目录中下载jdk
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mkdir -p /opt/software/package &amp;&amp;
cd /opt/software/package &amp;&amp;
curl -fL -u software-1659088335906:c2e556a8a52386cbe0c6361ee3a7d8a21d3c9ca0 \
&quot;https://lingwh-generic.pkg.coding.net/coding-drive/software/jdk-8u181-linux-x64.tar.gz?\
version=latest&quot; -o jdk-8u181-linux-x64.tar.gz
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>解压jdk后赋予权限并放入指定目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>tar -zxvf jdk-8u181-linux-x64.tar.gz &amp;&amp;
chmod +x jdk1.8.0_181
mv jdk1.8.0_181 /usr/local/bin/jdk1.8.0_181
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>配置环境变量
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>vim /etc/profile
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>添加如下内容
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>export JAVA_HOME=/usr/local/bin/jdk1.8.0_181
export JRE_HOME=${JAVA_HOME}/jre
export CLASSPATH=.:${JAVA_HOME}/lib:${JRE_HOME}/lib
export PATH=${JAVA_HOME}/bin:$PATH
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>刷新环境变量文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>source /etc/profile	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看java版本
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>java -version
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_3-2-安装maven" tabindex="-1"><a class="header-anchor" href="#_3-2-安装maven" aria-hidden="true">#</a> 3.2.安装maven</h2><pre><code>注意
maven linux版和windows版并不通用

创建存放安装包的目录-&gt;并切换到该目录-&gt;在该目录中下载maven
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mkdir -p /opt/software/package &amp;&amp;
cd /opt/software/package &amp;&amp;
curl -fL -u software-1659088796431:ba211676fbe4a719c3b40b22083cd70388d41acc \
&quot;https://lingwh-generic.pkg.coding.net/coding-drive/software/apache-maven-3.8.6-bin.tar.gz\
?version=latest&quot; -o apache-maven-3.8.6-bin.tar.gz
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>解压到/usr/local/bin/目录下
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>tar -zxvf apache-maven-3.8.6-bin.tar.gz -C /usr/local/bin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>配置环境变量	
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>vim  /etc/profile
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>添加如下内容
注意事项
不要修改原来的path，直接在下面添加新的PATH配置，使用$PATH引用上面的PATH
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>export M2_HOME=/usr/local/bin/apache-maven-3.8.6
export PATH=$PATH:$M2_HOME/bin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>刷新配置文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>source /etc/profile
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看maven版本
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mvn -v
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>修改maven的settings.xml，仓库源&lt;mirrors&gt;&lt;/mirrors&gt;中添加如下信息:
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>vim /usr/local/bin/apache-maven-3.8.6/conf/settings.xml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>&lt;mirror&gt;
	&lt;id&gt;alimaven&lt;/id&gt;
	&lt;name&gt;aliyun maven&lt;/name&gt;
	&lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;
	&lt;mirrorOf&gt;central&lt;/mirrorOf&gt;
&lt;/mirror&gt;	
&lt;mirror&gt;
	&lt;id&gt;repo2&lt;/id&gt;
	&lt;name&gt;Mirror from Maven Repo2&lt;/name&gt;
	&lt;url&gt;http://repo2.maven.org/maven2/&lt;/url&gt;
	&lt;mirrorOf&gt;central&lt;/mirrorOf&gt;
&lt;/mirror&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-3-安装mysql" tabindex="-1"><a class="header-anchor" href="#_3-3-安装mysql" aria-hidden="true">#</a> 3.3.安装mysql</h2><pre><code>安装建议
使用mysql官方yum源在线安装(不要使用rpm方式安装，非常难以安装成功)

查看当前安装的mysql版本
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum list installed | grep mysql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>或
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rpm -qa | grep mysql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>卸载旧版本mysql
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum -y remove xxx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>Centos终端获取yum源安装包：
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd /opt/software/package &amp;&amp;
wget https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>安装mysql的yum源：（二选一）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rpm -Uvh mysql80-community-release-el7-3.noarch.rpm
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rpm -ivh mysql80-community-release-el7-3.noarch.rpm
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看刚才下载的mysql安装源，可以看到新增的两个mysql源
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ls /etc/yum.repos.d
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@localhost package]# ls /etc/yum.repos.d
CentOS-Base.repo      CentOS-Debuginfo.repo  CentOS-Vault.repo          mysql-community-source.repo
CentOS-Base.repo.bak  CentOS-Media.repo      CentOS-fasttrack.repo      mysql-community.repo
CentOS-CR.repo        CentOS-Sources.repo    CentOS-x86_64-kernel.repo

修改源中的配置，将所有的gpgkey的值修改为https://repo.mysql.com/RPM-GPG-KEY-mysql-2022
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sed -i &#39;s#file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql#https://repo.mysql.com/\
RPM-GPG-KEY-mysql-2022#g&#39; /etc/yum.repos.d/mysql-community.repo
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>使用yum在线安装mysql
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum -y install mysql-community-server
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>启动mysql-server
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl start mysqld.service &amp;&amp;
systemctl enable mysqld.service
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>查看mysql-server启动状态：
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl status mysqld
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>初始化mysql
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mysqld --initialize
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看mysql8登录密码
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat /var/log/mysqld.log | grep &#39;temporary password&#39;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>看到如下内容：
2022-07-18T18:31:57.277661Z 6 [Note] [MY-010454] [Server]
	A temporary password is generated for root@localhost: %)4(26e++jaK
</code></pre><p>登录mysql</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mysql -uroot -p&#39;%)4(26e++jaK&#39;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>修改mysql初始密码，规则大小写字母、数字、特殊符号，最少8位
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ALTER USER USER() IDENTIFIED BY &#39;Mysql123456_&#39;;
FLUSH PRIVILEGES;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>扩展或者添加远程用户权限:
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>use mysql;	
update user set host=&#39;%&#39; where user=&#39;root&#39;;
flush privileges;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_4-centos搭建docker" tabindex="-1"><a class="header-anchor" href="#_4-centos搭建docker" aria-hidden="true">#</a> 4.Centos搭建docker</h1><h2 id="_4-1章节大纲" tabindex="-1"><a class="header-anchor" href="#_4-1章节大纲" aria-hidden="true">#</a> 4.1章节大纲</h2><div><iframe src="/markmap/environment/centos/chapter/centos7-outline5-chapter4.html" width="100%" height="400" frameborder="0" scrolling="No" leftmargin="0" topmargin="0"></iframe></div><h2 id="_4-1-安装docker" tabindex="-1"><a class="header-anchor" href="#_4-1-安装docker" aria-hidden="true">#</a> 4.1.安装docker</h2><h3 id="_4-1-1-在线安装docker" tabindex="-1"><a class="header-anchor" href="#_4-1-1-在线安装docker" aria-hidden="true">#</a> 4.1.1.在线安装docker</h3><pre><code>以root身份更新yum，将yum包更新到最新
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum -y update
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看当前安装的docker版本
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum list installed | grep docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>containerd.io.x86_64 	 1.6.6-3.1.el7                  @docker-ce-stable				
docker-ce.x86_64                   3:20.10.17-3.el7               @docker-ce-stable
docker-ce-cli.x86_64               1:20.10.17-3.el7               @docker-ce-stable
docker-ce-rootless-extras.x86_64   20.10.17-3.el7                 @docker-ce-stable
docker-scan-plugin.x86_64          0.17.0-3.el7                   @docker-ce-stable
	
卸载旧版本docker
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum -y remove docker-ce.x86_64
yum -y remove docker-scan-plugin.x86_64
yum -y remove docker-ce-cli.x86_64
yum -y remove docker-ce-rootless-extras.x86_64_64
yum -y remove containerd.io.x86_64
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>安装需要的软件包
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum install -y yum-utils device-mapper-persistent-data lvm2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>配置使用阿里的yum源
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>查看阿里云仓库中所有docker版本，并选择特定版本安装</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum list docker-ce --showduplicates | sort -r
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>安装最新版本docker-ce(docker社区、ee企业版 ce为社区版)
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum -y install docker-ce
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看安装的docker版本
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker version
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>给docker配置国内镜像源
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>vim /etc/docker/daemon.json
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>添加如下内容
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sudo mkdir -p /etc/docker &amp;&amp;
sudo tee /etc/docker/daemon.json &lt;&lt;-&#39;EOF&#39;
{
    &quot;registry-mirrors&quot;: [
        &quot;https://5pfmrxk8.mirror.aliyuncs.com&quot;,
        &quot;http://hub-mirror.c.163.com&quot;,
        &quot;https://docker.mirrors.ustc.edu.cn&quot;,
        &quot;https://registry.docker-cn.com&quot;
    ]
}
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>daemon.json配置说明
registry-mirrors：docker国内镜像源地址

刷新daemon.json配置启动docker并设置为开机自启动
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl daemon-reload &amp;&amp;
systemctl start docker &amp;&amp;
systemctl enable docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>查看启动状态
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl status docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>启动故障排查
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl status docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>测试docker
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker run hello-world
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>安装成功则返回下面信息
[root@localhost ~]# docker run hello-world
Unable to find image &#39;hello-world:latest&#39; locally
latest: Pulling from library/hello-world
2db29710123e: Pull complete 
Digest: sha256:2498fce14358aa50ead0cc6c19990fc6ff866ce72aeb5546e1d59caac3d0d60f
Status: Downloaded newer image for hello-world:latest

Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
1. The Docker client contacted the Docker daemon.
2. The Docker daemon pulled the &quot;hello-world&quot; image from the Docker Hub.
	(amd64)
3. The Docker daemon created a new container from that image which runs the
	executable that produces the output you are currently reading.
4. The Docker daemon streamed that output to the Docker client, which sent it
	to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
$ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
https://hub.docker.com/

For more examples and ideas, visit:
https://docs.docker.com/get-started/
</code></pre><h3 id="_4-1-2-二进制包安装docker" tabindex="-1"><a class="header-anchor" href="#_4-1-2-二进制包安装docker" aria-hidden="true">#</a> 4.1.2.二进制包安装docker</h3><pre><code>创建存放docker安装包的目录-&gt;切换目录-&gt;在该目录中下载docker二进制安装包-&gt;解压到/usr/bin/
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mkdir -p  /opt/software/package/ &amp;&amp;
cd /opt/software/package/ &amp;&amp;
curl -fL -u software-1659095503164:3316a6a052e6f17880d37a00d38454342aceffdf \
&quot;https://lingwh-generic.pkg.coding.net/coding-drive/software/docker-20.10.9.tgz?version=latest&quot; \
-o docker-20.10.9.tgz &amp;&amp;
tar -xf docker-20.10.9.tgz &amp;&amp; mv docker/* /usr/bin/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>配置docker私有镜像	
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sudo mkdir -p /etc/docker &amp;&amp;
sudo tee /etc/docker/daemon.json &lt;&lt;-&#39;EOF&#39;
{
    &quot;registry-mirrors&quot;: [
        &quot;https://5pfmrxk8.mirror.aliyuncs.com&quot;,
        &quot;http://hub-mirror.c.163.com&quot;,
        &quot;https://docker.mirrors.ustc.edu.cn&quot;,
        &quot;https://registry.docker-cn.com&quot;
    ]
}
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>配置docker.service文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network-online.target firewalld.service
Wants=network-online.target
 
[Service]
Type=notify
ExecStart=/usr/bin/dockerd
ExecReload=/bin/kill -s HUP $MAINPID
LimitNOFILE=infinity
LimitNPROC=infinity
TimeoutStartSec=0
Delegate=yes
KillMode=process
Restart=on-failure
StartLimitBurst=3
StartLimitInterval=60s
 
[Install]
WantedBy=multi-user.target
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>刷新配置文件后启动三台机器上的docker并设置为开机启动
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl daemon-reload &amp;&amp;
systemctl start docker &amp;&amp;
systemctl enable docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>查看启动状态
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl status docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>启动故障排查
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl status docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>测试docker
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker run hello-world
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>安装成功则返回下面信息
[root@localhost ~]# docker run hello-world
Unable to find image &#39;hello-world:latest&#39; locally
latest: Pulling from library/hello-world
2db29710123e: Pull complete 
Digest: sha256:2498fce14358aa50ead0cc6c19990fc6ff866ce72aeb5546e1d59caac3d0d60f
Status: Downloaded newer image for hello-world:latest

Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
1. The Docker client contacted the Docker daemon.
2. The Docker daemon pulled the &quot;hello-world&quot; image from the Docker Hub.
	(amd64)
3. The Docker daemon created a new container from that image which runs the
	executable that produces the output you are currently reading.
4. The Docker daemon streamed that output to the Docker client, which sent it
	to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
$ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
https://hub.docker.com/

For more examples and ideas, visit:
https://docs.docker.com/get-started/
</code></pre><h2 id="_4-2-docker启动故障解决" tabindex="-1"><a class="header-anchor" href="#_4-2-docker启动故障解决" aria-hidden="true">#</a> 4.2.docker启动故障解决</h2><pre><code>错误信息
Job for docker.service failed because the control process exited with error code. 
See &quot;systemctl status docker.service&quot; and &quot;journalctl -xe&quot; for details.

解决方式1：使docker与firewall共存
关闭docker
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl stop docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>设置firewall不拦截docker
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>firewall-cmd --zone=trusted --remove-interface=docker0 --permanent
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>重新加载防火墙配置
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>firewall-cmd --reload
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>重新启动防火墙
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl restart firewalld
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>重新启动docker
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl restart docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>解决方式2：检查daemon.json配置是否正确
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	cat /etc/docker/daemon.json
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>看配置的registry-mirrors是否正确，如私服前是否忘记了加http://
</code></pre><h2 id="_4-3-docker容器可视化" tabindex="-1"><a class="header-anchor" href="#_4-3-docker容器可视化" aria-hidden="true">#</a> 4.3.docker容器可视化</h2><pre><code>查询当前有哪些portainer镜像
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker search portainer
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>下载portainer镜像
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker pull portainer/portainer:1.24.2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>启动单机版portainer(针对单机版docker)
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker run -d --name portainer \
	-p 9000:9000 \
	--restart=always \
	-v /var/run/docker.sock:/var/run/docker.sock \
	--privileged=true \
	portainer/portainer:1.24.2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>登录portainer
登录地址：http://192.168.0.4:9000/
用户名/密码：admin/portainer
单机版选择local即可
</code></pre><h2 id="_4-4-搭建docke私服" tabindex="-1"><a class="header-anchor" href="#_4-4-搭建docke私服" aria-hidden="true">#</a> 4.4.搭建docke私服</h2><h2 id="_4-4-1搭建docke官方私服-不带有用户名和密码校验" tabindex="-1"><a class="header-anchor" href="#_4-4-1搭建docke官方私服-不带有用户名和密码校验" aria-hidden="true">#</a> 4.4.1搭建docke官方私服（不带有用户名和密码校验）</h2><pre><code>拉取仓库镜像
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker pull registry
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>启动注册仓库服务器
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker run -d --name registry_official \
	-p 5000:5000 \
	--restart=always \
	-v /registry/public/repos:/var/lib/registry \
	--privileged=true \
	registry
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>配置私服地址和镜像源地址并且将私服地址加入到镜像源列表，这样就可以从私服中拉取镜像了

给docker配置私服
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	vim /etc/docker/daemon.json
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>添加如下内容
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>{
	&quot;insecure-registries&quot;:[&quot;192.168.0.4:5000&quot;,&quot;192.168.0.4:5001&quot;],
	&quot;registry-mirrors&quot;: [
			&quot;https://5pfmrxk8.mirror.aliyuncs.com&quot;,
			&quot;http://hub-mirror.c.163.com&quot;,
			&quot;https://docker.mirrors.ustc.edu.cn&quot;,
			&quot;https://registry.docker-cn.com&quot;,
			&quot;http://192.168.0.4:5000&quot;,
			&quot;http://192.168.0.4:5001&quot;
	]
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>或
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sudo mkdir -p /etc/docker &amp;&amp;
sudo tee /etc/docker/daemon.json &lt;&lt;-&#39;EOF&#39;
{
	&quot;insecure-registries&quot;:[&quot;192.168.0.4:5000&quot;,&quot;192.168.0.4:5001&quot;],
	&quot;registry-mirrors&quot;: [
			&quot;https://5pfmrxk8.mirror.aliyuncs.com&quot;,
			&quot;http://hub-mirror.c.163.com&quot;,
			&quot;https://docker.mirrors.ustc.edu.cn&quot;,
			&quot;https://registry.docker-cn.com&quot;,
			&quot;http://192.168.0.4:5000&quot;,
			&quot;http://192.168.0.4:5001&quot;
	]
}
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>daemon.json配置说明
insecure-registries：docker信任的私服地址
registry-mirrors：docker国内镜像源地址

daemon.json配置注意事项：把私服配置到registry-mirrors时，一定要正确的加上 http://前缀：	
正确格式: http://192.168.0.4:5000
错误格式: 192.168.0.4:5001

放行5000端口并保证5000端口确实被放开
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>firewall-cmd --permanent --add-port=5000/tcp &amp;&amp;
firewall-cmd --reload
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>刷新daemon并重启docker
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl daemon-reload &amp;&amp; 
systemctl restart docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>验证仓库是否搭建成功
访问:http://192.168.0.4:5000/v2/_catalog，看到{&quot;repositories&quot;:[]}表示私有仓库搭建成功且内容为空

彻底删除私服中的镜像:注意这个路径是要看registry具体挂载到linux上什么位置的
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rm -rf /registry/public/repos/docker/registry/v2/repositories/springcloud-eureka/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_4-4-2搭建docke官方私服-带有用户名和密码校验" tabindex="-1"><a class="header-anchor" href="#_4-4-2搭建docke官方私服-带有用户名和密码校验" aria-hidden="true">#</a> 4.4.2搭建docke官方私服（带有用户名和密码校验）</h2><pre><code>拉取仓库镜像
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker pull registry
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>加密认证配置
创建存放加密后用户信息的用户名密码
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mkdir -p /opt/docker/auth/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>安装httpd工具
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum -y install httpd
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>生成带有加密后用户信息的用户名密码
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>htpasswd -Bbn docker 123456  &gt;/opt/docker/auth/htpasswd
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>启动注册仓库服务器(-p:第一个5000是本地机器端口,第二个5000是docker容器中端口)
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker run -d --name registry_official_auth  \
	-p 5000:5000 --restart=always \
	-v `pwd`/opt/docker/auth:/opt/docker/auth  \
	-v /opt/docker/registry:/var/lib/registry  \
	-e &quot;REGISTRY_AUTH=htpasswd&quot;  \
	-e &quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot;  \
	-e REGISTRY_AUTH_HTPASSWD_PATH=/opt/docker/auth/htpasswd \
	registry:latest	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>给docker配置私服
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	vim /etc/docker/daemon.json
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>添加以下内容
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>{
	&quot;insecure-registries&quot;:[&quot;192.168.0.4:5000&quot;,&quot;192.168.0.4:5001&quot;],
	&quot;registry-mirrors&quot;: [
			&quot;https://5pfmrxk8.mirror.aliyuncs.com&quot;,
			&quot;http://hub-mirror.c.163.com&quot;,
			&quot;https://docker.mirrors.ustc.edu.cn&quot;,
			&quot;https://registry.docker-cn.com&quot;,
			&quot;http://192.168.0.4:5000&quot;,
			&quot;http://192.168.0.4:5001&quot;
	]
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>daemon.json配置说明
insecure-registries：docker信任的私服地址
registry-mirrors：docker国内镜像源地址

daemon.json配置注意事项：把私服配置到registry-mirrors时，一定要正确的加上 http://前缀：	
正确格式: http://192.168.0.4:5000
错误格式: 192.168.0.4:5001
放行5000端口并保证5000端口确实被放开
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>firewall-cmd --permanent --add-port=5000/tcp &amp;&amp;
firewall-cmd --reload
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>刷新docker daemon并重启docker
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl daemon-reload &amp;&amp; systemctl restart docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>验证仓库是否搭建成功
访问:http://192.168.0.4:5000/v2/_catalog，看到{&quot;repositories&quot;:[]}表示私有仓库搭建成功且内容为空

彻底删除私服中的镜像:注意这个路径是要看registry具体挂载到linux上什么位置的
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rm -rf /registry/public/repos/docker/registry/v2/repositories/springcloud-eureka/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_4-4-3-搭建harbor私服" tabindex="-1"><a class="header-anchor" href="#_4-4-3-搭建harbor私服" aria-hidden="true">#</a> 4.4.3.搭建harbor私服</h2><h3 id="_4-4-3-1-harbor简介" tabindex="-1"><a class="header-anchor" href="#_4-4-3-1-harbor简介" aria-hidden="true">#</a> 4.4.3.1.harbor简介</h3><pre><code>Harbor是一个用于存储和分发Docker镜像的企业级Registry服务器，虽然Docker官方也提供了公共的镜像仓库，但是
从安全和效率等方面考虑，部署企业内部的私有环境Registry是非常必要的，harbor和docker中央仓库的关系就类似于
nexus和Maven中央仓库的关系，harbor除了存储和分发镜像外还具有用户管理，项目管理，配置管理和日志查询，高可
用部署等主要功能。		
</code></pre><h3 id="_4-4-3-2-搭建docker-compose" tabindex="-1"><a class="header-anchor" href="#_4-4-3-2-搭建docker-compose" aria-hidden="true">#</a> 4.4.3.2.搭建docker-compose</h3><pre><code>版本说明
	2.6.1
	
下载docker-compose
在github下载docker-compose2.6.1

上传到服务器
上传到/opt/software/package

赋予运行权限并复制到/usr/local/bin/docker-compose
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd /opt/software/package &amp;&amp;
sudo chmod +x docker-compose-linux-x86_64 &amp;&amp;
cp docker-compose-linux-x86_64 /usr/local/bin/docker-compose
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>查看是否安装成功
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker-compose --version
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_4-4-3-3-安装harbor" tabindex="-1"><a class="header-anchor" href="#_4-4-3-3-安装harbor" aria-hidden="true">#</a> 4.4.3.3.安装harbor</h3><pre><code>特别注意
注意docker的版本,低版本的docker不能运行harbor2.5
	
版本说明
	2.5
	
在github下载harbor2.5.2，上传到/opt/software/package
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd /opt/software/package
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>解压到/opt/software/install
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>tar -zxvf harbor-offline-installer-v2.5.2.tgz -C /opt/software/install
cd /opt/software/install/harbor
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>复制一份harbor.yml.tmpl，重命名为harbor.yml并修改harbor.yml
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cp harbor.yml.tmpl harbor.yml &amp;&amp;
vim harbor.yml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>修改harbor.yml
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	具体修改以下内容
	修改hostname
	hostname: 192.168.0.4
	修改端口
	port:5001
	注释掉https相关部分
	#https:
		# https port for harbor, default is 443
		# port: 443
		# The path of cert and key files for nginx
		#certificate: /your/certificate/path
		#private_key: /your/private/key/path
	修改密码
		harbor_admin_password: 123456
	
	安装docker-compose
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>./install.sh</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	执行完成后，使用docker images查看harbor相关镜像
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>docker images</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	启动harbor
	一次性启动所有harbor相关的容器,一般执行完./install.sh就已经启动了相关的容器
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>docker-compose up -d</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	让docker信任harbor私服
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>vim /etc/docker/daemon.json,添加以下内容:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	配置Docker(Register)注册仓库服务器信任192.168.0.4:5001:
	{&quot;insecure-registries&quot;:[&quot;192.168.0.4:5001&quot;]}
	
	重新加载docker daemon配置文件并重启docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>systemctl daemon-reload &amp;&amp; systemctl restart docker</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	登录harbor首页(密码可以去harbor.yml中查看)
	访问地址：http://192.168.0.4:5001/
	用户名/密码：admin/123456
		
	在Harbor中创建项目,推送的时候可以用
	如:springcloud-eureka	

## 4.5.docker官方私服可视化
### 4.5.1docker-registry-web方案
	下载docker pull hyper/docker-registry-web镜像
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>docker pull hyper/docker-registry-web</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	启动docker-registry-web
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>docker run -d --restart=always <br> -p 9002:8080 <br> --name registry-web <br> --link registry_default <br> -e REGISTRY_URL=http://192.168.0.4:5000/v2 <br> -e REGISTRY_NAME=192.168.0.4:5000 <br> hyper/docker-registry-web:latest</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>
## 4.6.制作docker镜像并上传到私服

### 4.6.1.制作Dokcer镜像		
	进入/opt/software/package，并在这个目录中下载jdk
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>cd /opt/software/package &amp;&amp; wget https://repo.huaweicloud.com/java/jdk/8u181-b13/jdk-8u181-linux-x64.tar.gz</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	编写Dockerfile(Dockerfile内容如下)	
	
	#基于centos基础镜像构建
	FROM centos	
	#作者
	MAINTAINER lingwh
	#将jdk添加到基础镜像中
	ADD jdk-8u181-linux-x64.tar.gz /usr/local
	#设置java相关的环境变量
	ENV JAVA_HOME /usr/local/jdk1.8.0_181
	ENV JRE_HOME ${JAVA_HOME}/jre
	ENV CLASSPATH .:${JAVA_HOME}/lib:${JRE_HOME}/lib
	ENV PATH ${JAVA_HOME}/bin:$PATH
	#输出Java版本信息
	CMD [&quot;java&quot;,&quot;-version&quot;]		
					
	在当前目录中执行构建镜像的命令
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>docker build -t=&#39;jdk/jdk1.8.0_181&#39; .</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	查看到刚才制作好的镜像
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>docker images</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	创建容器
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>docker run -it --name=myjdk8 镜像id /bin/bash</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>
### 4.6.2.上传本地jdk镜像到私服
	给镜像打标签
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>docker tag jdk/jdk1.8.0_181 192.168.0.4:5000/jdk/jdk1.8.0_181:latest #更改镜像的TAG标签</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	上传标记的镜像
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>docker push 192.168.0.4:5000/jdk/jdk1.8.0_181:latest</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	查看推送到私服中的镜像
	访问:http://192.168.0.4:5000/v2/_catalog,看到:{&quot;repositories&quot;:[&quot;jdk/jdk1.8.0_181&quot;]}

## 4.7.Docker中安装常用软件
### 4.7.1.Docker安装mysql
	下载mysql镜像
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>docker pull mysql</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	启动mysql容器
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>docker run -di --name mysql -p 3306:3306 --restart=always -e MYSQL_ROOT_PASSWORD=123456 mysql</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	关闭docker中的mysql容器
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>myqldocker exec -it mysql bash</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>### 4.7.2.Docker中安装consul
	下载consul镜像
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>docker pull consul</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	启动consul容器
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>docker run -d --name=consul <br> -p 8500:8500 <br> --restart=always <br> agent -server -bootstrap -ui -node=1 -client=&#39;0.0.0.0&#39; <br> consul:latest</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>
### 4.7.3.Docker容器中安装vim	 
	进入容器内部
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>docker exec -it 容器id /bin/bash</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	备份旧的源
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>mv /etc/apt/sources.list /etc/apt/sources.list.bak</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	写入新的源
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>echo &quot;deb http://mirrors.163.com/debian/ jessie main non-free contrib&quot; <br> &gt;&gt; /etc/apt/sources.list &amp;&amp; echo &quot;deb http://mirrors.163.com/debian/ jessie-proposed-updates main non-free contrib&quot; <br> &gt;&gt;/etc/apt/sources.list &amp;&amp; echo &quot;deb-src http://mirrors.163.com/debian/ jessie main non-free contrib&quot; <br> &gt;&gt;/etc/apt/sources.list &amp;&amp; echo &quot;deb-src http://mirrors.163.com/debian/ jessie-proposed-updates main non-free contrib&quot; <br> &gt;&gt;/etc/apt/sources.list</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>
	更新源
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>apt update</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	安装vim
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>apt-get install vim</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>
### 4.7.3.docker安装elk
	下载elk镜像
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>docker pull sebp/elk:6.8.22</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	启动ELK容器，指定最小内存和最大内存，并映射相关端口
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>docker run -d --name elk <br> --restart always <br> -p 5601:5601 <br> -p 9200:9200 <br> -p 5044:5044 <br> -e ES_MIN_MEM=1024m <br> -e ES_MAX_MEM=2048 <br> sebp/elk:6.8.22</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	开放elk需要用的端口,并且重新载入端口
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>firewall-cmd --add-port=5601/tcp --permanent &amp;&amp; firewall-cmd --reload &amp;&amp; firewall-cmd --add-port=9200/tcp --permanent &amp;&amp; firewall-cmd --reload &amp;&amp; firewall-cmd --add-port=5044/tcp --permanent &amp;&amp; firewall-cmd --reload</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	访问Kibana
	192.168.0.4:5601
	
	进入ELK中进行配置
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>docker exec -it elk /bin/bash</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	修改logstash配置,把下面内容粘贴进去
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>vim /etc/logstash/conf.d/02-beats-input.conf</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code></code></pre><div class="line-numbers" aria-hidden="true"></div></div><p>input{ tcp{ host =&gt; &quot;0.0.0.0&quot; port =&gt; 5044 codec=&gt; json_lines } } output{ elasticsearch{ hosts =&gt; [&quot;192.168.0.4:9200&quot;] action =&gt; &quot;index&quot; index =&gt; &quot;%{[appName]}-%{+YYYY.MM.dd}&quot; } }</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	配置说明:
	input代表数据输入配置 ， logstatsh的开放端口是 5044
	output代表数据输出配置，输出到elasticsearch, hosts是es的地址192.168.0.4:9200
	
	退出容器
``	
exit
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>重启ELK容器
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker restart elk
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>注意事项	
当把docker和centos7的冲突解决后,需要让centos放行elk(具体是es)的部署地址

查看容器详细信息
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker inspect 容器id
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查找到elk(具体是es)容器的ip,假设为172.17.0.2

执行放行操作
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>firewall-cmd --zone=trusted --add-source=172.17.0.2/16 --permanent
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>重新载入防火墙配置
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>firewall-cmd --reload
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>重启防火墙
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl restart firewalld
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>docker启动elk报错/或一直重启故障解决
错误日志：
max virtual memory areas vm.max_map_count [65530] is too low, increase to at least
解决方式，在宿主机执行
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sudo sysctl -w vm.max_map_count=262144
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h1 id="_5-centos搭建rancher" tabindex="-1"><a class="header-anchor" href="#_5-centos搭建rancher" aria-hidden="true">#</a> 5.Centos搭建Rancher</h1><h2 id="_5-1章节大纲" tabindex="-1"><a class="header-anchor" href="#_5-1章节大纲" aria-hidden="true">#</a> 5.1章节大纲</h2><div><iframe src="/markmap/environment/centos/chapter/centos7-outline5-chapter5.html" width="100%" height="400" frameborder="0" scrolling="No" leftmargin="0" topmargin="0"></iframe></div><pre><code>下载rancher
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker pull rancher/server
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>启动rancher
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker run -di --name=rancher -p9003:8080 rancher/server:latest
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>使用rancher扩容/缩容注意事项
如果要使用扩容或者缩容功能,不要配置eureka的如下信息
eureka:
  instance:
	#使用rancher扩容不能配置instance-id,否则会出问题
	#instance-id: ${spring.application.name} 
	#使用rancher扩容不能配置iip-address,否则会出问题
	#ip-address: 192.168.0.4				
</code></pre><h1 id="_6-centos搭建minikube" tabindex="-1"><a class="header-anchor" href="#_6-centos搭建minikube" aria-hidden="true">#</a> 6.Centos搭建Minikube</h1><h2 id="_6-1章节大纲" tabindex="-1"><a class="header-anchor" href="#_6-1章节大纲" aria-hidden="true">#</a> 6.1章节大纲</h2><div><iframe src="/markmap/environment/centos/chapter/centos7-outline5-chapter6.html" width="100%" height="400" frameborder="0" scrolling="No" leftmargin="0" topmargin="0"></iframe></div><h2 id="_6-1-minikube介绍" tabindex="-1"><a class="header-anchor" href="#_6-1-minikube介绍" aria-hidden="true">#</a> 6.1.minikube介绍</h2><pre><code>Minikube这个工具支持在虚拟机上运行一套单节点的k8s集群
</code></pre><h2 id="_6-2-版本说明" tabindex="-1"><a class="header-anchor" href="#_6-2-版本说明" aria-hidden="true">#</a> 6.2.版本说明</h2><pre><code>minikube:1.2.6 kubectl client:1.18.0
</code></pre><h2 id="_6-3-开启vmware虚拟化" tabindex="-1"><a class="header-anchor" href="#_6-3-开启vmware虚拟化" aria-hidden="true">#</a> 6.3.开启Vmware虚拟化</h2><pre><code>查看是否支持虚拟化，开始安装前，先查看本地机器是否支持虚拟化，有输出就支持
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>grep -E --color &#39;vmx|svm&#39; /proc/cpuinfo
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>开启虚拟化
Vmware Workstation -&gt;Centos 64右键菜单 —&gt; 设置 
	-&gt; 处理器 -&gt;勾选 虚拟化IntelVT-x/EPT 或 ADM-V/RVI(V)

设置处理器数量设置为大于等于2,内存大于等于2G
</code></pre><h2 id="_6-4-安装kubectl" tabindex="-1"><a class="header-anchor" href="#_6-4-安装kubectl" aria-hidden="true">#</a> 6.4.安装kubectl</h2><pre><code>简介
kubectl 是一个用来跟 K8S 集群进行交互的命令行工具
	
下载kubectl，上传到/opt/software/package，赋予可运行权限,并放入/usr/local/bin/目录下
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>chmod +x ./kubectl &amp;&amp; cp ./kubectl /usr/local/bin/kubectl
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看kubectl版本
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl version --client
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_6-5-安装minikube" tabindex="-1"><a class="header-anchor" href="#_6-5-安装minikube" aria-hidden="true">#</a> 6.5.安装minikube</h2><pre><code>下载minikube
到 https://github.com/kubernetes/minikube/releases 找到minikube-linux-amd64并下载

上传到/opt/software/package

赋予运行权限并复制到/usr/local/bin/minikube
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>chmod +x ./minikube-linux-amd64 &amp;&amp; cp ./minikube-linux-amd64 /usr/local/bin/minikube
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_6-6-使用阿里云加速docker-hub" tabindex="-1"><a class="header-anchor" href="#_6-6-使用阿里云加速docker-hub" aria-hidden="true">#</a> 6.6.使用阿里云加速docker hub</h2><pre><code>登录阿里云docker相关页面
访问：https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors
登陆-&gt;左侧菜单选中镜像加速器-&gt;查看加速镜像地址 https://ngviu28h.mirror.aliyuncs.com
</code></pre><h2 id="_6-7-启动minikube" tabindex="-1"><a class="header-anchor" href="#_6-7-启动minikube" aria-hidden="true">#</a> 6.7.启动minikube</h2><pre><code>注意事项
启动minikube之前需要先启动docker，如无法启动加上--kubernetes-version=v具体版本号

使用docker作为虚拟化引擎(需要先安装Docker)
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>minikube start --driver=docker --force \
	--image-mirror-country=&#39;cn&#39; \
	--image-repository=&#39;registry.cn-hangzhou.aliyuncs.com/google_containers&#39; \
	--registry-mirror=&#39;https://ngviu28h.mirror.aliyuncs.com&#39; \
	--kubernetes-version=v1.23.8
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>使用virtualbox作为虚拟化引擎(需要先安装Virtualbox)

下载Centos7版VirtualBox
访问：https://www.virtualbox.org/wiki/Downloads，选择AMD64版本下载
上传到/opt/software/package中
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>VirtualBox-6.1-6.1.34_150636_el7-2.x86_64.rpm
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>安装问题解决(virtualbox内核无法编译)
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sudo yum install gcc kernel kernel-devel -y
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>重启机器
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl reboot
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>安装VirtualBox
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum install VirtualBox-6.1-6.1.34_150636_el7-2.x86_64.rpm -y
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>补充内容：Centos版VirtualBox操作命令						
VBoxManage list runningvms //查看机器列表
VBoxHeadless -startvm &quot;虚拟机名&quot; //启动虚拟机
测试VirtualBox是否安装成功
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>virtualbox
rcvboxdrv setup
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>使用virtualbox作为虚拟化引擎
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>minikube start --driver=virtualbox --force \
	--image-mirror-country=&#39;cn&#39; \
	--image-repository=&#39;registry.cn-hangzhou.aliyuncs.com/google_containers&#39; \
	--registry-mirror=&#39;https://ngviu28h.mirror.aliyuncs.com&#39; \
	--kubernetes-version=v1.23.8
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-8-minikube常用命令" tabindex="-1"><a class="header-anchor" href="#_6-8-minikube常用命令" aria-hidden="true">#</a> 6.8.minikube常用命令</h2><pre><code>查看minikube日志
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>minikube logs
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看minikube状态
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>minikube status								
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看节点				
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>minikube kubectl -- get po -A
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>停止集群
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>minikube stop
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>清空集群
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>minikube delete --all
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>安装集群可视化 Web UI 控制台
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>minikube dashboard
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>卸载minikube
停止运行
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>minikube stop
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>执行卸载命令
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>minikube delete
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>删除 ~/.minikube 目录缓存的文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rm -rf ~/.minikube	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h1 id="_7-kubeadm搭建kubernetes" tabindex="-1"><a class="header-anchor" href="#_7-kubeadm搭建kubernetes" aria-hidden="true">#</a> 7.kubeadm搭建Kubernetes</h1><h2 id="_7-1章节大纲" tabindex="-1"><a class="header-anchor" href="#_7-1章节大纲" aria-hidden="true">#</a> 7.1章节大纲</h2><div><iframe src="/markmap/environment/centos/chapter/centos7-outline5-chapter7.html" width="100%" height="400" frameborder="0" scrolling="No" leftmargin="0" topmargin="0"></iframe></div><h2 id="_7-1-特别说明" tabindex="-1"><a class="header-anchor" href="#_7-1-特别说明" aria-hidden="true">#</a> 7.1.特别说明</h2><pre><code>使用kubeadm搭建Kubernetes
</code></pre><h2 id="_7-2-所有节点设置对应主机名" tabindex="-1"><a class="header-anchor" href="#_7-2-所有节点设置对应主机名" aria-hidden="true">#</a> 7.2.所有节点设置对应主机名</h2><pre><code>master节点
hostnamectl set-hostname master
slave1节点
hostnamectl set-hostname slave1
slave2节点	
hostnamectl set-hostname slave2
</code></pre><h2 id="_7-3-所有节点修改hosts" tabindex="-1"><a class="header-anchor" href="#_7-3-所有节点修改hosts" aria-hidden="true">#</a> 7.3.所有节点修改hosts</h2><pre><code>vim /etc/hosts
192.168.0.6 master
192.168.0.7 slave1
192.168.0.8 slave2
</code></pre><h2 id="_7-4-所有节点关闭selinux" tabindex="-1"><a class="header-anchor" href="#_7-4-所有节点关闭selinux" aria-hidden="true">#</a> 7.4.所有节点关闭SELinux</h2><pre><code>暂时关闭
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>setenforce 0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>永久关闭
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sed -i --follow-symlinks &#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39; \
/etc/sysconfig/selinux
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-5-所有节点关闭防火墙" tabindex="-1"><a class="header-anchor" href="#_7-5-所有节点关闭防火墙" aria-hidden="true">#</a> 7.5.所有节点关闭防火墙</h2><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl stop firewalld &amp;&amp;
systemctl disable firewalld
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-6-所有节点安装docker" tabindex="-1"><a class="header-anchor" href="#_7-6-所有节点安装docker" aria-hidden="true">#</a> 7.6.所有节点安装docker</h2><pre><code>安装docker
详细参考4.1&gt;.安装docker

修改docker配置
vim /etc/docker/daemon.json，并添加如下内容：
#kubernetes官方推荐 docker等使用systemd作为cgroupdriver，否则 kubelet 启动不了
&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]&quot;

重新载入docker配置并重启docker
systemctl daemon-reload &amp;&amp; systemctl restart docker
</code></pre><h2 id="_7-7-所有节点安装k8s所需组件" tabindex="-1"><a class="header-anchor" href="#_7-7-所有节点安装k8s所需组件" aria-hidden="true">#</a> 7.7.所有节点安装k8s所需组件</h2><pre><code>添加k8s安装源
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &lt;&lt;EOF &gt; kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg 
https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>使用k8s安装源
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mv kubernetes.repo /etc/yum.repos.d/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>安装所需组件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum install -y kubelet-1.22.4 kubectl-1.22.4 kubeadm-1.22.4
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看各组件版本
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubelet --version
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl	--version
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubeadm --version
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_7-8-所有节点启动kubelet和docker" tabindex="-1"><a class="header-anchor" href="#_7-8-所有节点启动kubelet和docker" aria-hidden="true">#</a> 7.8.所有节点启动kubelet和docker</h2><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl enable kubelet &amp;&amp; 
systemctl start kubelet &amp;&amp;
systemctl enable docker &amp;&amp;
systemctl start docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-9-所有关闭swap" tabindex="-1"><a class="header-anchor" href="#_7-9-所有关闭swap" aria-hidden="true">#</a> 7.9.所有关闭swap</h2><pre><code>临时关闭swap分区
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>swapoff /mnt/swap
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>永久关闭swap分区
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sed -ri &#39;s/.*swap.*/#&amp;/&#39; /etc/fstab &amp;&amp; systemctl reboot
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看swap分区是否关闭	
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>free -m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_7-10-用kubeadm-初始化集群" tabindex="-1"><a class="header-anchor" href="#_7-10-用kubeadm-初始化集群" aria-hidden="true">#</a> 7.10.用kubeadm 初始化集群</h2><pre><code>特别注意
只在Master节点操作

初始化集群控制台 Control plane，失败了可以用 kubeadm reset 重置

初始化集群命令
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubeadm init \
	--apiserver-advertise-address=192.168.0.6 \
	--image-repository registry.aliyuncs.com/google_containers \
	--kubernetes-version v1.22.4 \
	--service-cidr=10.96.0.0/12 \
	--pod-network-cidr=10.244.0.0/16 \
	--ignore-preflight-errors=all
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>命令说明：	
这个参数就是master主机的IP地址，例如我的Master主机的IP是：192.168.181.131	
--apiserver-advertise-address=192.168.181.131    
这个是镜像地址，由于国外地址无法访问，故使用的阿里云仓库地址：		
registry.aliyuncs.com/google_containers
--image-repository=registry.aliyuncs.com/google_containers
这个参数是下载的k8s软件版本号，可使用kubeadm config images list查询
--kubernetes-version=v1.17.4   
这个参数后的IP地址直接就套用10.96.0.0/12 ,以后安装时也套用即可，不要更改
--service-cidr=10.96.0.0/12
k8s内部的pod节点之间网络可以使用的IP段，不能和service-cidr写一样，如果不知道怎么配，就先
	用这个10.244.0.0/16
--pod-network-cidr=10.244.0.0/16

启动成功后控制台输出其他节点加入主节点的秘钥:每次执行 kubeadm init后这个秘钥会发生变化
如：kubeadm join 192.168.0.6:6443 \
	--token e60qrb.6321jolakk1aix90 \
	--discovery-token-ca-cert-hash \
	sha256:02829b33a24eef53805ffedef79c0371cb4d9ac0d04bfad7fe26eb022cb638ac
注意
可以保存秘钥，方便在其他节点上使用 
重新获取kubeadm join...
kubeadm token create --print-join-command	
					
复制授权文件，以便 kubectl 可以有权限访问集群
如果其他节点需要访问集群，需要从主节点复制这个文件过去其他节点
mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre><h2 id="_7-11-其他节点连接到master节点" tabindex="-1"><a class="header-anchor" href="#_7-11-其他节点连接到master节点" aria-hidden="true">#</a> 7.11.其他节点连接到Master节点</h2><pre><code>在两个上Slave节点输入第9&gt;&gt;.步骤在主节点上获取的秘钥
如：kubeadm join 192.168.0.6:6443 \
	--token e60qrb.6321jolakk1aix90 \
	--discovery-token-ca-cert-hash \
	sha256:02829b33a24eef53805ffedef79c0371cb4d9ac0d04bfad7fe26eb022cb638ac
	
加入成功后看到:
	This node has joined the cluster
</code></pre><h2 id="_7-12-在master节点上查看集群" tabindex="-1"><a class="header-anchor" href="#_7-12-在master节点上查看集群" aria-hidden="true">#</a> 7.12.在master节点上查看集群</h2><pre><code>mater节点和两个slave节点STATUS是NOTReady
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get nodes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@master ~]# kubectl get nodes
NAME     STATUS     ROLES                  AGE     VERSION
master   NotReady      control-plane,master   9m32s   v1.22.4
slave1   NotReady   &lt;none&gt;                 5m51s   v1.22.4
slave2   NotReady      &lt;none&gt;                 2m31s   v1.22.4
</code></pre><h2 id="_7-13-安装网络插件" tabindex="-1"><a class="header-anchor" href="#_7-13-安装网络插件" aria-hidden="true">#</a> 7.13.安装网络插件</h2><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl apply -f \
	https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-14-在master上查看集群节点" tabindex="-1"><a class="header-anchor" href="#_7-14-在master上查看集群节点" aria-hidden="true">#</a> 7.14.在master上查看集群节点</h2><pre><code>再次执行命令查看集群命令，mater节点STATUS是Ready，两个slave节点STATUS是都是Ready
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get nodes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@master ~]# kubectl get nodes
NAME     STATUS     ROLES                  AGE     VERSION
master   Ready      control-plane,master   9m32s   v1.22.4
slave1   Ready   &lt;none&gt;                 5m51s   v1.22.4
slave2   Ready      &lt;none&gt;                 2m31s   v1.22.4	
注意事项
如果两个从节点中有一个节点状态是NotReady，另一个节点状态是Ready，不要着急，要多等一会儿
再使用命令kubectl get nodes查看集群节点，就可以看到所有节点都是Ready
</code></pre><h2 id="_7-15-启动故障解决" tabindex="-1"><a class="header-anchor" href="#_7-15-启动故障解决" aria-hidden="true">#</a> 7.15.启动故障解决</h2><pre><code>查看所有命名空间的所有的pod
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get pods -o wide --all-namespaces
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看启动失败的pod的日志，其中PODNAME为启动失败的pod的name
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl -n kube-system logs PODNAME
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>重置kubeadm
可使用kubeadm reset命令重启kubeadm，再从第9&gt;&gt;.步骤开始重新执行
</code></pre><h2 id="_7-16-基础命令" tabindex="-1"><a class="header-anchor" href="#_7-16-基础命令" aria-hidden="true">#</a> 7.16.基础命令</h2><pre><code>查看kubeadm需要的组件的版本
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubeadm config images list
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看所有节点
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get nodes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看pod
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get pod
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看所有命名空间的所有pod
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get pods -o wide --all-namespaces
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看pod日志
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl describe pod
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_7-17-部署第一个程序到k8s中" tabindex="-1"><a class="header-anchor" href="#_7-17-部署第一个程序到k8s中" aria-hidden="true">#</a> 7.17.部署第一个程序到k8s中</h2><pre><code>开始运行 guestbook
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl create deployment guestbook --image=ibmcom/guestbook:v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查询pod运行状态，状态应该显示为Running表示pod运行成功
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get pods
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>对外暴露端口
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl expose deployment guestbook --type=NodePort --port=3000
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查询端口映射	
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get service guestbook
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>NAME        TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
guestbook   NodePort   10.10.10.253   &lt;none&gt;        3000:31208/TCP   1m

访问服务（主节点和两个工作节点都可访问到这个服务）
http://192.168.0.6:31208
http://192.168.0.7:31208
http://192.168.0.8:31208
</code></pre><h2 id="_7-18-可视化面板kuboard" tabindex="-1"><a class="header-anchor" href="#_7-18-可视化面板kuboard" aria-hidden="true">#</a> 7.18.可视化面板kuboard</h2><pre><code>安装
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl apply -f https://addons.kuboard.cn/kuboard/kuboard-v3.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看是否安装成功，所有节点状态都是Ready表示安装成功
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get pods -n kuboard
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>登录kuboard-v3
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>http://192.168.0.6:30080	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>用户名/密码： admin/Kuboard123

查看kuboard所有相关的pod是否成功运行,状态为RUNNING代表成功运行
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>watch kubectl get pods -n kuboard
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看启动日志
获取kuboard命名空间中相关pod的name
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>watch kubectl get pods -n kuboard
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>根据pod名称查看pod日志
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl logs -n kuboard kuboard-v3-5fc46b5557-jlsrj
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>启动故障排查
查看docker中部署的kuboard相关容器是否都成功启动了，如果相关容器没有重新启动，可重启一下docker
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>docker ps
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>特别注意
这个kuboard部分pod启动（就绪）的可能很慢，需要耐心等待，等待一定时间后再使用命令查看是否都启动成功了
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>watch kubectl get pods -n kuboard
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>卸载kuboard-v3
执行卸载命令
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	kubectl delete -f https://addons.kuboard.cn/kuboard/kuboard-v3.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>清理遗留数据
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rm -rf /usr/share/kuboard
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h1 id="_8-二进制包搭建kubernetes" tabindex="-1"><a class="header-anchor" href="#_8-二进制包搭建kubernetes" aria-hidden="true">#</a> 8.二进制包搭建Kubernetes</h1><h2 id="_8-1章节大纲" tabindex="-1"><a class="header-anchor" href="#_8-1章节大纲" aria-hidden="true">#</a> 8.1章节大纲</h2><div><iframe src="/markmap/environment/centos/chapter/centos7-outline5-chapter8.html" width="100%" height="400" frameborder="0" scrolling="No" leftmargin="0" topmargin="0"></iframe></div><h2 id="_8-1-环境配置清单" tabindex="-1"><a class="header-anchor" href="#_8-1-环境配置清单" aria-hidden="true">#</a> 8.1.环境配置清单</h2><pre><code>操作系统									centos7
内核版本									3.10.0-1160.71.1.el7.x86_64
docker版本
etcd版本
Kubernetes版本
kube-apiserver版本
kube-controller-manager版本
kube-scheduler版本
nginx版本
keepalive版本
coredns版本
说明
Kubernetes解压后
</code></pre><h2 id="_8-2-服务器规划和ip地址规划" tabindex="-1"><a class="header-anchor" href="#_8-2-服务器规划和ip地址规划" aria-hidden="true">#</a> 8.2.服务器规划和IP地址规划</h2><h3 id="_8-2-1服务器规划" tabindex="-1"><a class="header-anchor" href="#_8-2-1服务器规划" aria-hidden="true">#</a> 8.2.1服务器规划</h3><div class="custom-container tip"><p class="custom-container-title">注意事项</p><p>如果要搭建一主多从非高可用Kubernetes集群，使用服务器规划1<br> 如果要搭建多主多从高可用Kubernetes集群，使用服务器规划2</p></div><pre><code>服务器规划1：一主多从服务器规划
</code></pre><table><thead><tr><th style="text-align:left;">角色</th><th style="text-align:left;">IP</th><th style="text-align:center;">组件</th></tr></thead><tbody><tr><td style="text-align:left;">binary-k8s-master1</td><td style="text-align:left;">192.168.0.9</td><td style="text-align:center;">etcd <br> docker <br> kube-apiserver kube-controller-manager kube-scheduler<br> kubelet kube-proxy</td></tr><tr><td style="text-align:left;">binary-k8s-worker1</td><td style="text-align:left;">192.168.0.10</td><td style="text-align:center;">etcd <br> docker <br> kubelet kube-proxy</td></tr><tr><td style="text-align:left;">binary-k8s-worker1</td><td style="text-align:left;">192.168.0.11</td><td style="text-align:center;">etcd <br> docker <br> kubelet kube-proxy</td></tr></tbody></table><pre><code>服务器规划2：多主多从高可用服务器规划
</code></pre><table><thead><tr><th style="text-align:left;">角色</th><th style="text-align:left;">IP</th><th style="text-align:center;">组件</th></tr></thead><tbody><tr><td style="text-align:left;">binary-k8s-master1</td><td style="text-align:left;">192.168.0.9</td><td style="text-align:center;">etcd <br> docker <br> kube-apiserver kube-controller-manager kube-scheduler <br> kubelet kube-proxy <br> nginx keepalived</td></tr><tr><td style="text-align:left;">binary-k8s-master2</td><td style="text-align:left;">192.168.0.12</td><td style="text-align:center;">etcd <br> docker <br> kube-apiserver kube-controller-manager kube-scheduler <br> kubelet kube-proxy <br> nginx keepalived</td></tr><tr><td style="text-align:left;">binary-k8s-worker1</td><td style="text-align:left;">192.168.0.10</td><td style="text-align:center;">etcd <br> docker <br> kubelet kube-proxy</td></tr><tr><td style="text-align:left;">binary-k8s-worker2</td><td style="text-align:left;">192.168.0.11</td><td style="text-align:center;">etcd <br> docker <br> kubelet kube-proxy</td></tr><tr><td style="text-align:left;">负载均衡器(虚拟IP)</td><td style="text-align:left;">192.168.0.88</td><td style="text-align:center;"></td></tr></tbody></table><h3 id="_8-2-2-ip地址规划" tabindex="-1"><a class="header-anchor" href="#_8-2-2-ip地址规划" aria-hidden="true">#</a> 8.2.2.IP地址规划</h3><pre><code>IP地址规划
kubernetes自身使用的ClusterIP：10.0.0.1
本地回环地址：127.0.0.1
Master1:192.168.0.9
worker1:192.168.0.10
worker2:192.168.0.11
Master2:168.168.0.12
keepalive虚拟IP: 192.168.0.88
预留IP位置1：168.168.0.13
预留IP位置2：168.168.0.14
预留IP位置3：168.168.0.15
预留IP位置4：168.168.0.17
预留IP位置5：168.168.0.18
预留IP位置6：168.168.0.19
预留IP位置7：168.168.0.20
预留IP位置8：168.168.0.100
预留IP位置9：168.168.0.101
预留IP位置10：168.168.0.102
预留IP位置11：168.168.0.103
预留IP位置12：168.168.0.104
预留IP位置13：168.168.0.105

注意事项
1.可以将这些IP地址进行分类，如下所示（本次为了学习使用，并没有进行详细规划）
Etcd Cluster: 192.168.0.xxx
Master Node : 192.168.1.xxx
Worker Node : 192.168.2.xxx
keepalive   : 192.168.3.xx
2.一定要多预留一些IP地址，全部安装好之后，再给kube-apiserver添加IP地址很麻烦	
</code></pre><h2 id="_8-3-安装前准备工作" tabindex="-1"><a class="header-anchor" href="#_8-3-安装前准备工作" aria-hidden="true">#</a> 8.3.安装前准备工作</h2><div class="custom-container tip"><p class="custom-container-title">注意事项</p><p>8.3章节涉及到的操作所有的Master节点和Worker Node都要执行，下载所有用到的软件包包只需要在Mater Node1进行就可以了</p></div><h3 id="_8-3-1操作系统初始设置" tabindex="-1"><a class="header-anchor" href="#_8-3-1操作系统初始设置" aria-hidden="true">#</a> 8.3.1操作系统初始设置</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl stop firewalld &amp;&amp; systemctl disable firewalld #关闭系统防火墙
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sed -i &#39;s/enforcing/disabled/&#39; /etc/selinux/config #永久关闭selinux
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sed -ri &#39;s/.*swap.*/#&amp;/&#39; /etc/fstab #永久关闭swap
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>根据规划设置主机名</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>hostnamectl set-hostname binary-k8s-master1 &amp;&amp; systemctl reboot #binary-k8s-master1（192.168.0.9）
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>hostnamectl set-hostname binary-k8s-worker1  &amp;&amp; systemctl reboot #binary-k8s-worker1 （192.168.0.10）
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>hostnamectl set-hostname binary-k8s-worker2  &amp;&amp; systemctl reboot #binary-k8s-worker2 （192.168.0.11）
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>hostnamectl set-hostname binary-k8s-master2 &amp;&amp; systemctl reboot #binary-k8s-master2（192.168.0.12）
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>添加hosts
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt;&gt; /etc/hosts &lt;&lt; EOF
192.168.0.9 binary-k8s-master1
192.168.0.10 binary-k8s-worker1
192.168.0.11 binary-k8s-worker2
192.168.0.12 binary-k8s-master2
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>将桥接的IPV4流量传递到iptables的链
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>让配置生效
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sysctl --system  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>使用阿里云时间服务器进行临时同步
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ntpdate ntp.aliyun.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>补充命令
setenforce 0  #临时关闭selinux
swapoff -a	#临时关闭swap
</code></pre><h3 id="_8-3-2下载所有用到的软件包" tabindex="-1"><a class="header-anchor" href="#_8-3-2下载所有用到的软件包" aria-hidden="true">#</a> 8.3.2下载所有用到的软件包</h3><pre><code>安装curl
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum -y install curl
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>创建目录后切换到该目录中，并在该目录中下载本次安装所有用到的软件包
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mkdir -p /opt/k8s &amp;&amp;
cd /opt/k8s &amp;&amp;
curl -fL -u software-1658989668964:1db7b96a6698ef06009de91348cb797dfd87fc99 \
&quot;https://lingwh-generic.pkg.coding.net/coding-drive/software/kubernetes-all-2022.7.28.tar.gz?version=latest&quot; \
-o kubernetes-all.tar.gz
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>解压tar包并重命名
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>tar -zxvf kubernetes-all.tar.gz &amp;&amp;
mv kubernetes package
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-4-安装cfssl证书生成工具" tabindex="-1"><a class="header-anchor" href="#_8-4-安装cfssl证书生成工具" aria-hidden="true">#</a> 8.4.安装cfssl证书生成工具</h2><div class="custom-container tip"><p class="custom-container-title">注意事项</p><p>8.4章节涉及到的操作只在Master Node1节点上进行操作</p></div><pre><code>cfssl简介
cfssl是一个开源的证书管理工具，使用json文件生成证书，相比openssl更方便使用,这里在Master Node1节点操作后复
制到其他节点，不需要在所有节点上操作。

切换到存放cfssl-utils的目录中，给cfssl-utils赋予运行权限并拷贝一份到/usr/bin/目录中
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd /opt/k8s/package/cfssl-utils &amp;&amp; chmod +x * &amp;&amp;
cp cfssl_linux-amd64 /usr/local/bin/cfssl &amp;&amp;
cp cfssljson_linux-amd64 /usr/local/bin/cfssljson &amp;&amp;
cp cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-5-搭建etcd集群" tabindex="-1"><a class="header-anchor" href="#_8-5-搭建etcd集群" aria-hidden="true">#</a> 8.5.搭建etcd集群</h2><div class="custom-container tip"><p class="custom-container-title">注意事项</p><p>8.5章节涉及到的操作不要一次性在所有节点上操作，在Master1操作后复制到其他节点，这样比直接在所有节点上操作要快</p></div><h3 id="_8-5-1生成ca证书和https证书" tabindex="-1"><a class="header-anchor" href="#_8-5-1生成ca证书和https证书" aria-hidden="true">#</a> 8.5.1生成CA证书和https证书</h3><pre><code>创建存放etcd证书配置文件和生成证书的目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mkdir -p ~/TLS/{etcd,k8s} &amp;&amp; cd /root/TLS/etcd/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>设置自签证书颁发机构(CA)
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; ca-config.json &lt;&lt; EOF
{
  &quot;signing&quot;: {
    &quot;default&quot;: {
      &quot;expiry&quot;: &quot;87600h&quot;
    },
    &quot;profiles&quot;: {
      &quot;www&quot;: {
         &quot;expiry&quot;: &quot;87600h&quot;,
         &quot;usages&quot;: [
            &quot;signing&quot;,
            &quot;key encipherment&quot;,
            &quot;server auth&quot;,
            &quot;client auth&quot;
        ]
      }
    }
  }
}
EOF

cat &gt; ca-csr.json &lt;&lt; EOF
{
    &quot;CN&quot;: &quot;etcd CA&quot;,
    &quot;key&quot;: {
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
        {
            &quot;C&quot;: &quot;CN&quot;,
            &quot;L&quot;: &quot;YuMingYu&quot;,
            &quot;ST&quot;: &quot;YuMingYu&quot;
        }
    ]
}
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>生成自签CA证书（当前目录下会生成 ca.pem和ca-key.pem文件）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>使用自签CA签发etcd https证书	
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; server-csr.json &lt;&lt; EOF
{
    &quot;CN&quot;: &quot;etcd&quot;,
    &quot;hosts&quot;: [
    &quot;192.168.0.9&quot;,
    &quot;192.168.0.10&quot;,
    &quot;192.168.0.11&quot;,
    &quot;192.168.0.12&quot;
    ],
    &quot;key&quot;: {
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
        {
            &quot;C&quot;: &quot;CN&quot;,
            &quot;L&quot;: &quot;YuMingYu&quot;,
            &quot;ST&quot;: &quot;YuMingYu&quot;
        }
    ]
}
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>生成https证书（hosts字段中ip为所有etcd节点的集群内部通信ip,一个都不能少,可以多写几个预留的ip）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem \
	-config=ca-config.json -profile=www server-csr.json | cfssljson -bare server
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-5-2-部署etcd集群" tabindex="-1"><a class="header-anchor" href="#_8-5-2-部署etcd集群" aria-hidden="true">#</a> 8.5.2.部署etcd集群</h3><pre><code>etcd简介
Etcd 是一个分布式键值存储系统，Kubernetes使用Etcd进行数据存储，所以先准备一个Etcd数据库，为解决Etcd单点
故障，应采用集群方式部署，这里使用3台组建集群，可容忍1台机器故障，当然，你也可以使用5台组建集群，可容忍2台
机器故障
				
服务器规划
节点名称	IP
etcd-1	192.168.0.9
etcd-2	192.168.0.10
etcd-2	192.168.0.11
特别说明
为了节省机器,这里与k8s节点复用,也可以部署在k8s机器之外,只要apiserver能连接到就行。

在Master Node1上创建etcd工作目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	mkdir /opt/etcd/{bin,cfg,ssl} -p
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>切换到存放etcd安装包工作的目录并解压etcd二进制包安装包到文件到指定目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd /opt/k8s/package &amp;&amp;
tar -xf etcd-v3.4.9-linux-amd64.tar.gz &amp;&amp;
mv etcd-v3.4.9-linux-amd64/{etcd,etcdctl} /opt/etcd/bin/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>创建etcd配置文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; EOF
#[Member]
ETCD_NAME=&quot;etcd-1&quot;
ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;
ETCD_LISTEN_PEER_URLS=&quot;https://192.168.0.9:2380&quot;
ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.0.9:2379&quot;

#[Clustering]
ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.0.9:2380&quot;
ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.0.9:2379&quot;
ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.0.9:2380,\
etcd-2=https://192.168.0.10:2380,etcd-3=https://192.168.0.11:2380&quot;
ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;
ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>etcd配置说明:
ETCD_NAME： 节点名称,集群中唯一
ETCD_DATA_DIR：数据目录
ETCD_LISTEN_PEER_URLS：集群通讯监听地址
ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址
ETCD_INITIAL_CLUSTER：集群节点地址
ETCD_INITIALCLUSTER_TOKEN：集群Token
ETCD_INITIALCLUSTER_STATE：加入集群的状态：new是新集群,existing表示加入已有集群
</code></pre><h3 id="_8-5-4-拷贝etcd所需证书" tabindex="-1"><a class="header-anchor" href="#_8-5-4-拷贝etcd所需证书" aria-hidden="true">#</a> 8.5.4.拷贝etcd所需证书</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cp ~/TLS/etcd/{server.pem,server-key.pem,ca.pem} /opt/etcd/ssl/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_8-5-5-让systemd管理etcd" tabindex="-1"><a class="header-anchor" href="#_8-5-5-让systemd管理etcd" aria-hidden="true">#</a> 8.5.5.让systemd管理etcd</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF
[Unit]
Description=Etcd Server
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
EnvironmentFile=/opt/etcd/cfg/etcd.conf
ExecStart=/opt/etcd/bin/etcd \
--cert-file=/opt/etcd/ssl/server.pem \
--key-file=/opt/etcd/ssl/server-key.pem \
--peer-cert-file=/opt/etcd/ssl/server.pem \
--peer-key-file=/opt/etcd/ssl/server-key.pem \
--trusted-ca-file=/opt/etcd/ssl/ca.pem \
--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \
--logger=zap
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-5-6-拷贝etcd安装文件到worker-node" tabindex="-1"><a class="header-anchor" href="#_8-5-6-拷贝etcd安装文件到worker-node" aria-hidden="true">#</a> 8.5.6.拷贝etcd安装文件到Worker Node</h3><div class="custom-container tip"><p class="custom-container-title">注意事项</p><p>在Master1 Node上执行下面操作，只需要拷贝到Worker Node1和Worker Node2即可，不需要拷贝到Master Node2</p></div><pre><code>在Worker Node1上和Worker Node2上创建etcd工作目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	mkdir /opt/etcd/{bin,cfg,ssl} -p
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>复制etcd安装文件和配置文件到192.168.0.10机器上
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>scp -r /opt/etcd/ root@192.168.0.10:/opt &amp;&amp;
scp /usr/lib/systemd/system/etcd.service root@192.168.0.10:/usr/lib/systemd/system/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>复制etcd安装文件和配置文件到192.168.0.11机器上
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>scp -r /opt/etcd/ root@192.168.0.11:/opt &amp;&amp;
scp /usr/lib/systemd/system/etcd.service root@192.168.0.11:/usr/lib/systemd/system/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>修改Worker Node1（192.168.0.10）中etcd.conf配置，下面命令会直接覆盖拷贝过来的配置
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; EOF
#[Member]
ETCD_NAME=&quot;etcd-2&quot;
ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;
ETCD_LISTEN_PEER_URLS=&quot;https://192.168.0.10:2380&quot;
ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.0.10:2379&quot;

#[Clustering]
ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.0.10:2380&quot;
ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.0.10:2379&quot;
ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.0.9:2380,\
etcd-2=https://192.168.0.10:2380,etcd-3=https://192.168.0.11:2380&quot;
ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;
ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>修改后内容	
ETCD_NAME=&quot;etcd-2&quot;	#此处需要修改
ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;
ETCD_LISTEN_PEER_URLS=&quot;https://192.168.0.10:2380&quot; 	#此处需要修改
ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.0.10:2379&quot; 	#此处需要修改

#[Clustering]
ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.0.10:2380&quot; #此处需要修改
ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.0.10:2379&quot; #此处需要修改
ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.0.9:2380,etcd-
2=https://192.168.0.10:2380,etcd-3=https://192.168.0.11:2380&quot;
ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;
ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;
						
修改Worker Node2（192.168.0.11）中etcd.conf配置，下面命令会直接覆盖拷贝过来的配置
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; EOF
#[Member]
ETCD_NAME=&quot;etcd-3&quot;
ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;
ETCD_LISTEN_PEER_URLS=&quot;https://192.168.0.11:2380&quot;
ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.0.11:2379&quot;

#[Clustering]
ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.0.11:2380&quot;
ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.0.11:2379&quot;
ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.0.9:2380,\
etcd-2=https://192.168.0.10:2380,etcd-3=https://192.168.0.11:2380&quot;
ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;
ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>修改后内容
ETCD_NAME=&quot;etcd-3&quot;	#此处需要修改
ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;
ETCD_LISTEN_PEER_URLS=&quot;https://192.168.0.11:2380&quot; 	#此处需要修改
ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.0.11:2379&quot; 	#此处需要修改

#[Clustering]
ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.0.11:2380&quot; #此处需要修改
ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.0.11:2379&quot; #此处需要修改
ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.0.9:2380,etcd-
2=https://192.168.0.10:2380,etcd-3=https://192.168.0.11:2380&quot;
ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;
ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;
</code></pre><h3 id="_8-5-7-启动三个etcd并设置开机自启" tabindex="-1"><a class="header-anchor" href="#_8-5-7-启动三个etcd并设置开机自启" aria-hidden="true">#</a> 8.5.7.启动三个etcd并设置开机自启</h3><pre><code>启动多个节点的etcd
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl daemon-reload &amp;&amp;
systemctl start etcd &amp;&amp;
systemctl enable etcd
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>注意事项	
etcd须多个节点同时启动,不然执行systemctl start etcd会一直卡在前台,连接其他节点,建议通过批量管理工
具,或者脚本同时启动etcd。

检查etcd集群状态
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ETCDCTL_API=3 /opt/etcd/bin/etcdctl \
--cacert=/opt/etcd/ssl/ca.pem \
--cert=/opt/etcd/ssl/server.pem \
--key=/opt/etcd/ssl/server-key.pem \
--endpoints=&quot;https://192.168.0.9:2379,https://192.168.0.10:2379,https://192.168.0.11:2379&quot; \
endpoint health --write-out=table
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>如果启动成功会显示如下内容:
+---------------------------+--------+-------------+-------+
|         ENDPOINT          | HEALTH |    TOOK     | ERROR |
+---------------------------+--------+-------------+-------+
|  https://192.168.0.9:2379 |   true | 44.421035ms |       |
| https://192.168.0.10:2379 |   true | 44.433731ms |       |
| https://192.168.0.11:2379 |   true | 50.266126ms |       |
+---------------------------+--------+-------------+-------+

etcd启动问题排查
命令1
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>journalctl -u etcd
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_8-6-安装配置docker" tabindex="-1"><a class="header-anchor" href="#_8-6-安装配置docker" aria-hidden="true">#</a> 8.6.安装配置Docker</h2><div class="custom-container tip"><p class="custom-container-title">注意事项</p><p>所有节点都需要安装docker，可以先在Master Node1上安装，拷贝一部分安装内容到Worker Node1和Worker Node2，再在Worker Node1和Worker Node2完成剩余的安装操作，这样比直接在三台机器上完成全部操作要快很多</p></div><h3 id="_8-6-1在master1上安装docker" tabindex="-1"><a class="header-anchor" href="#_8-6-1在master1上安装docker" aria-hidden="true">#</a> 8.6.1在Master1上安装docker</h3><pre><code>切换目录并在该目录并将该目录中的docker二进制安装文件解压到指定目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd /opt/k8s/package/ &amp;&amp;
tar -xf docker-19.03.9.tgz &amp;&amp; mv docker/* /usr/bin/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>配置docker私有镜像	
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sudo mkdir -p /etc/docker &amp;&amp;
sudo tee /etc/docker/daemon.json &lt;&lt;-&#39;EOF&#39;
{
  &quot;registry-mirrors&quot;: [&quot;https://3s9106.mirror.alncs.com&quot;]
}
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>配置docker.service文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network-online.target firewalld.service
Wants=network-online.target
 
[Service]
Type=notify
ExecStart=/usr/bin/dockerd
ExecReload=/bin/kill -s HUP $MAINPID
LimitNOFILE=infinity
LimitNPROC=infinity
TimeoutStartSec=0
Delegate=yes
KillMode=process
Restart=on-failure
StartLimitBurst=3
StartLimitInterval=60s
 
[Install]
WantedBy=multi-user.target
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-6-2在所有worker-node上安装docker" tabindex="-1"><a class="header-anchor" href="#_8-6-2在所有worker-node上安装docker" aria-hidden="true">#</a> 8.6.2在所有Worker Node上安装docker</h3><div class="custom-container tip"><p class="custom-container-title">注意事项</p><p>只需要在Master Node1上安装Docker，然后将所有安装文件从Master Node1上拷贝到Worker Node1和Worker Node2上</p></div><pre><code>在Worker Node1和Worker Node2上创建存放docker安装文件的目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mkdir -p /opt/k8s/package &amp;&amp;
mkdir -p /etc/docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>从Mater1上复制Docker安装文件到Worker Node1和Worker Node2
Worker Node1（192.168.0.10）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>scp /usr/bin/docker* root@192.168.0.10:/usr/bin &amp;&amp;
scp /usr/bin/runc root@192.168.0.10:/usr/bin &amp;&amp;
scp /usr/bin/containerd* root@192.168.0.10:/usr/bin &amp;&amp;
scp /usr/lib/systemd/system/docker.service \
root@192.168.0.10:/usr/lib/systemd/system &amp;&amp;
scp -r /etc/docker root@192.168.0.10:/etc
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>Worker Node2（192.168.0.11）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>scp /usr/bin/docker* root@192.168.0.11:/usr/bin &amp;&amp;
scp /usr/bin/runc root@192.168.0.11:/usr/bin &amp;&amp;
scp /usr/bin/containerd* root@192.168.0.11:/usr/bin &amp;&amp;
scp /usr/lib/systemd/system/docker.service \
root@192.168.0.11:/usr/lib/systemd/system &amp;&amp;
scp -r /etc/docker root@192.168.0.11:/etc
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-6-3启动三台机器上的docker" tabindex="-1"><a class="header-anchor" href="#_8-6-3启动三台机器上的docker" aria-hidden="true">#</a> 8.6.3启动三台机器上的docker</h3><pre><code>刷新配置文件后启动三台机器上的docker并设置为开机启动
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl daemon-reload &amp;&amp;
systemctl start docker &amp;&amp;
systemctl enable docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>查看启动状态
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl status docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>启动故障排查
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl status docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_8-7-搭建kube-apiserver" tabindex="-1"><a class="header-anchor" href="#_8-7-搭建kube-apiserver" aria-hidden="true">#</a> 8.7.搭建kube-apiserver</h2><div class="custom-container tip"><p class="custom-container-title">注意事项</p><p>8.7章节所有操作只在Master Node1节点操作，不需要在其他节点操作，因为kube-apiserver是Master节点的专用组件，Worker Node不需要使用这个组件</p></div><h3 id="_8-7-1-生成ca证书和https证书" tabindex="-1"><a class="header-anchor" href="#_8-7-1-生成ca证书和https证书" aria-hidden="true">#</a> 8.7.1.生成CA证书和Https证书</h3><pre><code>切换目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd ~/TLS/k8s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>设置CA自签机构
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; ca-config.json &lt;&lt; EOF
{
  &quot;signing&quot;: {
    &quot;default&quot;: {
      &quot;expiry&quot;: &quot;87600h&quot;
    },
    &quot;profiles&quot;: {
      &quot;kubernetes&quot;: {
         &quot;expiry&quot;: &quot;87600h&quot;,
         &quot;usages&quot;: [
            &quot;signing&quot;,
            &quot;key encipherment&quot;,
            &quot;server auth&quot;,
            &quot;client auth&quot;
        ]
      }
    }
  }
}
EOF

cat &gt; ca-csr.json &lt;&lt; EOF
{
    &quot;CN&quot;: &quot;kubernetes&quot;,
    &quot;key&quot;: {
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
        {
            &quot;C&quot;: &quot;CN&quot;,
            &quot;L&quot;: &quot;Beijing&quot;,
            &quot;ST&quot;: &quot;Beijing&quot;,
            &quot;O&quot;: &quot;k8s&quot;,
            &quot;OU&quot;: &quot;System&quot;
        }
    ]
}
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>生成自签CA证书（生成成功目录下回多ca-key.pem  ca.csr  ca.pem）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cfssl gencert -initca ca-csr.json | cfssljson -bare ca -
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>使用自签CA签发kube-apiserver https
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; server-csr.json &lt;&lt; EOF
{
    &quot;CN&quot;: &quot;kubernetes&quot;,
    &quot;hosts&quot;: [
      &quot;10.0.0.1&quot;,
      &quot;127.0.0.1&quot;,
      &quot;192.168.0.9&quot;,
      &quot;192.168.0.10&quot;,
      &quot;192.168.0.11&quot;,
      &quot;192.168.0.12&quot;,
      &quot;192.168.0.88&quot;,
      &quot;192.168.0.13&quot;,
      &quot;192.168.0.14&quot;,
      &quot;192.168.0.15&quot;,
      &quot;192.168.0.16&quot;,
      &quot;192.168.0.17&quot;,
      &quot;192.168.0.18&quot;,
      &quot;192.168.0.19&quot;,
      &quot;192.168.0.20&quot;,
      &quot;192.168.0.100&quot;,
      &quot;192.168.0.101&quot;,
      &quot;192.168.0.102&quot;,
      &quot;192.168.0.103&quot;,
      &quot;192.168.0.104&quot;,
      &quot;192.168.0.105&quot;,
      &quot;kubernetes&quot;,
      &quot;kubernetes.default&quot;,
      &quot;kubernetes.default.svc&quot;,
      &quot;kubernetes.default.svc.cluster&quot;,
      &quot;kubernetes.default.svc.cluster.local&quot;
    ],
    &quot;key&quot;: {
        &quot;algo&quot;: &quot;rsa&quot;,
        &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
        {
            &quot;C&quot;: &quot;CN&quot;,
            &quot;L&quot;: &quot;BeiJing&quot;,
            &quot;ST&quot;: &quot;BeiJing&quot;,
            &quot;O&quot;: &quot;k8s&quot;,
            &quot;OU&quot;: &quot;System&quot;
        }
    ]
}
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>关于IP地址的说明
IP地址列表
	kubernetes自身使用的ClusterIP：10.0.0.1
	本地回环地址：127.0.0.1
	Master1:192.168.0.9
	worker1:192.168.0.10
	worker2:192.168.0.11
	Master2:168.168.0.12
	keepalive虚拟IP: 192.168.0.88
	预留IP位置1：168.168.0.13
	预留IP位置2：168.168.0.14
	预留IP位置3：168.168.0.15
	预留IP位置4：168.168.0.17
	预留IP位置5：168.168.0.18
	预留IP位置6：168.168.0.19
	预留IP位置7：168.168.0.20
	预留IP位置8：168.168.0.100
	预留IP位置9：168.168.0.101
	预留IP位置10：168.168.0.102
	预留IP位置11：168.168.0.103
	预留IP位置12：168.168.0.104
	预留IP位置13：168.168.0.105

注意事项
	如果要部署一主多从非高可用不用加keepalive虚拟IP
	如果要部署多主多从高可用一定要加上keepalive虚拟IP
	一定要多预留几个IP地址，这个IP地址是留给以后集群扩展时Master Node或者Worker Node使用的
	可以分一下:目前没有分只是为了学习使用
		Master Node:192.168.0.xxx
		Worker Node:192.168.1.xxx
		VIP		:192.168.3.xxx
</code></pre><p>​ ​ 生成https证书（当前目录下会生成server.pem 和 server-key.pem文件）</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json \
-profile=kubernetes server-csr.json | cfssljson -bare server
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-7-2-在master-node1上部署kube-apiserver" tabindex="-1"><a class="header-anchor" href="#_8-7-2-在master-node1上部署kube-apiserver" aria-hidden="true">#</a> 8.7.2.在Master Node1上部署kube-apiserver</h3><pre><code>创建kube-apiserver工作目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mkdir -p /opt/kubernetes/{bin,cfg,ssl,logs}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>切换目录并解压kubernetes软件包并将kube-apiserver拷贝到指定目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd /opt/k8s/package &amp;&amp;
tar -zxvf kubernetes-server-linux-amd64.tar.gz &amp;&amp;
cd /opt/k8s/package/kubernetes/server/bin &amp;&amp;
cp kube-apiserver /opt/kubernetes/bin &amp;&amp;
cp kubectl /usr/bin/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>创建kube-apiserver配置文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /opt/kubernetes/cfg/kube-apiserver.conf &lt;&lt; EOF
KUBE_APISERVER_OPTS=&quot;--logtostderr=false \\
--v=2 \\
--log-dir=/opt/kubernetes/logs \\
--etcd-servers=https://192.168.0.9:2379,https://192.168.0.10:2379,\
https://192.168.0.11:2379 \\
--bind-address=192.168.0.9 \\
--secure-port=6443 \\
--advertise-address=192.168.0.9 \\
--allow-privileged=true \\
--service-cluster-ip-range=10.0.0.0/24 \\
--enable-admission-plugins=NamespaceLifecycle,\
LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\
--authorization-mode=RBAC,Node \\
--enable-bootstrap-token-auth=true \\
--token-auth-file=/opt/kubernetes/cfg/token.csv \\
--service-node-port-range=30000-32767 \\
--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\
--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\
--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\
--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\
--client-ca-file=/opt/kubernetes/ssl/ca.pem \\
--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\
--service-account-issuer=api \\
--service-account-signing-key-file=/opt/kubernetes/ssl/server-key.pem \\
--etcd-cafile=/opt/etcd/ssl/ca.pem \\
--etcd-certfile=/opt/etcd/ssl/server.pem \\
--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\
--requestheader-client-ca-file=/opt/kubernetes/ssl/ca.pem \\
--proxy-client-cert-file=/opt/kubernetes/ssl/server.pem \\
--proxy-client-key-file=/opt/kubernetes/ssl/server-key.pem \\
--requestheader-allowed-names=kubernetes \\
--requestheader-extra-headers-prefix=X-Remote-Extra- \\
--requestheader-group-headers=X-Remote-Group \\
--requestheader-username-headers=X-Remote-User \\
--enable-aggregator-routing=true \\
--audit-log-maxage=30 \\
--audit-log-maxbackup=3 \\
--audit-log-maxsize=100 \\
--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&quot;
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>配置说明:
上面两个\\第一个是转义符,第二个是换行符,使用转义符是为了使用EOF保留换行符。
--logtostderr ：启用日志
--v ：日志等级
--log-dir ：日志目录
--etcd-servers ：etcd集群地址
--bind-address ：监听地址
--secure-port ：https安全端口
--advertise-address ：集群通告地址
--allow-privileged ：启动授权
--service-cluster-ip-range ：Service虚拟IP地址段
--enable-admission-plugins ： 准入控制模块
--authorization-mode ：认证授权,启用RBAC授权和节点自管理
--enable-bootstrap-token-auth ：启用TLS bootstrap机制
--token-auth-file ：bootstrap token文件
--service-node-port-range ：Service nodeport类型默认分配端口范围
--kubelet-client-xxx ：apiserver访问kubelet客户端证书
--tls-xxx-file ：apiserver https证书
--etcd-xxxfile ：连接etcd集群证书
--audit-log-xxx ：审计日志
注意事项
1.20版本必须加的参数：
--service-account-issuer
--service-account-signing-key-file
启动聚合层网关配置：
--requestheader-client-ca-file
--proxy-client-cert-file
--proxy-client-key-file
--requestheader-allowed-names
--requestheader-extra-headers-prefix
--requestheader-group-headers
--requestheader-username-headers
--enable-aggregator-routing
</code></pre><h3 id="_8-7-3-拷贝所需证书" tabindex="-1"><a class="header-anchor" href="#_8-7-3-拷贝所需证书" aria-hidden="true">#</a> 8.7.3.拷贝所需证书</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cp ~/TLS/k8s/ca*pem ~/TLS/k8s/server*pem /opt/kubernetes/ssl/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_8-7-4-启用tls-bootstrapping" tabindex="-1"><a class="header-anchor" href="#_8-7-4-启用tls-bootstrapping" aria-hidden="true">#</a> 8.7.4.启用TLS bootstrapping</h3><pre><code>TLS Bootstraping介绍
Master apiserver启用TLS认证后，Node节点kubelet和kube-proxy要与kube-apiserver进
行通信，必须使用CA签发的有效证书才可以，当Node节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群
扩展复杂度。为了简化流程，Kubernetes引入了TLS bootstraping机制来自动颁发客户端证书，kubelet会以一个低
权限用户自动向apiserver申请证书，kubelet的证书由apiserver动态签署。所以强烈建议在Node上使用这种方式，目
前主要用于kubelet，kube-proxy还是由我们统一颁发一个证书。

创建上述配置文件中token文件：（格式：token,用户名,UID,用户组）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /opt/kubernetes/cfg/token.csv &lt;&lt; EOF
4136692876ad4b01bb9dd0988480ebba,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>注意事项：token也可自行生成替换
head -c 16 /dev/urandom | od -An -t x | tr -d &#39; &#39;
</code></pre><h3 id="_8-7-5-让systemd管理apiserver" tabindex="-1"><a class="header-anchor" href="#_8-7-5-让systemd管理apiserver" aria-hidden="true">#</a> 8.7.5.让systemd管理apiserver</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf
ExecStart=/opt/kubernetes/bin/kube-apiserver \$KUBE_APISERVER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-7-6-启动kube-apiserver" tabindex="-1"><a class="header-anchor" href="#_8-7-6-启动kube-apiserver" aria-hidden="true">#</a> 8.7.6.启动kube-apiserver</h3><pre><code>刷新配置文件后启动kube-apiserver并设置为开机启动状态
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl daemon-reload &amp;&amp;
systemctl start kube-apiserver &amp;&amp;
systemctl enable kube-apiserver
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>查看启动状态
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl status kube-apiserver
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>启动故障排查
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat /var/log/messages|grep kube-apiserver|grep -i error
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_8-8-在master-node1上部署kube-controller-manager" tabindex="-1"><a class="header-anchor" href="#_8-8-在master-node1上部署kube-controller-manager" aria-hidden="true">#</a> 8.8.在Master Node1上部署kube-controller-manager</h2><div class="custom-container tip"><p class="custom-container-title">注意事项</p><p>8.8章节所有操作只在Master Node1节点操作，不需要在其他节点操作，因为kube-controller-manager是Master节点的专用组件，Worker Node不需要使用这个组件</p></div><h3 id="_8-8-1-切换目录并拷贝kube-controller-manager相关文件到-opt-kubernetes-bin" tabindex="-1"><a class="header-anchor" href="#_8-8-1-切换目录并拷贝kube-controller-manager相关文件到-opt-kubernetes-bin" aria-hidden="true">#</a> 8.8.1.切换目录并拷贝kube-controller-manager相关文件到/opt/kubernetes/bin</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cp /opt/k8s/package/kubernetes/server/bin/kube-controller-manager /opt/kubernetes/bin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_8-8-2-生成证书" tabindex="-1"><a class="header-anchor" href="#_8-8-2-生成证书" aria-hidden="true">#</a> 8.8.2.生成证书</h3><pre><code>切换工作目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd ~/TLS/k8s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>生成CA自签签证
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; kube-controller-manager-csr.json &lt;&lt; EOF
{
    &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,
    &quot;hosts&quot;: [],
    &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
    {
        &quot;C&quot;: &quot;CN&quot;,
        &quot;L&quot;: &quot;BeiJing&quot;, 
        &quot;ST&quot;: &quot;BeiJing&quot;,
        &quot;O&quot;: &quot;system:masters&quot;,
        &quot;OU&quot;: &quot;System&quot;
    }
    ]
}
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>使用CA自签证书签发kube-controller-manager
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem \
-config=ca-config.json -profile=kubernetes \
kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-8-2-创建kube-controller-manager配置文件" tabindex="-1"><a class="header-anchor" href="#_8-8-2-创建kube-controller-manager配置文件" aria-hidden="true">#</a> 8.8.2.创建kube-controller-manager配置文件</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /opt/kubernetes/cfg/kube-controller-manager.conf &lt;&lt; EOF
KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=false \\
--v=2 \\
--log-dir=/opt/kubernetes/logs \\
--leader-elect=true \\
--kubeconfig=/opt/kubernetes/cfg/kube-controller-manager.kubeconfig \\
--bind-address=127.0.0.1 \\
--allocate-node-cidrs=true \\
--cluster-cidr=10.244.0.0/16 \\
--service-cluster-ip-range=10.0.0.0/24 \\
--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\
--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\
--root-ca-file=/opt/kubernetes/ssl/ca.pem \\
--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\
--cluster-signing-duration=87600h0m0s&quot;
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>配置文件说明		
--kubeconfig ：连接apiserver配置文件。
--leader-elect ：当该组件启动多个时,自动选举(HA)
--cluster-signing-cert-file ：自动为kubelet颁发证书的CA,apiserver保持一致
--cluster-signing-key-file ：自动为kubelet颁发证书的CA,apiserver保持一致	
</code></pre><h3 id="_8-8-3-生成配置文件" tabindex="-1"><a class="header-anchor" href="#_8-8-3-生成配置文件" aria-hidden="true">#</a> 8.8.3.生成配置文件</h3><div class="custom-container tip"><p class="custom-container-title">注意事项</p><p>以下是shell命令,直接在shell终端执行</p></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>KUBE_CONFIG=&quot;/opt/kubernetes/cfg/kube-controller-manager.kubeconfig&quot;
KUBE_APISERVER=&quot;https://192.168.0.9:6443&quot;

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-credentials kube-controller-manager \
  --client-certificate=./kube-controller-manager.pem \
  --client-key=./kube-controller-manager-key.pem \
  --embed-certs=true \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-controller-manager \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config use-context default --kubeconfig=${KUBE_CONFIG}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-8-4-让systemd管理controller-manager" tabindex="-1"><a class="header-anchor" href="#_8-8-4-让systemd管理controller-manager" aria-hidden="true">#</a> 8.8.4.让systemd管理controller-manager</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf
ExecStart=/opt/kubernetes/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-8-5-启动kube-controller-manager" tabindex="-1"><a class="header-anchor" href="#_8-8-5-启动kube-controller-manager" aria-hidden="true">#</a> 8.8.5.启动kube-controller-manager</h3><pre><code>刷新配置文件后启动kube-controller-manager并设置为开机启动
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl daemon-reload &amp;&amp;
systemctl start kube-controller-manager &amp;&amp;
systemctl enable kube-controller-manager
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>查看kube-controller-manager启动状态
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl status kube-controller-manager
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>启动故障排查
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat /var/log/messages|grep kube-controller-manager|grep -i error
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_8-9-部署kube-scheduler" tabindex="-1"><a class="header-anchor" href="#_8-9-部署kube-scheduler" aria-hidden="true">#</a> 8.9.部署kube-scheduler</h2><div class="custom-container tip"><p class="custom-container-title">注意事项</p><p>8.9章节所有操作只在Master Node1节点操作，不需要在其他节点操作，因为kube-scheduler是Master节点的专用组件，Worker Node不需要使用这个组件</p></div><h3 id="_8-8-1-切换目录并拷贝kube-dcheduler相关文件到-opt-kubernetes-bin" tabindex="-1"><a class="header-anchor" href="#_8-8-1-切换目录并拷贝kube-dcheduler相关文件到-opt-kubernetes-bin" aria-hidden="true">#</a> 8.8.1 切换目录并拷贝kube-dcheduler相关文件到/opt/kubernetes/bin</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cp /opt/k8s/package/kubernetes/server/bin/kube-scheduler /opt/kubernetes/bin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_8-9-2-生成证书" tabindex="-1"><a class="header-anchor" href="#_8-9-2-生成证书" aria-hidden="true">#</a> 8.9.2.生成证书</h3><pre><code>切换工作目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd ~/TLS/k8s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>创建证书请求文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; kube-scheduler-csr.json &lt;&lt; EOF
{
  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,
  &quot;hosts&quot;: [],
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;L&quot;: &quot;BeiJing&quot;,
      &quot;ST&quot;: &quot;BeiJing&quot;,
      &quot;O&quot;: &quot;system:masters&quot;,
      &quot;OU&quot;: &quot;System&quot;
    }
  ]
}
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>生成证书
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem \
-config=ca-config.json -profile=kubernetes \
kube-scheduler-csr.json | cfssljson -bare kube-scheduler
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-9-3-创建kube-scheduler-conf配置文件" tabindex="-1"><a class="header-anchor" href="#_8-9-3-创建kube-scheduler-conf配置文件" aria-hidden="true">#</a> 8.9.3.创建kube-scheduler.conf配置文件</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /opt/kubernetes/cfg/kube-scheduler.conf &lt;&lt; EOF
KUBE_SCHEDULER_OPTS=&quot;--logtostderr=false \\
--v=2 \\
--log-dir=/opt/kubernetes/logs \\
--leader-elect \\
--kubeconfig=/opt/kubernetes/cfg/kube-scheduler.kubeconfig \\
--bind-address=127.0.0.1&quot;
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>配置文件说明
--kubeconfig ：连接apiserver配置文件
--leader-elect ：当该组件启动多个时,自动选举(HA)。
</code></pre><h3 id="_8-9-4-生成kube-scheduler-kubeconfig文件" tabindex="-1"><a class="header-anchor" href="#_8-9-4-生成kube-scheduler-kubeconfig文件" aria-hidden="true">#</a> 8.9.4.生成kube-scheduler.kubeconfig文件</h3><div class="custom-container tip"><p class="custom-container-title">注意事项</p><p>在shell中执行直接执行下面命令</p></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	mkdir ~/.kube
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>KUBE_CONFIG=&quot;/opt/kubernetes/cfg/kube-scheduler.kubeconfig&quot;
KUBE_APISERVER=&quot;https://192.168.0.9:6443&quot;

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-credentials kube-scheduler \
  --client-certificate=./kube-scheduler.pem \
  --client-key=./kube-scheduler-key.pem \
  --embed-certs=true \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-scheduler \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config use-context default --kubeconfig=${KUBE_CONFIG}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-9-5-让systemd管理kube-scheduler" tabindex="-1"><a class="header-anchor" href="#_8-9-5-让systemd管理kube-scheduler" aria-hidden="true">#</a> 8.9.5.让systemd管理kube-scheduler</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes

[Service]
EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf
ExecStart=/opt/kubernetes/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-9-6-启动并设置开机启动" tabindex="-1"><a class="header-anchor" href="#_8-9-6-启动并设置开机启动" aria-hidden="true">#</a> 8.9.6.启动并设置开机启动</h3><pre><code>刷新配置文件后启动kube-scheduler并设置为开机启动
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl daemon-reload &amp;&amp;
systemctl start kube-scheduler &amp;&amp;
systemctl enable kube-scheduler
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>查看启动状态
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl status kube-scheduler
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>启动故障排查
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat /var/log/messages|grep kube-scheduler|grep -i error
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_8-10-使用kubectl查看集群状态" tabindex="-1"><a class="header-anchor" href="#_8-10-使用kubectl查看集群状态" aria-hidden="true">#</a> 8.10.使用kubectl查看集群状态</h2><div class="custom-container tip"><p class="custom-container-title">注意事项</p><p>8.10章节所有操作只在Master1节点操作，不需要在其他节点操作，因为kubectl是Master节点的专用组件，Worker Node不需要使用这个组件</p></div><h3 id="_8-10-1-生成所需证书" tabindex="-1"><a class="header-anchor" href="#_8-10-1-生成所需证书" aria-hidden="true">#</a> 8.10.1.生成所需证书</h3><pre><code>切换工作目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd ~/TLS/k8s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>使用自签CA签发kubectl连接集群的证书	
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; admin-csr.json &lt;&lt;EOF
{
    &quot;CN&quot;: &quot;admin&quot;,
    &quot;hosts&quot;: [],
    &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
    {
        &quot;C&quot;: &quot;CN&quot;,
        &quot;L&quot;: &quot;BeiJing&quot;,
        &quot;ST&quot;: &quot;BeiJing&quot;,
        &quot;O&quot;: &quot;system:masters&quot;,
        &quot;OU&quot;: &quot;System&quot;
    }
    ]
}
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>生成证书
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem \
-config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-10-2-在-kube文件夹中生成config文件" tabindex="-1"><a class="header-anchor" href="#_8-10-2-在-kube文件夹中生成config文件" aria-hidden="true">#</a> 8.10.2.在.kube文件夹中生成config文件</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mkdir /root/.kube

KUBE_CONFIG=&quot;/root/.kube/config&quot;
KUBE_APISERVER=&quot;https://192.168.0.9:6443&quot;

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-credentials cluster-admin \
  --client-certificate=./admin.pem \
  --client-key=./admin-key.pem \
  --embed-certs=true \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-context default \
  --cluster=kubernetes \
  --user=cluster-admin \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config use-context default --kubeconfig=${KUBE_CONFIG}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-10-3-通过kubectl工具查看集群组件" tabindex="-1"><a class="header-anchor" href="#_8-10-3-通过kubectl工具查看集群组件" aria-hidden="true">#</a> 8.10.3.通过kubectl工具查看集群组件</h3><pre><code>命令
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get cs
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>Master1节点组件运行正常会显示如下结果
NAME                 STATUS    MESSAGE             ERROR
controller-manager   Healthy   ok                  
scheduler            Healthy   ok                  
etcd-0               Healthy   {&quot;health&quot;:&quot;true&quot;}   
etcd-2               Healthy   {&quot;health&quot;:&quot;true&quot;}   
etcd-1               Healthy   {&quot;health&quot;:&quot;true&quot;} 
</code></pre><h3 id="_8-10-4-授权kubelet-bootstrap用户允许请求证书" tabindex="-1"><a class="header-anchor" href="#_8-10-4-授权kubelet-bootstrap用户允许请求证书" aria-hidden="true">#</a> 8.10.4.授权kubelet-bootstrap用户允许请求证书</h3><pre><code>创建授权用户kubelet-bootstrap
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl create clusterrolebinding kubelet-bootstrap \
--clusterrole=system:node-bootstrapper \
--user=kubelet-bootstrap
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>上面如果不行用这个
kubectl create clusterrolebinding kubelet-bootstrap \
--clusterrole=system:node-bootstrapper --user=kubelet-bootstrap --group=system:bootstrappers

补充命令
删除授权kubelet-bootstrap用户：第一步
kubectl delete clusterrolebinding kubelet-bootstrap
删除授权kubelet-bootstrap用户：第二步
find / -name bootstrap.kubeconfig
rm -rf /opt/kubernetes/cfg/bootstrap.kubeconfig
删除授权kubelet-bootstrap用户：第三步
systemctl restart kubelet
</code></pre><h2 id="_8-11-在master-node1上部署第一个worker-node" tabindex="-1"><a class="header-anchor" href="#_8-11-在master-node1上部署第一个worker-node" aria-hidden="true">#</a> 8.11.在Master Node1上部署第一个Worker Node</h2><div class="custom-container tip"><p class="custom-container-title">注意事项</p><p>8.11.章节所有操作只在Master Node1节点操作，即当Master Node1既充当Master Node,也当Worker Node</p></div><pre><code>将Master Node1节点的k8s-server软件包拷贝到所有Worker Node
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd /opt/k8s/package/kubernetes/server/bin/
cp kubelet  kube-proxy /opt/kubernetes/bin/ &amp;&amp;
scp kubelet  kube-proxy root@192.168.0.10:/opt/kubernetes/bin/ &amp;&amp;
scp kubelet  kube-proxy root@192.168.0.11:/opt/kubernetes/bin/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-11-2-在master-node1部署kubelet" tabindex="-1"><a class="header-anchor" href="#_8-11-2-在master-node1部署kubelet" aria-hidden="true">#</a> 8.11.2.在Master Node1部署kubelet</h3><h4 id="_8-11-2-1-创建kubelet配置文件" tabindex="-1"><a class="header-anchor" href="#_8-11-2-1-创建kubelet配置文件" aria-hidden="true">#</a> 8.11.2.1.创建kubelet配置文件</h4><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /opt/kubernetes/cfg/kubelet.conf &lt;&lt; EOF
KUBELET_OPTS=&quot;--logtostderr=false \\
--v=2 \\
--log-dir=/opt/kubernetes/logs \\
--hostname-override=binary-k8s-master1 \\
--network-plugin=cni \\
--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\
--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\
--config=/opt/kubernetes/cfg/kubelet-config.yml \\
--cert-dir=/opt/kubernetes/ssl \\
--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0&quot;
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>配置说明
--hostname-override ：显示名称,集群唯一(不可重复)。
--network-plugin ：启用CNI。
--kubeconfig ： 空路径,会自动生成,后面用于连接apiserver。
--bootstrap-kubeconfig ：首次启动向apiserver申请证书。
--config ：配置文件参数。
--cert-dir ：kubelet证书目录。
--pod-infra-container-image ：管理Pod网络容器的镜像 init container
</code></pre><h4 id="_8-11-2-2-创建kubelet编排文件" tabindex="-1"><a class="header-anchor" href="#_8-11-2-2-创建kubelet编排文件" aria-hidden="true">#</a> 8.11.2.2.创建kubelet编排文件</h4><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /opt/kubernetes/cfg/kubelet-config.yml &lt;&lt; EOF
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
address: 0.0.0.0
port: 10250
readOnlyPort: 10255
cgroupDriver: cgroupfs
clusterDNS:
- 10.0.0.2
clusterDomain: cluster.local 
failSwapOn: false
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 2m0s
    enabled: true
  x509:
    clientCAFile: /opt/kubernetes/ssl/ca.pem 
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
evictionHard:
  imagefs.available: 15%
  memory.available: 100Mi
  nodefs.available: 10%
  nodefs.inodesFree: 5%
maxOpenFiles: 1000000
maxPods: 110
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-11-2-3-生成kubelet初次加入集群引导kubeconfig文件" tabindex="-1"><a class="header-anchor" href="#_8-11-2-3-生成kubelet初次加入集群引导kubeconfig文件" aria-hidden="true">#</a> 8.11.2.3.生成kubelet初次加入集群引导kubeconfig文件</h4><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>KUBE_CONFIG=&quot;/opt/kubernetes/cfg/bootstrap.kubeconfig&quot;
KUBE_APISERVER=&quot;https://192.168.0.9:6443&quot; # apiserver IP:PORT
TOKEN=&quot;4136692876ad4b01bb9dd0988480ebba&quot; # 与token.csv里保持一致  /opt/kubernetes/cfg/token.csv 

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-credentials &quot;kubelet-bootstrap&quot; \
  --token=${TOKEN} \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-context default \
  --cluster=kubernetes \
  --user=&quot;kubelet-bootstrap&quot; \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config use-context default --kubeconfig=${KUBE_CONFIG}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-11-2-4-systemd管理kubelet" tabindex="-1"><a class="header-anchor" href="#_8-11-2-4-systemd管理kubelet" aria-hidden="true">#</a> 8.11.2.4.systemd管理kubelet</h4><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Kubelet
After=docker.service

[Service]
EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf
ExecStart=/opt/kubernetes/bin/kubelet \$KUBELET_OPTS
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-11-3-5-启动kubelet并设置开机启动" tabindex="-1"><a class="header-anchor" href="#_8-11-3-5-启动kubelet并设置开机启动" aria-hidden="true">#</a> 8.11.3.5.启动kubelet并设置开机启动</h4><pre><code>刷新配置文件后启动kubelet并设置开机启动
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl daemon-reload &amp;&amp;
systemctl start kubelet &amp;&amp;
systemctl enable kubelet
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>查看启动状态
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl status kubelet
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>启动故障排查
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat /var/log/messages|grep kubelet
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_8-11-2-6-允许kubelet证书申请并加入集群" tabindex="-1"><a class="header-anchor" href="#_8-11-2-6-允许kubelet证书申请并加入集群" aria-hidden="true">#</a> 8.11.2.6.允许kubelet证书申请并加入集群</h4><pre><code>查看kubelet证书签名请求
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get csr
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@binary-k8s-master1 bin]# kubectl get csr
NAME                                                   AGE	CONDITIO	...              
node-csr-IiJqGnj7y-9pMOIaYb9rpYxtIaEuACOITLI-WpfdpDI   16s	Pending		...

手动批准证书签名请求
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl certificate approve node-csr-IiJqGnj7y-9pMOIaYb9rpYxtIaEuACOITLI-WpfdpDI
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>再次使用命令查看申请是否通过
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get csr
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@binary-k8s-master1 bin]# kubectl get csr
NAME                                                   AGE	CONDITIO	...              
node-csr-IiJqGnj7y-9pMOIaYb9rpYxtIaEuACOITLI-WpfdpDI   16s	Approved	...

补充命令
手动拒绝证书签名请求
kubectl certificate deny node-csr-IiJqGnj7y-9pMOIaYb9rpYxtIaEuACOITLI-WpfdpDI
删除多余的csr
kubectl delete csr node-csr-IiJqGnj7y-9pMOIaYb9rpYxtIaEuACOITLI-WpfdpDI

查看节点（如果上面步骤都没有错误这个步骤可以查看到Master节点）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get nodes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@binary-k8s-master1 bin]# kubectl get nodes
NAME          STATUS     ROLES    AGE     VERSION
binary-k8s-master1   NotReady   &lt;none&gt;   2m10s   v1.20.0

注意事项
由于网络插件还没有部署,节点会没有准备就绪NotReady
</code></pre><h3 id="_8-11-3-部署kube-proxy" tabindex="-1"><a class="header-anchor" href="#_8-11-3-部署kube-proxy" aria-hidden="true">#</a> 8.11.3.部署kube-proxy</h3><h4 id="_8-11-3-1-创建kube-proxy配置文件" tabindex="-1"><a class="header-anchor" href="#_8-11-3-1-创建kube-proxy配置文件" aria-hidden="true">#</a> 8.11.3.1.创建kube-proxy配置文件</h4><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /opt/kubernetes/cfg/kube-proxy.conf &lt;&lt; EOF
KUBE_PROXY_OPTS=&quot;--logtostderr=false \\
--v=2 \\
--log-dir=/opt/kubernetes/logs \\
--config=/opt/kubernetes/cfg/kube-proxy-config.yml&quot;
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-11-3-2-配置参数文件" tabindex="-1"><a class="header-anchor" href="#_8-11-3-2-配置参数文件" aria-hidden="true">#</a> 8.11.3.2.配置参数文件</h4><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /opt/kubernetes/cfg/kube-proxy-config.yml &lt;&lt; EOF
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: 0.0.0.0
metricsBindAddress: 0.0.0.0:10249
clientConnection:
  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig
hostnameOverride: binary-k8s-master1
clusterCIDR: 10.244.0.0/16
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-11-3-3-生成kube-proxy证书文件" tabindex="-1"><a class="header-anchor" href="#_8-11-3-3-生成kube-proxy证书文件" aria-hidden="true">#</a> 8.11.3.3.生成kube-proxy证书文件</h4><pre><code>切换工作目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd ~/TLS/k8s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>创建证书请求文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; kube-proxy-csr.json &lt;&lt; EOF
{
    &quot;CN&quot;: &quot;system:kube-proxy&quot;,
    &quot;hosts&quot;: [],
    &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
    },
    &quot;names&quot;: [
    {
        &quot;C&quot;: &quot;CN&quot;,
        &quot;L&quot;: &quot;BeiJing&quot;,
        &quot;ST&quot;: &quot;BeiJing&quot;,
        &quot;O&quot;: &quot;k8s&quot;,
        &quot;OU&quot;: &quot;System&quot;
    }
   ]
}
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>生成证书
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem \
-config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-11-3-4-生成kube-proxy-kubeconfig文件" tabindex="-1"><a class="header-anchor" href="#_8-11-3-4-生成kube-proxy-kubeconfig文件" aria-hidden="true">#</a> 8.11.3.4.生成kube-proxy.kubeconfig文件</h4><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>KUBE_CONFIG=&quot;/opt/kubernetes/cfg/kube-proxy.kubeconfig&quot;
KUBE_APISERVER=&quot;https://192.168.0.9:6443&quot;

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER} \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-credentials kube-proxy \
  --client-certificate=./kube-proxy.pem \
  --client-key=./kube-proxy-key.pem \
  --embed-certs=true \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config set-context default \
  --cluster=kubernetes \
  --user=kube-proxy \
  --kubeconfig=${KUBE_CONFIG}
  
kubectl config use-context default --kubeconfig=${KUBE_CONFIG}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-11-3-5-systemd管理kube-proxy" tabindex="-1"><a class="header-anchor" href="#_8-11-3-5-systemd管理kube-proxy" aria-hidden="true">#</a> 8.11.3.5.systemd管理kube-proxy</h4><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF
[Unit]
Description=Kubernetes Proxy
After=network.target

[Service]
EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf
ExecStart=/opt/kubernetes/bin/kube-proxy \$KUBE_PROXY_OPTS
Restart=on-failure
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-10-3-6-启动kube-proxy并设置开机自启" tabindex="-1"><a class="header-anchor" href="#_8-10-3-6-启动kube-proxy并设置开机自启" aria-hidden="true">#</a> 8.10.3.6.启动kube-proxy并设置开机自启</h4><pre><code>刷新配置文件后启动kube-proxy并设置开机启动
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl daemon-reload &amp;&amp;
systemctl start kube-proxy &amp;&amp;
systemctl enable kube-proxy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>启动状态查询
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	systemctl status kube-proxy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_8-11-4-部署网络组件-calico" tabindex="-1"><a class="header-anchor" href="#_8-11-4-部署网络组件-calico" aria-hidden="true">#</a> 8.11.4.部署网络组件(Calico)</h3><pre><code>Calico简介
Calico是一个纯三层的数据中心网络方案，是目前Kubernetes主流的网络方案。

切换目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd /root/TLS/k8s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>获取Calico.yaml文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>wget http://docs.projectcalico.org/v3.8/manifests/calico.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>备份calico.yaml并修改calico.yaml
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cp calico.yaml calico.yaml.bak &amp;&amp; 
sed -i &#39;s/192.168.0.0/10.244.0.0/g&#39; calico.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>查询修改结果
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>grep &quot;IPV4POOL_CIDR&quot; calico.yaml  -A 1 \
		- name: CALICO_IPV4POOL_CIDR	\
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>正常会显示线面值
value: &quot;10.244.0.0/16&quot;

部署Calico
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl apply -f calico.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>等待8分钟左右后查看Calico的Pod运行状态（正常是STATUS是Running）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get pods -n kube-system
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@binary-k8s-master1 k8s]# kubectl get pods -n kube-system
NAME                                      READY   STATUS    RESTARTS   AGE
calico-kube-controllers-bcc6f659f-r28g7   1/1     Running   0          18m
calico-node-dkjn6                         1/1     Running   6          18m

注意事项
calico部署很慢，不过不用等8分钟，执行kubectl apply命令后稍等一会儿就可以通过kubectl get nodes
查看节点状态了

查看集群节点（正常是STATUS是Ready）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get nodes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@binary-k8s-master1 k8s]# kubectl get nodes
NAME          		  STATUS   ROLES    AGE   VERSION
binary-k8s-master1    Ready    &lt;none&gt;   34m   v1.20.0
</code></pre><h3 id="_8-11-5-授权apiserver访问kubelet" tabindex="-1"><a class="header-anchor" href="#_8-11-5-授权apiserver访问kubelet" aria-hidden="true">#</a> 8.11.5.授权apiserver访问kubelet</h3><pre><code>应用场景：如kubectl logs

创建配置文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; apiserver-to-kubelet-rbac.yaml &lt;&lt; EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - &quot;&quot;
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
      - pods/log
    verbs:
      - &quot;*&quot;
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: &quot;&quot;
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kubernetes
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>应用配置文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl apply -f apiserver-to-kubelet-rbac.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_8-12-增加worker-node" tabindex="-1"><a class="header-anchor" href="#_8-12-增加worker-node" aria-hidden="true">#</a> 8.12.增加Worker Node</h2><h3 id="_8-12-1-在所有worker-node创建工作目录并拷贝二进制文件" tabindex="-1"><a class="header-anchor" href="#_8-12-1-在所有worker-node创建工作目录并拷贝二进制文件" aria-hidden="true">#</a> 8.12.1.在所有Worker Node创建工作目录并拷贝二进制文件</h3><pre><code>在所有Worker Node1和Worker Node2中创建工作目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mkdir -p /opt/kubernetes/bin &amp;&amp;
mkdir -p /opt/kubernetes/cfg &amp;&amp;
mkdir -p /opt/kubernetes/ssl &amp;&amp;
mkdir -p /opt/kubernetes/logs
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-12-2拷贝master-node1上部署好的文件到worker-node" tabindex="-1"><a class="header-anchor" href="#_8-12-2拷贝master-node1上部署好的文件到worker-node" aria-hidden="true">#</a> 8.12.2拷贝Master Node1上部署好的文件到Worker Node</h3><pre><code>进入Master Node1，执行下面操作，镜相关文件拷贝到Worker Node1和Worker Node2
拷贝到Worker Node1（192.168.0.10）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>scp -r /opt/kubernetes root@192.168.0.10:/opt/ &amp;&amp;
scp -r /usr/lib/systemd/system/{kubelet,kube-proxy}.service \
root@192.168.0.10:/usr/lib/systemd/system &amp;&amp;
scp -r /opt/kubernetes/ssl/ca.pem root@192.168.0.10:/opt/kubernetes/ssl/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>拷贝到Worker Node2（192.168.0.11）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>scp -r /opt/kubernetes root@192.168.0.11:/opt/ &amp;&amp;
scp -r /usr/lib/systemd/system/{kubelet,kube-proxy}.service \
root@192.168.0.11:/usr/lib/systemd/system &amp;&amp;
scp -r /opt/kubernetes/ssl/ca.pem root@192.168.0.11:/opt/kubernetes/ssl/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-12-3-删除所有worker-node中kubelet证书和kubeconfig文件" tabindex="-1"><a class="header-anchor" href="#_8-12-3-删除所有worker-node中kubelet证书和kubeconfig文件" aria-hidden="true">#</a> 8.12.3.删除所有Worker Node中kubelet证书和kubeconfig文件</h3><pre><code>Worker Node1节点（192.168.0.10）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rm -f /opt/kubernetes/cfg/kubelet.kubeconfig &amp;&amp;
rm -f /opt/kubernetes/ssl/kubelet*
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>Worker Node2节点（192.168.0.11）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rm -f /opt/kubernetes/cfg/kubelet.kubeconfig &amp;&amp;
rm -f /opt/kubernetes/ssl/kubelet*
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>说明:
这几个文件是证书申请审批后自动生成的,每个Node不同,必须删除
</code></pre><h3 id="_8-12-4-修改worker-node1和worker-node2主机名" tabindex="-1"><a class="header-anchor" href="#_8-12-4-修改worker-node1和worker-node2主机名" aria-hidden="true">#</a> 8.12.4. 修改Worker Node1和Worker Node2主机名</h3><pre><code>Worker Node1（192.168.0.10）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sed -i &#39;s/--hostname-override=binary-k8s-master1/--hostname-override=binary-k8s-worker1/g&#39; \
/opt/kubernetes/cfg/kubelet.conf #修改--hostname-override的值为binary-k8s-worker1
sed -i &#39;s/hostnameOverride: binary-k8s-master1/hostnameOverride: binary-k8s-worker1/g&#39; \
/opt/kubernetes/cfg/kube-proxy-config.yml #修改hostnameOverride的值binary-k8s-worker1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>Worker Node2（192.168.0.11）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sed -i &#39;s/--hostname-override=binary-k8s-master1/--hostname-override=binary-k8s-worker2/g&#39; \
/opt/kubernetes/cfg/kubelet.conf #修改--hostname-override的值为binary-k8s-worker2
sed -i &#39;s/hostnameOverride: binary-k8s-master1/hostnameOverride: binary-k8s-worker2/g&#39; \
/opt/kubernetes/cfg/kube-proxy-config.yml #修改hostnameOverride的值binary-k8s-worker2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-12-5-启动worker-node1和worker-node2中kubelet并设置开机自启" tabindex="-1"><a class="header-anchor" href="#_8-12-5-启动worker-node1和worker-node2中kubelet并设置开机自启" aria-hidden="true">#</a> 8.12.5.启动Worker Node1和Worker Node2中kubelet并设置开机自启</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl daemon-reload &amp;&amp; 
systemctl start kubelet kube-proxy &amp;&amp; 
systemctl enable kubelet kube-proxy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>查看启动状态
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl status kubelet
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl status kube-proxy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>启动故障解决
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat /var/log/messages|grep kube-proxy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_8-12-6-在master1上同意新的node-kubelet证书申请" tabindex="-1"><a class="header-anchor" href="#_8-12-6-在master1上同意新的node-kubelet证书申请" aria-hidden="true">#</a> 8.12.6.在Master1上同意新的Node kubelet证书申请</h3><pre><code>查看证书请求
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get csr
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@binary-k8s-master1 k8s]# kubectl get csr

NAME                                                    ... CONDITION         ...
node-csr-IiJqGnj7y-9pMOIaYb9rpYxtIaEuACOITLI-WpfdpDI    ... Approved,Issued   ...
node-csr-TlSHYrzacOBQbJyQcfVwuArXPKRbjcoMESZykQ3Qr0w   ... Pending            ...
node-csr-vb-rAPL-grn0NxFGBs-_5pScCDkICmvHRnbhn_bRdsc    ... Pending           ...

手动批准证书签名请求
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl certificate approve node-csr-TlSHYrzacOBQbJyQcfVwuArXPKRbjcoMESZykQ3Qr0w
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl certificate approve node-csr-vb-rAPL-grn0NxFGBs-_5pScCDkICmvHRnbhn_bRdsc
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看所有Node状态(要稍等会才会变成ready,会下载一些初始化镜像)
注意事项
刚加入Worker Node1和Worker Node2时使用kubectl get nodes查看可能会出现Worker Node NotReady状态，等
待大概三分钟左右再使用kubectl get nodes就可以看到所有节点状态都已经就绪了
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get nodes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@binary-k8s-master1 ~]# kubectl get nodes
NAME                  STATUS   ROLES    AGE   VERSION
binary-k8s-master1    Ready    &lt;none&gt;   79s   v1.20.0
binary-k8s-worker1    Ready    &lt;none&gt;   26m   v1.20.0
binary-k8s-worker2    Ready    &lt;none&gt;   26m   v1.20.0

补充命令
删除多余的csr
kubectl delete csr node-csr-Rd_0WEaOFSkRT7geRKfz__I1v6E-CQfJpYwMTDEK-mw
</code></pre><h3 id="_8-12-7-在master1上部署kubernetes-dashboard" tabindex="-1"><a class="header-anchor" href="#_8-12-7-在master1上部署kubernetes-dashboard" aria-hidden="true">#</a> 8.12.7.在Master1上部署kubernetes-dashboard</h3><pre><code>切换目录并在该目录中下载kubernetes-dashboard安装所需要的yaml文件	
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd /opt/k8s/package &amp;&amp;
wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.4.0/aio/deploy/recommended.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>修改配置
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>vim recommended.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>给名称为kubernetes-dashboard的Service中添加type: NodePort参数，大概在245行左右
kind: Service
name: kubernetes-dashboard
spec:
  type: NodePort
  
安装kubernetes-dashboard
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl apply -f recommended.yaml	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看部署情况
注意事项，等待大约2分钟使用kubectl get pods,svc -n kubernetes-dashboard才能看到所有pods,svc状态正常
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get pods,svc -n kubernetes-dashboard
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@binary-k8s-master1 package]# kubectl get pods,svc -n kubernetes-dashboard
NAME                                             READY   STATUS    RESTARTS   AGE
pod/dashboard-metrics-scraper-5b8896d7fc-jj8vp   1/1     Running   0          60m
pod/kubernetes-dashboard-897c7599f-pdk9g         1/1     Running   0          60m

NAME                                TYPE        CLUSTER-IP  	 PORT(S)         AGE
service/dashboard-metrics-scraper   ClusterIP   10.0.0.254       8000/TCP        60m
service/kubernetes-dashboard        NodePort    10.0.0.173       443:30441/TCP   60m

创建dashboard-admin使用的service account并绑定默认cluster-admin管理员集群角色
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl create serviceaccount dashboard-admin -n kube-system
kubectl create clusterrolebinding dashboard-admin \
	--clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin
kubectl describe secrets -n kube-system \
$(kubectl -n kube-system get secret | awk &#39;/dashboard-admin/{print $1}&#39;)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>查询token
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl describe secrets -n kube-system \
$(kubectl -n kube-system get secret | awk &#39;/dashboard-admin/{print $1}&#39;)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>访问kubernetes-dashboard,输入刚才获得的token登录kubernetes-dashboard
https://192.168.0.9:30441/
https://192.168.0.10:30441/
https://192.168.0.11:30441/
</code></pre><h3 id="_8-12-8-在master1上部署coredns" tabindex="-1"><a class="header-anchor" href="#_8-12-8-在master1上部署coredns" aria-hidden="true">#</a> 8.12.8.在Master1上部署CoreDNS</h3><pre><code>介绍
CoreDNS主要用于集群内部Service名称解析。

从kubernetes源码包中获取coredns.yaml
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd /opt/k8s/package/kubernetes &amp;&amp; 
mkdir  kubernetes-src &amp;&amp;
tar fx kubernetes-src.tar.gz -C ./kubernetes-src &amp;&amp;
cd kubernetes-src/cluster/addons/dns/coredns/ &amp;&amp;
cp coredns.yaml.base coredns.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>修改coredns.yaml配置
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>CLUSTER_DNS_DOMAIN=&quot;cluster.local&quot;
CLUSTER_DNS_SVC_IP=&quot;10.0.0.2&quot;
CLUSTER_DNS_LIMIT_MEMORY=&quot;170Mi&quot;

sed -i -e &quot;s@__DNS__DOMAIN__@${CLUSTER_DNS_DOMAIN}@&quot; \
		-e &quot;s@__DNS__SERVER__@${CLUSTER_DNS_SVC_IP}@&quot; \
		-e &quot;s@__DNS__MEMORY__LIMIT__@${CLUSTER_DNS_LIMIT_MEMORY}@&quot; \
		coredns.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>注意：CLUSTER_DNS_DOMAIN和CLUSTER_DNS_SVC_IP的值要和在node节点的kubelet-config.yaml/kubelet-
config.yal中clusterDNS和clusterDomain的值保持一致

修改coredns.yaml中coredns镜像仓库地址
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>vim coredns.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>将135行k8s.gcr.io/coredns:1.6.7修改为registry.aliyuncs.com/google_containers/coredns:v1.8.6

创建coredns使用的service account并绑定默认cluster-admin管理员集群角色
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl create serviceaccount coredns -n kube-system
kubectl create clusterrolebinding coredns \
	--clusterrole=cluster-admin --serviceaccount=kube-system:coredns
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>部署coredns
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl apply -f coredns.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看coredns的pod是否正常
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get pods -n kube-system
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@k8s-master1 yaml]# kubectl get pods -n kube-system
NAME                                      READY   STATUS    RESTARTS   AGE
calico-kube-controllers-97769f7c7-zcz5d   1/1     Running   1          47h
calico-node-5tnll                         1/1     Running   1          47h
calico-node-m8sdg                         1/1     Running   0          42m
calico-node-pqvk9                         1/1     Running   0          56m
coredns-6cc56c94bd-5hvfb                  1/1     Running   0          37s

启动故障排查
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl logs PODNAME -n kube-system
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>给coredns增加副本，增强高可用性（也可以修改配置文件）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl scale deployment coredns --replicas=2 -n kube-system
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>创建 kubernetes用户
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl create clusterrolebinding kube-apiserver:kubelet-apis \
--clusterrole=system:kubelet-api-admin --user kubernetes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>使用busybox测试解析是否正常

部署busybox
编写busybox编排文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; busybox.yaml &lt;&lt; EOF
apiVersion: v1
kind: Pod
metadata:
  name: busybox
  namespace: default
spec:
  containers:
  - name: busybox
    image: busybox:1.28.4
    command:
      - sleep
      - &quot;3600&quot;
    imagePullPolicy: IfNotPresent
  restartPolicy: Always
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>创建busybox
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl create -f busybox.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>进入busybox中
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl exec -it busybox -- sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>使用busybox测试coredns是否部署成功
If you don&#39;t see a command prompt, try pressing enter.
/ # ns
nsenter   nslookup
/ # nslookup kubernetes
Server:    10.0.0.2
Address 1: 10.0.0.2 kube-dns.kube-system.svc.cluster.local

查看coredns一共部署了几个副本
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get deployments -n kube-system
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@binary-k8s-master2 ~]# kubectl get deployments -n kube-system
NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
calico-kube-controllers   1/1     1            1           168m
coredns                   2/2     2            2           147m
</code></pre><h2 id="_8-13-增加master2节点" tabindex="-1"><a class="header-anchor" href="#_8-13-增加master2节点" aria-hidden="true">#</a> 8.13.增加Master2节点</h2><div class="custom-container danger"><p class="custom-container-title">特别特别注意</p><p>一定要先执行最开始的8.1章节公共步骤，如关闭防火墙等操作，否则是成功添加Master2节点的</p></div><h3 id="_8-13-1-kubernetes集群架构简介" tabindex="-1"><a class="header-anchor" href="#_8-13-1-kubernetes集群架构简介" aria-hidden="true">#</a> 8.13.1.Kubernetes集群架构简介</h3><pre><code>Kubernetes作为容器集群系统，通过健康检查+重启策略实现了Pod故障自我修复能力，通过调度算法
实现将Pod分布式部署，并保持预期副本数，根据Node失效状态自动在其他Node拉起Pod，实现了应用
层的高可用性。针对Kubernetes集群，高可用性还应包含以下两个层面的考虑：Etcd数据库的高可用
性和Kubernetes Master组件的高可用性。 而Etcd我们已经采用3个节点组建集群实现高可用，本
节将对Master节点高可用进行说明和实施。Master节点扮演着总控中心的角色，通过不断与工作节点
上的Kubelet和kube-proxy进行通信来维护整个集群的健康工作状态。如果Master节点故障，将无
法使用kubectl工具或者API做任何集群管理。Master节点有三个额外的组件，这个三个组件工作节
点kubeapiserver、kube-controller-manager和kube-scheduler，其中kube-controller-
manager和kube-scheduler组件自身通过选择机制已经实现了高可用，所以Master高可用主要针对
kube-apiserver组件，而该组件是以HTTP API提供服务，因此对他高可用与Web服务器类似，增加
负载均衡器对其负载均衡即可，并且可水平扩容。	

多主多从架构架构服务器规划	
</code></pre><table><thead><tr><th style="text-align:left;">角色</th><th style="text-align:left;">IP</th><th style="text-align:center;">组件</th></tr></thead><tbody><tr><td style="text-align:left;">binary-k8s-master1</td><td style="text-align:left;">192.168.0.9</td><td style="text-align:center;">etcd <br> docker <br> kube-apiserver kube-controller-manager kube-scheduler <br> kubelet kube-proxy <br> nginx keepalived</td></tr><tr><td style="text-align:left;">binary-k8s-master2</td><td style="text-align:left;">192.168.0.12</td><td style="text-align:center;">etcd <br> docker <br> kube-apiserver kube-controller-manager kube-scheduler <br> kubelet kube-proxy <br> nginx keepalived</td></tr><tr><td style="text-align:left;">binary-k8s-worker1</td><td style="text-align:left;">192.168.0.10</td><td style="text-align:center;">etcd <br> docker <br> kubelet kube-proxy</td></tr><tr><td style="text-align:left;">binary-k8s-worker2</td><td style="text-align:left;">192.168.0.11</td><td style="text-align:center;">etcd <br> docker <br> kubelet kube-proxy</td></tr><tr><td style="text-align:left;">负载均衡器(虚拟IP)</td><td style="text-align:left;">192.168.0.88</td><td style="text-align:center;"></td></tr></tbody></table><div class="custom-container tip"><p class="custom-container-title">特别说明</p><p>现在需要再增加一台新服务器，作为Master2 Node，IP是192.168.0.12。Master Node2 与已部署的 Master Node1所有操作一致。所以我们只需将Master1所有K8s文件拷贝过来，再修改下服务器IP和主机名 启动即可。</p></div><h3 id="_8-13-2-给master-node2安装docker" tabindex="-1"><a class="header-anchor" href="#_8-13-2-给master-node2安装docker" aria-hidden="true">#</a> 8.13.2.给Master Node2安装Docker</h3><pre><code>进入Master Node1，将docker安装文件拷贝到Master Node2
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>scp /usr/bin/docker* root@192.168.0.12:/usr/bin &amp;&amp;
scp /usr/bin/runc root@192.168.0.12:/usr/bin &amp;&amp;
scp /usr/bin/containerd* root@192.168.0.12:/usr/bin &amp;&amp;
scp /usr/lib/systemd/system/docker.service \
root@192.168.0.12:/usr/lib/systemd/system &amp;&amp;
scp -r /etc/docker root@192.168.0.12:/etc
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>启动Mater Node2上的Docker并设置开机自启
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl daemon-reload &amp;&amp; systemctl start docker &amp;&amp; systemctl enable docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看启动状态
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>	systemctl status docker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_8-13-5-给master-node2节点拷贝所有需要的证书" tabindex="-1"><a class="header-anchor" href="#_8-13-5-给master-node2节点拷贝所有需要的证书" aria-hidden="true">#</a> 8.13.5.给Master Node2节点拷贝所有需要的证书</h3><pre><code>在Master Node2上创建etcd证书目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mkdir -p /opt/etcd/ssl
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>在Master1上拷贝Master1上所有k8s文件和etcd证书到Master2
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>scp -r /opt/kubernetes root@192.168.0.12:/opt &amp;&amp;
scp -r /opt/etcd/ssl root@192.168.0.12:/opt/etcd &amp;&amp;
scp /usr/lib/systemd/system/kube* \
root@192.168.0.12:/usr/lib/systemd/system &amp;&amp;
scp /usr/bin/kubectl  root@192.168.0.12:/usr/bin &amp;&amp;
scp -r ~/.kube root@192.168.0.12:~
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>在Master Node2上删除旧的证书（删除kubelet和kubeconfig文件）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rm -f /opt/kubernetes/cfg/kubelet.kubeconfig &amp;&amp;
rm -f /opt/kubernetes/ssl/kubelet*
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>修改Master2修改配置文件和主机名
修改apiserver、kubelet和kube-proxy配置文件为本地IP
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>vi /opt/kubernetes/cfg/kube-apiserver.conf 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>...
--bind-address=192.168.0.12 \
--advertise-address=192.168.0.12 \
...

修改kube-controller-manager配置文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>vi /opt/kubernetes/cfg/kube-controller-manager.kubeconfig
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>server: https://192.168.0.12:6443

修改kube-scheduler配置文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>vi /opt/kubernetes/cfg/kube-scheduler.kubeconfig
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>server: https://192.168.0.12:6443
修改kubelet配置文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>vi /opt/kubernetes/cfg/kubelet.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>--hostname-override=binary-k8s-master2

修改kube-proxy配置文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>vi /opt/kubernetes/cfg/kube-proxy-config.yml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>hostnameOverride: binary-k8s-master2
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>vi ~/.kube/config
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>...
server: https://192.168.0.12:6443
</code></pre><h3 id="_8-13-6-启动master所有服务并设置开机自启" tabindex="-1"><a class="header-anchor" href="#_8-13-6-启动master所有服务并设置开机自启" aria-hidden="true">#</a> 8.13.6.启动Master所有服务并设置开机自启</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl daemon-reload &amp;&amp;
systemctl start kube-apiserver &amp;&amp;
systemctl start kube-controller-manager &amp;&amp;
systemctl start kube-scheduler &amp;&amp;
systemctl start kubelet kube-proxy &amp;&amp;
systemctl enable kube-apiserver &amp;&amp;
systemctl enable kube-controller-manager &amp;&amp;
systemctl enable kube-scheduler &amp;&amp;
systemctl enable kubelet &amp;&amp;
systemctl enable kube-proxy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-13-7-在master查看集群组件状态" tabindex="-1"><a class="header-anchor" href="#_8-13-7-在master查看集群组件状态" aria-hidden="true">#</a> 8.13.7.在Master查看集群组件状态</h3><pre><code>注意：如果上面操作无误则这一步就可以查看到集群中组件的运行状态了

查看组件状态
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get cs
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@localhost ~]# kubectl get cs
Warning: v1 ComponentStatus is deprecated in v1.19+
NAME                 STATUS    MESSAGE             ERROR
controller-manager   Healthy   ok 
scheduler            Healthy   ok   
etcd-2               Healthy   {&quot;health&quot;:&quot;true&quot;}
etcd-1               Healthy   {&quot;health&quot;:&quot;true&quot;}
etcd-0               Healthy   {&quot;health&quot;:&quot;true&quot;}
</code></pre><h3 id="_8-13-8-审批所有worker-node上的kubelet证书申请" tabindex="-1"><a class="header-anchor" href="#_8-13-8-审批所有worker-node上的kubelet证书申请" aria-hidden="true">#</a> 8.13.8.审批所有Worker Node上的kubelet证书申请</h3><pre><code>查看证书申请
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get csr
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@localhost ~]# kubectl get csr
NAME                                                   ... CONDITION ...
node-csr-Pkp1fPd9NZApJVRqRFlIIjskZ_gL_qDmcSWGvSuN-VQ   ... Pending	 ...

同意证书申请
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl certificate approve node-csr-Pkp1fPd9NZApJVRqRFlIIjskZ_gL_qDmcSWGvSuN-VQ
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>再次查看证书申请
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get csr
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@localhost ~]# kubectl get csr
NAME                                                  ... CONDITION 	  ...
node-csr-Pkp1fPd9NZApJVRqRFlIIjskZ_gL_qDmcSWGvSuN-VQ  ... Approved,Issued ...	

查看节点加入状态没等到所有pods状态都已经变为Running，执行下一步操作
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get pods -n kube-system
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@binary-k8s-master1 ~]# kubectl get pods -n kube-system
NAME                                      READY   STATUS     RESTARTS   AGE
calico-kube-controllers-bcc6f659f-7mf9n   1/1     Running    1          141m
calico-node-768sf                         1/1     Running    0          97m
calico-node-crhh4                         0/1     Init:2/3   0          2m7s
calico-node-hwbm9                         1/1     Running    0          98m
calico-node-vl4db                         1/1     Running    1          141m
coredns-7c878fc47b-n9nfd                  1/1     Running    0          75m
coredns-7c878fc47b-sxvz2                  1/1     Running    0          76m

查看Node
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get nodes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>binary-k8s-master1   Ready    &lt;none&gt;   153m   v1.20.0
binary-k8s-master2   Ready    &lt;none&gt;   17m    v1.20.0
binary-k8s-worker1   Ready    &lt;none&gt;   142m   v1.20.0
binary-k8s-worker2   Ready    &lt;none&gt;   141m   v1.20.0

至此一个双Master节点k8s集群已经部署完毕，再添加新的Master节点步骤和上面的是相同的
</code></pre><h2 id="_8-14-部署nginx-keepalived高可用负载均衡器" tabindex="-1"><a class="header-anchor" href="#_8-14-部署nginx-keepalived高可用负载均衡器" aria-hidden="true">#</a> 8.14.部署Nginx+Keepalived高可用负载均衡器</h2><h3 id="_8-14-1-nginx和keepalived简介" tabindex="-1"><a class="header-anchor" href="#_8-14-1-nginx和keepalived简介" aria-hidden="true">#</a> 8.14.1.Nginx和Keepalived简介</h3><pre><code>Nginx是一个主流Web服务和反向代理服务器，这里用四层实现对apiserver实现负载均衡。Keepalived是一个主流高可
用软件，基于VIP绑定实现服务器双机热备，在上述拓扑中，Keepalived主要根据Nginx运行状态判断是否需要故障转移
（漂移VIP），例如当Nginx主节点挂掉，VIP会自动绑定在Nginx备节点，从而保证VIP一直可用，实现Nginx高可用。
如果你是在公有云上，一般都不支持keepalived，那么你可以直接用它们的负载均衡器产品，直接负载均衡多台Master 
kube-apiserver，架构与上面一样。
</code></pre><h3 id="_8-14-2-在两台master-node上安装软件" tabindex="-1"><a class="header-anchor" href="#_8-14-2-在两台master-node上安装软件" aria-hidden="true">#</a> 8.14.2.在两台Master Node上安装软件</h3><pre><code>下载nginx和keepalived
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum install epel-release -y &amp;&amp;
yum install nginx keepalived -y
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>Nginx配置文件（Master Node1和Master Node2相同）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /etc/nginx/nginx.conf &lt;&lt; &quot;EOF&quot;
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
}

stream {

    log_format main &#39;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#39;;

    access_log  /var/log/nginx/k8s-access.log  main;

    upstream k8s-apiserver {
       server 192.168.0.9:6443;   # Master1 APISERVER IP:PORT
       server 192.168.0.12:6443;   # Master2 APISERVER IP:PORT
    }
    
    server {
       listen 16443; # 由于nginx与master节点复用，这个监听端口不能是6443，否则会冲突
       proxy_pass k8s-apiserver;
    }
}

http {
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;

    include             /etc/nginx/mime.types;
    default_type        application/octet-stream;

    server {
        listen       80 default_server;
        server_name  _;

        location / {
        }
    }
}
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>Master Node1上的keepalived配置文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF
global_defs { 
   notification_email { 
     acassen@firewall.loc 
     failover@firewall.loc 
     sysadmin@firewall.loc 
   } 
   notification_email_from Alexandre.Cassen@firewall.loc  
   smtp_server 127.0.0.1 
   smtp_connect_timeout 30 
   router_id NGINX_MASTER
} 

vrrp_script check_nginx {
    script &quot;/etc/keepalived/check_nginx.sh&quot;
}

vrrp_instance VI_1 { 
    state MASTER 
    interface ens33  # 修改为实际网卡名
    virtual_router_id 51 # VRRP 路由 ID实例，每个实例是唯一的 
    priority 100    # 优先级，备服务器设置 90 
    advert_int 1    # 指定VRRP 心跳包通告间隔时间，默认1秒 
    authentication { 
        auth_type PASS      
        auth_pass 1111 
    }  
    # 虚拟IP
    virtual_ipaddress { 
        192.168.0.88/24
    } 
    track_script {
        check_nginx
    } 
}
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​ ​ Master Node2的keepalived配置文件</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF
global_defs { 
   notification_email { 
     acassen@firewall.loc 
     failover@firewall.loc 
     sysadmin@firewall.loc 
   } 
   notification_email_from Alexandre.Cassen@firewall.loc  
   smtp_server 127.0.0.1 
   smtp_connect_timeout 30 
   router_id NGINX_BACKUP
} 

vrrp_script check_nginx {
    script &quot;/etc/keepalived/check_nginx.sh&quot;
}

vrrp_instance VI_1 { 
    state BACKUP 
    interface ens33
    virtual_router_id 51 # VRRP 路由 ID实例，每个实例是唯一的 
    priority 90
    advert_int 1
    authentication { 
        auth_type PASS      
        auth_pass 1111 
    }  
    virtual_ipaddress { 
        192.168.0.88/24
    } 
    track_script {
        check_nginx
    } 
}
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>配置说明
​vrrp_script：指定检查nginx工作状态脚本（根据nginx状态判断是否故障转移）
​virtual_ipaddress：虚拟IP（VIP）
​
​准备上述配置文件中检查nginx运行状态的脚本（Master Node1和Master Node2相同）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cat &gt; /etc/keepalived/check_nginx.sh  &lt;&lt; &quot;EOF&quot;
#!/bin/bash
count=$(ss -antp |grep 16443 |egrep -cv &quot;grep|$$&quot;)

if [ &quot;$count&quot; -eq 0 ];then
    exit 1
else
    exit 0
fi
EOF

chmod +x /etc/keepalived/check_nginx.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​ 配置说明 ​ keepalived根据脚本返回状态码（0为工作正常，非0不正常）判断是否故障转移。</p><h3 id="_8-14-3-nginx增加steam模块" tabindex="-1"><a class="header-anchor" href="#_8-14-3-nginx增加steam模块" aria-hidden="true">#</a> 8.14.3.Nginx增加Steam模块</h3><h4 id="_8-14-3-1-查看nginx版本模块" tabindex="-1"><a class="header-anchor" href="#_8-14-3-1-查看nginx版本模块" aria-hidden="true">#</a> 8.14.3.1.查看Nginx版本模块</h4><pre><code>nginx -V
注意：如果已经安装 --with-stream模块,后面的步骤可以跳过
</code></pre><h4 id="_8-14-3-2-master1和master2安装stream模块" tabindex="-1"><a class="header-anchor" href="#_8-14-3-2-master1和master2安装stream模块" aria-hidden="true">#</a> 8.14.3.2.Master1和Master2安装Stream模块</h4><pre><code>备份Master Node1和Master Node2上原来的Nginx文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>mv /usr/sbin/nginx /usr/sbin/nginx.bak &amp;&amp;
cp -r /etc/nginx{,.bak}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>切换目录并在该目录中下载nginx（注意这里下载的nginx版本要和之前nginx -v查看的版本保持一致，这里我们之前已经下载
好了，存放在Master Node1上，直接使用就可以了）

在Master Node1上切换目录
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd /opt/k8s/package/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>Master Node1编译环境准备
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>yum -y install libxml2 libxml2-dev libxslt-devel 
yum -y install gd-devel 
yum -y install perl-devel perl-ExtUtils-Embed 
yum -y install GeoIP GeoIP-devel GeoIP-data
yum -y install pcre-devel
yum -y install openssl openssl-devel
yum -y install gcc make
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>编译nginx，加上本次需新增的模块: --with-stream
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>tar -xf nginx-1.20.1.tar.gz
cd nginx-1.20.1/
./configure --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx \
--modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf  --with-stream
make
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>说明:
make完成后不要继续输入“make install”，以免现在的nginx出现问题
以上完成后，会在objs目录下生成一个nginx文件，先验证
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>./objs/nginx -t
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@binary-k8s-master1 nginx-1.20.1]# ./objs/nginx -t
nginx: [alert] could not open error log file: open() &quot;/usr/share/nginx/logs/error.log&quot; failed (2: No such file or directory)
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful

替换nginx到Master1/Master2
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cp ./objs/nginx /usr/sbin/ &amp;&amp;
scp objs/nginx root@192.168.0.12:/usr/sbin/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>修改nginx服务文件（Master Node1和Master Node2）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rm -rf /usr/lib/systemd/system/nginx.service &amp;&amp;
cat &gt;&gt; /usr/lib/systemd/system/nginx.service &lt;&lt; EOF
[Unit]
Description=The nginx HTTP and reverse proxy server
After=network.target remote-fs.target nss-lookup.target
[Service]
Type=forking
PIDFile=/run/nginx.pid
ExecStartPre=/usr/bin/rm -rf /run/nginx.pid
ExecStartPre=/usr/sbin/nginx -t
ExecStart=/usr/sbin/nginx
ExecStop=/usr/sbin/nginx -s stop
ExecReload=/usr/sbin/nginx -s reload
PrivateTmp=true
[Install]
WantedBy=multi-user.target
EOF
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-14-4-启动nginx、keepalived并设置开机自启-master1-master2" tabindex="-1"><a class="header-anchor" href="#_8-14-4-启动nginx、keepalived并设置开机自启-master1-master2" aria-hidden="true">#</a> 8.14.4.启动nginx、keepalived并设置开机自启(master1/master2)</h3><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl daemon-reload &amp;&amp;
systemctl start nginx keepalived &amp;&amp;
systemctl enable nginx keepalived
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-14-5-查看keepalived工作状态" tabindex="-1"><a class="header-anchor" href="#_8-14-5-查看keepalived工作状态" aria-hidden="true">#</a> 8.14.5.查看keepalived工作状态</h3><pre><code>查看Master1网卡详细信息
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ip addr
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@binary-k8s-master1 ~]# ip addr
...
2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast 
		  state UP group default qlen 1000
    link/ether 00:0c:29:8d:76:8c brd ff:ff:ff:ff:ff:ff
    inet 192.168.0.9/24 brd 192.168.0.255 scope global noprefixroute ens33
       valid_lft forever preferred_lft forever
    inet 192.168.0.88/24 scope global ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::5c3d:f3b3:1254:f87b/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
...

查看Master2网卡详细信息
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ip addr
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@binary-k8s-master1 ~]# ip addr
...
2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state 
		 UP group default qlen 1000
    link/ether 00:50:56:2d:95:d6 brd ff:ff:ff:ff:ff:ff
    inet 192.168.0.12/24 brd 192.168.0.255 scope global noprefixroute ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::fe5b:93a6:43c0:3e2e/64 scope link tentative 
	    noprefixroute dadfailed 
       valid_lft forever preferred_lft forever
    inet6 fe80::5c3d:f3b3:1254:f87b/64 scope link tentative 
	    noprefixroute dadfailed 
       valid_lft forever preferred_lft forever
    inet6 fe80::7bd2:e647:9e81:ef45/64 scope link tentative
	     noprefixroute dadfailed 
       valid_lft forever preferred_lft forever
...

如何确定是否配置成功
可以看到，在Master1上的ens33网卡绑定了192.168.242.55 虚拟IP，说明工作正常。
inet 192.168.242.55/24 scope global ens33，而Master2上的ens33网卡没有绑定虚拟IP
</code></pre><h3 id="_8-14-6-nginx-keepalived高可用测试" tabindex="-1"><a class="header-anchor" href="#_8-14-6-nginx-keepalived高可用测试" aria-hidden="true">#</a> 8.14.6.Nginx+keepalived高可用测试</h3><pre><code>在主节点Master Node1节点执行关闭nginx
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>pkill nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查看虚拟IP是否漂移到备节点服务器（Master Node2）
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>ip addr
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@binary-k8s-master1 ~]# ip addr
...
2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast 
	state UP group default qlen 1000
link/ether 00:50:56:2d:95:d6 brd ff:ff:ff:ff:ff:ff
inet 192.168.0.12/24 brd 192.168.0.255 scope global noprefixroute ens33
   valid_lft forever preferred_lft forever
inet 192.168.0.88/24 scope global ens33
   valid_lft forever preferred_lft forever
inet6 fe80::fe5b:93a6:43c0:3e2e/64 scope link tentative 
    noprefixroute dadfailed valid_lft forever preferred_lft forever
inet6 fe80::5c3d:f3b3:1254:f87b/64 scope link tentative 
    noprefixroute dadfailed valid_lft forever preferred_lft forever
inet6 fe80::7bd2:e647:9e81:ef45/64 scope link tentative 
    noprefixroute dadfailed valid_lft forever preferred_lft forever
...

如何确定虚拟IP是否发生飘移
可以看到，在Master2上的ens33网卡绑定了192.168.242.55 虚拟IP，说明工作正常。

测试完成后重新启动Master Node1上的nginx
systemctl start nginx
</code></pre><h3 id="_8-14-7-测试负载均衡器" tabindex="-1"><a class="header-anchor" href="#_8-14-7-测试负载均衡器" aria-hidden="true">#</a> 8.14.7.测试负载均衡器</h3><pre><code>找K8s集群中任意一个节点，使用curl查看K8s版本测试，使用VIP访问
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>curl -k https://192.168.0.88:16443/version
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>Master Node1机器
[root@binary-k8s-master1 ~]# curl -k https://192.168.0.88:16443/version
{
  &quot;major&quot;: &quot;1&quot;,
  &quot;minor&quot;: &quot;20&quot;,
  &quot;gitVersion&quot;: &quot;v1.20.10&quot;,
  &quot;gitCommit&quot;: &quot;8152330a2b6ca3621196e62966ef761b8f5a61bb&quot;,
  &quot;gitTreeState&quot;: &quot;clean&quot;,
  &quot;buildDate&quot;: &quot;2021-08-11T18:00:37Z&quot;,
  &quot;goVersion&quot;: &quot;go1.15.15&quot;,
  &quot;compiler&quot;: &quot;gc&quot;,
  &quot;platform&quot;: &quot;linux/amd64&quot;
}

Master Node2机器
[root@binary-k8s-master2 ~]# curl -k https://192.168.0.88:16443/version
{
  &quot;major&quot;: &quot;1&quot;,
  &quot;minor&quot;: &quot;20&quot;,
  &quot;gitVersion&quot;: &quot;v1.20.10&quot;,
  &quot;gitCommit&quot;: &quot;8152330a2b6ca3621196e62966ef761b8f5a61bb&quot;,
  &quot;gitTreeState&quot;: &quot;clean&quot;,
  &quot;buildDate&quot;: &quot;2021-08-11T18:00:37Z&quot;,
  &quot;goVersion&quot;: &quot;go1.15.15&quot;,
  &quot;compiler&quot;: &quot;gc&quot;,
  &quot;platform&quot;: &quot;linux/amd64&quot;
}

Worker Node1机器
[root@binary-k8s-worker1 ~]# curl -k https://192.168.0.88:16443/version
{
  &quot;major&quot;: &quot;1&quot;,
  &quot;minor&quot;: &quot;20&quot;,
  &quot;gitVersion&quot;: &quot;v1.20.10&quot;,
  &quot;gitCommit&quot;: &quot;8152330a2b6ca3621196e62966ef761b8f5a61bb&quot;,
  &quot;gitTreeState&quot;: &quot;clean&quot;,
  &quot;buildDate&quot;: &quot;2021-08-11T18:00:37Z&quot;,
  &quot;goVersion&quot;: &quot;go1.15.15&quot;,
  &quot;compiler&quot;: &quot;gc&quot;,
  &quot;platform&quot;: &quot;linux/amd64&quot;
}

Worker Node2机器
[root@binary-k8s-worker2 ~]# curl -k https://192.168.0.88:16443/version
{
  &quot;major&quot;: &quot;1&quot;,
  &quot;minor&quot;: &quot;20&quot;,
  &quot;gitVersion&quot;: &quot;v1.20.10&quot;,
  &quot;gitCommit&quot;: &quot;8152330a2b6ca3621196e62966ef761b8f5a61bb&quot;,
  &quot;gitTreeState&quot;: &quot;clean&quot;,
  &quot;buildDate&quot;: &quot;2021-08-11T18:00:37Z&quot;,
  &quot;goVersion&quot;: &quot;go1.15.15&quot;,
  &quot;compiler&quot;: &quot;gc&quot;,
  &quot;platform&quot;: &quot;linux/amd64&quot;
}

如何确定负载均衡器是否搭建正常
如果所有节点可以正确获取到K8s版本信息，说明负载均衡器搭建正常。
该请求数据流程：curl -&gt; vip(nginx) -&gt; apiserver

通过查看Nginx日志也可以看到转发apiserver IP：
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>tailf /var/log/nginx/k8s-access.log
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@binary-k8s-master1 ~]# tailf /var/log/nginx/k8s-access.log 
192.168.242.55 192.168.0.9:6443 - [26/Jul/2022:01:28:51 -0400] 200 428
192.168.211.128 192.168.0.9:6443 - [26/Jul/2022:01:28:58 -0400] 200 428
192.168.95.192 192.168.0.12:6443 - [26/Jul/2022:01:30:12 -0400] 200 428
192.168.63.192 192.168.0.9:6443 - [26/Jul/2022:01:30:14 -0400] 200 428
192.168.242.55 192.168.0.9:6443 - [26/Jul/2022:01:30:36 -0400] 200 428
192.168.242.55 192.168.0.12:6443 - [26/Jul/2022:01:30:42 -0400] 200 428
</code></pre><h3 id="_8-14-8-修改所有的worker-node连接lb-vip" tabindex="-1"><a class="header-anchor" href="#_8-14-8-修改所有的worker-node连接lb-vip" aria-hidden="true">#</a> 8.14.8.修改所有的Worker Node连接LB VIP</h3><pre><code>为什么要改为连接LB VIP
试想下，虽然我们增加了Master2 Node和负载均衡器，但是我们是从单Master架构扩容的，也就是
说目前所有的Worker Node组件连接都还是Master1 Node，如果不改为连接VIP走负载均衡器，那么
Master还是单点故障。因此接下来就是要改所有Worker Node（kubectl get node命令查看到的节
点）组件配置文件，由原来192.168.0.9修改为192.168.242.55（VIP）。

在所有Worker Node执行
注意事项
这里除了Worker Node1和Worker Node2，Master Node1和Master Node2这两个节点也充当了Worker Node，所以所有的四个节点
上都要执行下面的命令
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>sed -i &#39;s#192.168.0.9:6443#192.168.0.88:16443#&#39; /opt/kubernetes/cfg/* &amp;&amp;
systemctl restart kubelet kube-proxy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>检查节点状态
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get nodes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>[root@binary-k8s-master1 cfg]# kubectl get nodes
NAME                 STATUS   ROLES    AGE     VERSION
binary-k8s-master1   Ready    &lt;none&gt;   5h13m   v1.20.0
binary-k8s-master2   Ready    &lt;none&gt;   177m    v1.20.0
binary-k8s-worker1    Ready    &lt;none&gt;   5h1m    v1.20.0
binary-k8s-worker2    Ready    &lt;none&gt;   5h1m    v1.20.0

为了确保配置成功，重启集群中所有机器，再次在Master Node1和Master Node2中查看节点状态，如一切部署无误结果如下所示
[root@binary-k8s-master1 cfg]# kubectl get nodes
NAME                 STATUS   ROLES    AGE     VERSION
binary-k8s-master1   Ready    &lt;none&gt;   5h13m   v1.20.0
binary-k8s-master2   Ready    &lt;none&gt;   177m    v1.20.0
binary-k8s-worker1    Ready    &lt;none&gt;   5h1m    v1.20.0
binary-k8s-worker2    Ready    &lt;none&gt;   5h1m    v1.20.0

至此,一套高可用的k8s二进制可用集群就部署完成了~
^_^
</code></pre><h2 id="_8-15-部署常见问题" tabindex="-1"><a class="header-anchor" href="#_8-15-部署常见问题" aria-hidden="true">#</a> 8.15.部署常见问题</h2><h3 id="_8-15-1系统断电后-某个etcd节点无法启动" tabindex="-1"><a class="header-anchor" href="#_8-15-1系统断电后-某个etcd节点无法启动" aria-hidden="true">#</a> 8.15.1系统断电后,某个etcd节点无法启动</h3><pre><code>报错信息
publish error: etcdserver: request timed out

解决方法(如果没有重要数据,或者刚进行完初始化)
检查日志发现并没有特别明显的错误，根据经验来讲，etcd 节点坏掉一个其实对集群没有大的影响，
这时集群已经可以正常使用了，但是这个坏掉的 etcd 节点并没有启动

#进入 etcd 的数据存储目录进行备份 备份原有数据：
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>cd /var/lib/etcd/default.etcd/member/ &amp;&amp;
cp * /data/bak/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>#删除这个目录下的所有数据文件
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>rm -rf /var/lib/etcd/default.etcd/member/*
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>#停止另外两台 etcd 节点，因为 etcd 节点启动时需要所有节点一起启动，启动成功后即可使用。
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>systemctl stop etcd &amp;&amp;
systemctl restart etcd
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-15-2-the-connection-to-the-server-localhost-8080-was-refused-did-you-specify-the-right-host-or-port" tabindex="-1"><a class="header-anchor" href="#_8-15-2-the-connection-to-the-server-localhost-8080-was-refused-did-you-specify-the-right-host-or-port" aria-hidden="true">#</a> 8.15.2 The connection to the server localhost:8080 was refused - did you specify the right host or port?</h3><pre><code>8.10.使用kubectl查看集群状态章节没有正确执行会报这个错
</code></pre><h2 id="_8-16-部署测试程序" tabindex="-1"><a class="header-anchor" href="#_8-16-部署测试程序" aria-hidden="true">#</a> 8.16.部署测试程序</h2><pre><code>创建guestbook
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl create deployment guestbook --image=ibmcom/guestbook:v1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查询pod运行状态，状态应该显示为Running表示pod运行成功
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get pods
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>对外暴露端口
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl expose deployment guestbook --type=NodePort --port=3000
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>查询端口映射
</code></pre><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>kubectl get service guestbook
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>NAME        TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
guestbook   NodePort   10.10.10.253   &lt;none&gt;        3000:31208/TCP   1m

访问服务（主节点和两个工作节点都可访问到这个服务）
http://192.168.0.6:31208
http://192.168.0.7:31208
http://192.168.0.8:31208
</code></pre></div><!----><footer class="page-meta"><!----><div class="meta-item update-time"><span class="label">上次编辑于: </span><span class="info">2022/7/31 20:57:39</span></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: LRwq942133">lingwh</span><!--]--><!--]--></div></footer><!----><div class="giscus-wrapper input-top" style="display:block;"><div style="text-align:center">Loading...</div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">Copyright 2021 © <a href='https://github.com/lingwh1995' target='_blank'>lingwh</a></div><!----></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.9b9d0ec1.js" defer></script>
  </body>
</html>
