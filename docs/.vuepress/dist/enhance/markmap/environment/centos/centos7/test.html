<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.28.0/themes/prism.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.13.5/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.7.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.13.5"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.13.5/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root, jsonOptions) => {
        const markmap = getMarkmap();
        window.mm = markmap.Markmap.create('svg#mindmap', (getOptions || markmap.deriveOptions)(jsonOptions), root);
      })(() => window.markmap,null,{"type":"root","depth":0,"content":"","children":[{"type":"paragraph","depth":1,"payload":{"lines":[0,1]},"content":"@include(@src/public/enhance/guidance/environment/centos/centos7/centos7-guidance.md)"},{"type":"heading","depth":1,"payload":{"lines":[2,3]},"content":"1.安装Linux操作系统 {#1.}","children":[{"type":"fence","depth":2,"content":"<pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">//@include(./Account.java)</span>\n</code></pre>\n"},{"type":"heading","depth":2,"payload":{"lines":[8,9]},"content":"<a href=\"#\">1.1.Linux重要目录介绍</a>"},{"type":"heading","depth":2,"payload":{"lines":[22,23]},"content":"1.4.Centos镜像下载"},{"type":"heading","depth":2,"payload":{"lines":[26,27]},"content":"1.5.安装前Vmaware相关设置"},{"type":"heading","depth":2,"payload":{"lines":[39,40]},"content":"1.5.安装时分区大小设置"}]},{"type":"heading","depth":1,"payload":{"lines":[44,45]},"content":"2.Linux操作系统初始设置 {#2.}","children":[{"type":"heading","depth":2,"payload":{"lines":[47,48]},"content":"2.3.配置静态IP地址","children":[{"type":"fence","depth":3,"content":"<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">vi</span> /etc/sysconfig/network-scripts/ifcfg-ens32<span class=\"token punctuation\">(</span>最后一个为网卡名称<span class=\"token punctuation\">)</span>    \n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>systemctl restart network\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[67,68]},"content":"2.4.解决远程连接无法连接的问题","children":[{"type":"fence","depth":3,"content":"<pre><code>vim /etc/ssh/sshd_config\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>systemctl restart sshd.service\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[78,79]},"content":"2.5.设置系统环境变量","children":[{"type":"fence","depth":3,"content":"<pre><code>echo &quot;export LC_ALL=en_US.UTF-8&quot;  &gt;&gt;  /etc/profile &amp;&amp;\nsource /etc/profile\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[84,85]},"content":"2.6.安装curl","children":[{"type":"fence","depth":3,"content":"<pre><code>yum -y install curl\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[90,91]},"content":"2.7.配置yml源","children":[{"type":"fence","depth":3,"content":"<pre><code>curl http://mirrors.aliyun.com/repo/Centos-7.repo -o Centos-7.repo\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>cd /etc/yum.repos.d &amp;&amp; cp CentOS-Base.repo CentOS-Base.repo.bak\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>cp /opt/software/package/Centos-7.repo /CentOS-Base.repo\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>yum makecache &amp;&amp; yum update\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[108,109]},"content":"2.8.安装常用基础系统软件","children":[{"type":"heading","depth":3,"payload":{"lines":[109,110]},"content":"2.8.1.手动安装常用软件","children":[{"type":"fence","depth":4,"content":"<pre><code>yum -y install vim*\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>yum -y install wget\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>yum -y install telnet\nyum -y install telnet-server\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>yum remove git\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>yum install -y git\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>git version \n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[145,146]},"content":"2.8.2.使用脚本安装常用软件","children":[{"type":"fence","depth":4,"content":"<pre><code>yum -y install curl\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>curl https://gitee.com/lingwh1995/config-center/raw/master/centos/centos-init.sh -o centos-init.sh\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>chmod +x centos-init.sh &amp;&amp;\n./centos-init.sh\n</code></pre>\n"}]}]}]},{"type":"heading","depth":1,"payload":{"lines":[164,165]},"content":"3.搭建基础开发环境 {#3.}","children":[{"type":"heading","depth":2,"payload":{"lines":[167,168]},"content":"3.3.安装jdk","children":[{"type":"fence","depth":3,"content":"<pre><code>yum list installed | grep java\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>yum -y remove xxx\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>mkdir -p /opt/software/package &amp;&amp;\ncd /opt/software/package &amp;&amp;\ncurl -fL -u software-1659088335906:c2e556a8a52386cbe0c6361ee3a7d8a21d3c9ca0 \\\n&quot;https://lingwh-generic.pkg.coding.net/coding-drive/software/jdk-8u181-linux-x64.tar.gz?\\\nversion=latest&quot; -o jdk-8u181-linux-x64.tar.gz\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>tar -zxvf jdk-8u181-linux-x64.tar.gz &amp;&amp;\nchmod +x jdk1.8.0_181\nmv jdk1.8.0_181 /usr/local/bin/jdk1.8.0_181\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>vim /etc/profile\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>export JAVA_HOME=/usr/local/bin/jdk1.8.0_181\nexport JRE_HOME=${JAVA_HOME}/jre\nexport CLASSPATH=.:${JAVA_HOME}/lib:${JRE_HOME}/lib\nexport PATH=${JAVA_HOME}/bin:$PATH\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>source /etc/profile \n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>java -version\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[211,212]},"content":"3.4.安装maven","children":[{"type":"fence","depth":3,"content":"<pre><code>mkdir -p /opt/software/package &amp;&amp;\ncd /opt/software/package &amp;&amp;\ncurl -fL -u software-1659088796431:ba211676fbe4a719c3b40b22083cd70388d41acc \\\n&quot;https://lingwh-generic.pkg.coding.net/coding-drive/software/apache-maven-3.8.6-bin.tar.gz\\\n?version=latest&quot; -o apache-maven-3.8.6-bin.tar.gz\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>tar -zxvf apache-maven-3.8.6-bin.tar.gz -C /usr/local/bin\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>vim  /etc/profile\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>export M2_HOME=/usr/local/bin/apache-maven-3.8.6\nexport PATH=$PATH:$M2_HOME/bin\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>source /etc/profile\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>mvn -v\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>vim /usr/local/bin/apache-maven-3.8.6/conf/settings.xml\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>&lt;mirror&gt;\n    &lt;id&gt;alimaven&lt;/id&gt;\n    &lt;name&gt;aliyun maven&lt;/name&gt;\n    &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;\n    &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;\n&lt;/mirror&gt;   \n&lt;mirror&gt;\n    &lt;id&gt;repo2&lt;/id&gt;\n    &lt;name&gt;Mirror from Maven Repo2&lt;/name&gt;\n    &lt;url&gt;http://repo2.maven.org/maven2/&lt;/url&gt;\n    &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;\n&lt;/mirror&gt;\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[265,266]},"content":"3.5.安装mysql","children":[{"type":"fence","depth":3,"content":"<pre><code>yum list installed | grep mysql\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>rpm -qa | grep mysql\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>yum -y remove xxx\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>cd /opt/software/package &amp;&amp;\nwget https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>rpm -Uvh mysql80-community-release-el7-3.noarch.rpm\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>rpm -ivh mysql80-community-release-el7-3.noarch.rpm\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>ls /etc/yum.repos.d\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>sed -i 's#file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql#https://repo.mysql.com/\\\nRPM-GPG-KEY-mysql-2022#g' /etc/yum.repos.d/mysql-community.repo\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>yum -y install mysql-community-server\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>systemctl start mysqld.service &amp;&amp;\nsystemctl enable mysqld.service\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>systemctl status mysqld\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>mysqld --initialize\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>cat /var/log/mysqld.log | grep 'temporary password'\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>mysql -uroot -p'%)4(26e++jaK'\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>ALTER USER USER() IDENTIFIED BY 'Mysql123456_';\nFLUSH PRIVILEGES;\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>use mysql;  \nupdate user set host='%' where user='root';\nflush privileges;\n</code></pre>\n"}]}]},{"type":"heading","depth":1,"payload":{"lines":[358,359]},"content":"4.Centos搭建docker {#4.}","children":[{"type":"heading","depth":2,"payload":{"lines":[360,361]},"content":"4.3.安装docker","children":[{"type":"heading","depth":3,"payload":{"lines":[361,362]},"content":"4.3.1.在线安装docker","children":[{"type":"fence","depth":4,"content":"<pre><code>yum -y update\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>yum list installed | grep docker\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>yum -y remove docker-ce.x86_64\nyum -y remove docker-scan-plugin.x86_64\nyum -y remove docker-ce-cli.x86_64\nyum -y remove docker-ce-rootless-extras.x86_64_64\nyum -y remove containerd.io.x86_64\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>yum install -y yum-utils device-mapper-persistent-data lvm2\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>yum list docker-ce --showduplicates | sort -r\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>yum -y install docker-ce\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>docker version\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>vim /etc/docker/daemon.json\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>sudo mkdir -p /etc/docker &amp;&amp;\nsudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'\n{\n    &quot;registry-mirrors&quot;: [\n        &quot;https://5pfmrxk8.mirror.aliyuncs.com&quot;,\n        &quot;http://hub-mirror.c.163.com&quot;,\n        &quot;https://docker.mirrors.ustc.edu.cn&quot;,\n        &quot;https://registry.docker-cn.com&quot;\n    ]\n}\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>systemctl daemon-reload &amp;&amp;\nsystemctl start docker &amp;&amp;\nsystemctl enable docker\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>systemctl status docker\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>systemctl status docker\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>docker run hello-world\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[473,474]},"content":"4.3.2.二进制包安装docker","children":[{"type":"fence","depth":4,"content":"<pre><code>mkdir -p  /opt/software/package/ &amp;&amp;\ncd /opt/software/package/ &amp;&amp;\ncurl -fL -u software-1659095503164:3316a6a052e6f17880d37a00d38454342aceffdf \\\n&quot;https://lingwh-generic.pkg.coding.net/coding-drive/software/docker-20.10.9.tgz?version=latest&quot; \\\n-o docker-20.10.9.tgz &amp;&amp;\ntar -xf docker-20.10.9.tgz &amp;&amp; mv docker/* /usr/bin/\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>sudo mkdir -p /etc/docker &amp;&amp;\nsudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'\n{\n    &quot;registry-mirrors&quot;: [\n        &quot;https://5pfmrxk8.mirror.aliyuncs.com&quot;,\n        &quot;http://hub-mirror.c.163.com&quot;,\n        &quot;https://docker.mirrors.ustc.edu.cn&quot;,\n        &quot;https://registry.docker-cn.com&quot;\n    ]\n}\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF\n[Unit]\nDescription=Docker Application Container Engine\nDocumentation=https://docs.docker.com\nAfter=network-online.target firewalld.service\nWants=network-online.target\n \n[Service]\nType=notify\nExecStart=/usr/bin/dockerd\nExecReload=/bin/kill -s HUP $MAINPID\nLimitNOFILE=infinity\nLimitNPROC=infinity\nTimeoutStartSec=0\nDelegate=yes\nKillMode=process\nRestart=on-failure\nStartLimitBurst=3\nStartLimitInterval=60s\n \n[Install]\nWantedBy=multi-user.target\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>systemctl daemon-reload &amp;&amp;\nsystemctl start docker &amp;&amp;\nsystemctl enable docker\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>systemctl status docker\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>systemctl status docker\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>docker run hello-world\n</code></pre>\n"}]}]},{"type":"heading","depth":2,"payload":{"lines":[572,573]},"content":"4.4.docker启动故障解决","children":[{"type":"fence","depth":3,"content":"<pre><code>systemctl stop docker\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>firewall-cmd --zone=trusted --remove-interface=docker0 --permanent\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>firewall-cmd --reload\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>systemctl restart firewalld\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>systemctl restart docker\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>    cat /etc/docker/daemon.json\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[604,605]},"content":"4.5.docker容器可视化","children":[{"type":"fence","depth":3,"content":"<pre><code>docker search portainer\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>docker pull portainer/portainer:1.24.2\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>docker run -d --name portainer \\\n    -p 9000:9000 \\\n    --restart=always \\\n    -v /var/run/docker.sock:/var/run/docker.sock \\\n    --privileged=true \\\n    portainer/portainer:1.24.2\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[627,628]},"content":"4.6.搭建docke私服"},{"type":"heading","depth":2,"payload":{"lines":[628,629]},"content":"4.6.1搭建docke官方私服（不带有用户名和密码校验）","children":[{"type":"fence","depth":3,"content":"<pre><code>docker pull registry\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>docker run -d --name registry_official \\\n    -p 5000:5000 \\\n    --restart=always \\\n    -v /registry/public/repos:/var/lib/registry \\\n    --privileged=true \\\n    registry\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>    vim /etc/docker/daemon.json\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>{\n    &quot;insecure-registries&quot;:[&quot;192.168.0.4:5000&quot;,&quot;192.168.0.4:5001&quot;],\n    &quot;registry-mirrors&quot;: [\n            &quot;https://5pfmrxk8.mirror.aliyuncs.com&quot;,\n            &quot;http://hub-mirror.c.163.com&quot;,\n            &quot;https://docker.mirrors.ustc.edu.cn&quot;,\n            &quot;https://registry.docker-cn.com&quot;,\n            &quot;http://192.168.0.4:5000&quot;,\n            &quot;http://192.168.0.4:5001&quot;\n    ]\n}\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>sudo mkdir -p /etc/docker &amp;&amp;\nsudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'\n{\n    &quot;insecure-registries&quot;:[&quot;192.168.0.4:5000&quot;,&quot;192.168.0.4:5001&quot;],\n    &quot;registry-mirrors&quot;: [\n            &quot;https://5pfmrxk8.mirror.aliyuncs.com&quot;,\n            &quot;http://hub-mirror.c.163.com&quot;,\n            &quot;https://docker.mirrors.ustc.edu.cn&quot;,\n            &quot;https://registry.docker-cn.com&quot;,\n            &quot;http://192.168.0.4:5000&quot;,\n            &quot;http://192.168.0.4:5001&quot;\n    ]\n}\nEOF\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>firewall-cmd --permanent --add-port=5000/tcp &amp;&amp;\nfirewall-cmd --reload\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>systemctl daemon-reload &amp;&amp; \nsystemctl restart docker\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>rm -rf /registry/public/repos/docker/registry/v2/repositories/springcloud-eureka/\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[707,708]},"content":"4.6.2搭建docke官方私服（带有用户名和密码校验）","children":[{"type":"fence","depth":3,"content":"<pre><code>docker pull registry\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>mkdir -p /opt/docker/auth/\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>yum -y install httpd\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>htpasswd -Bbn docker 123456  &gt;/opt/docker/auth/htpasswd\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>docker run -d --name registry_official_auth  \\\n    -p 5000:5000 --restart=always \\\n    -v `pwd`/opt/docker/auth:/opt/docker/auth  \\\n    -v /opt/docker/registry:/var/lib/registry  \\\n    -e &quot;REGISTRY_AUTH=htpasswd&quot;  \\\n    -e &quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot;  \\\n    -e REGISTRY_AUTH_HTPASSWD_PATH=/opt/docker/auth/htpasswd \\\n    registry:latest \n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>    vim /etc/docker/daemon.json\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>{\n    &quot;insecure-registries&quot;:[&quot;192.168.0.4:5000&quot;,&quot;192.168.0.4:5001&quot;],\n    &quot;registry-mirrors&quot;: [\n            &quot;https://5pfmrxk8.mirror.aliyuncs.com&quot;,\n            &quot;http://hub-mirror.c.163.com&quot;,\n            &quot;https://docker.mirrors.ustc.edu.cn&quot;,\n            &quot;https://registry.docker-cn.com&quot;,\n            &quot;http://192.168.0.4:5000&quot;,\n            &quot;http://192.168.0.4:5001&quot;\n    ]\n}\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>firewall-cmd --permanent --add-port=5000/tcp &amp;&amp;\nfirewall-cmd --reload\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>systemctl daemon-reload &amp;&amp; systemctl restart docker\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>rm -rf /registry/public/repos/docker/registry/v2/repositories/springcloud-eureka/\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[778,779]},"content":"4.6.3.搭建harbor私服","children":[{"type":"heading","depth":3,"payload":{"lines":[779,780]},"content":"4.6.3.1.harbor简介"},{"type":"heading","depth":3,"payload":{"lines":[784,785]},"content":"4.6.3.2.搭建docker-compose","children":[{"type":"fence","depth":4,"content":"<pre><code>cd /opt/software/package &amp;&amp;\nsudo chmod +x docker-compose-linux-x86_64 &amp;&amp;\ncp docker-compose-linux-x86_64 /usr/local/bin/docker-compose\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>docker-compose --version\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[804,805]},"content":"4.6.3.3.安装harbor","children":[{"type":"fence","depth":4,"content":"<pre><code>cd /opt/software/package\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>tar -zxvf harbor-offline-installer-v2.5.2.tgz -C /opt/software/install\ncd /opt/software/install/harbor\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cp harbor.yml.tmpl harbor.yml &amp;&amp;\nvim harbor.yml\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    具体修改以下内容\n    修改hostname\n    hostname: 192.168.0.4\n    修改端口\n    port:5001\n    注释掉https相关部分\n    #https:\n        # https port for harbor, default is 443\n        # port: 443\n        # The path of cert and key files for nginx\n        #certificate: /your/certificate/path\n        #private_key: /your/private/key/path\n    修改密码\n        harbor_admin_password: 123456\n    \n    安装docker-compose\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    执行完成后，使用docker images查看harbor相关镜像\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    启动harbor\n    一次性启动所有harbor相关的容器,一般执行完./install.sh就已经启动了相关的容器\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    让docker信任harbor私服\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    配置Docker(Register)注册仓库服务器信任192.168.0.4:5001:\n    {&quot;insecure-registries&quot;:[&quot;192.168.0.4:5001&quot;]}\n    \n    重新加载docker daemon配置文件并重启docker\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    登录harbor首页(密码可以去harbor.yml中查看)\n    访问地址：http://192.168.0.4:5001/\n    用户名/密码：admin/123456\n        \n    在Harbor中创建项目,推送的时候可以用\n    如:springcloud-eureka    \n\n## 4.7.docker官方私服可视化\n### 4.7.1docker-registry-web方案\n    下载docker pull hyper/docker-registry-web镜像\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    启动docker-registry-web\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>\n## 4.8.制作docker镜像并上传到私服\n\n### 4.8.1.制作Dokcer镜像        \n    进入/opt/software/package，并在这个目录中下载jdk\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    编写Dockerfile(Dockerfile内容如下)    \n    \n    #基于centos基础镜像构建\n    FROM centos \n    #作者\n    MAINTAINER lingwh\n    #将jdk添加到基础镜像中\n    ADD jdk-8u181-linux-x64.tar.gz /usr/local\n    #设置java相关的环境变量\n    ENV JAVA_HOME /usr/local/jdk1.8.0_181\n    ENV JRE_HOME ${JAVA_HOME}/jre\n    ENV CLASSPATH .:${JAVA_HOME}/lib:${JRE_HOME}/lib\n    ENV PATH ${JAVA_HOME}/bin:$PATH\n    #输出Java版本信息\n    CMD [&quot;java&quot;,&quot;-version&quot;]     \n                    \n    在当前目录中执行构建镜像的命令\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    查看到刚才制作好的镜像\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    创建容器\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>\n### 4.8.2.上传本地jdk镜像到私服\n    给镜像打标签\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    上传标记的镜像\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    查看推送到私服中的镜像\n    访问:http://192.168.0.4:5000/v2/_catalog,看到:{&quot;repositories&quot;:[&quot;jdk/jdk1.8.0_181&quot;]}\n\n## 4.9.Docker中安装常用软件\n### 4.9.1.Docker安装mysql\n    下载mysql镜像\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    启动mysql容器\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    关闭docker中的mysql容器\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>### 4.9.2.Docker中安装consul\n    下载consul镜像\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    启动consul容器\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>\n### 4.9.3.Docker容器中安装vim     \n    进入容器内部\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    备份旧的源\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    写入新的源\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>\n    更新源\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    安装vim\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>\n### 4.9.3.docker安装elk\n    下载elk镜像\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    启动ELK容器，指定最小内存和最大内存，并映射相关端口\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    开放elk需要用的端口,并且重新载入端口\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    访问Kibana\n    192.168.0.4:5601\n    \n    进入ELK中进行配置\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    修改logstash配置,把下面内容粘贴进去\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code></code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    配置说明:\n    input代表数据输入配置 ， logstatsh的开放端口是 5044\n    output代表数据输出配置，输出到elasticsearch, hosts是es的地址192.168.0.4:9200\n    \n    退出容器\n``  \nexit\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>docker restart elk\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>docker inspect 容器id\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>firewall-cmd --zone=trusted --add-source=172.17.0.2/16 --permanent\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>firewall-cmd --reload\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>systemctl restart firewalld\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>sudo sysctl -w vm.max_map_count=262144\n</code></pre>\n"}]}]}]},{"type":"heading","depth":1,"payload":{"lines":[1090,1091]},"content":"5.Centos搭建Rancher {#5.}","children":[{"type":"fence","depth":2,"content":"<pre><code>docker pull rancher/server\n</code></pre>\n"},{"type":"fence","depth":2,"content":"<pre><code>docker run -di --name=rancher -p9003:8080 rancher/server:latest\n</code></pre>\n"}]},{"type":"heading","depth":1,"payload":{"lines":[1109,1110]},"content":"6.Centos搭建Minikube {#6.}","children":[{"type":"heading","depth":2,"payload":{"lines":[1111,1112]},"content":"6.3.minikube介绍"},{"type":"heading","depth":2,"payload":{"lines":[1114,1115]},"content":"6.4.版本说明"},{"type":"heading","depth":2,"payload":{"lines":[1117,1118]},"content":"6.5.开启Vmware虚拟化","children":[{"type":"fence","depth":3,"content":"<pre><code>grep -E --color 'vmx|svm' /proc/cpuinfo\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1128,1129]},"content":"6.6.安装kubectl","children":[{"type":"fence","depth":3,"content":"<pre><code>chmod +x ./kubectl &amp;&amp; cp ./kubectl /usr/local/bin/kubectl\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubectl version --client\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1141,1142]},"content":"6.7.安装minikube","children":[{"type":"fence","depth":3,"content":"<pre><code>chmod +x ./minikube-linux-amd64 &amp;&amp; cp ./minikube-linux-amd64 /usr/local/bin/minikube\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1152,1153]},"content":"6.8.使用阿里云加速docker hub"},{"type":"heading","depth":2,"payload":{"lines":[1157,1158]},"content":"6.9.启动minikube","children":[{"type":"fence","depth":3,"content":"<pre><code>minikube start --driver=docker --force \\\n    --image-mirror-country='cn' \\\n    --image-repository='registry.cn-hangzhou.aliyuncs.com/google_containers' \\\n    --registry-mirror='https://ngviu28h.mirror.aliyuncs.com' \\\n    --kubernetes-version=v1.23.8\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>VirtualBox-6.1-6.1.34_150636_el7-2.x86_64.rpm\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>sudo yum install gcc kernel kernel-devel -y\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>systemctl reboot\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>yum install VirtualBox-6.1-6.1.34_150636_el7-2.x86_64.rpm -y\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>virtualbox\nrcvboxdrv setup\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>minikube start --driver=virtualbox --force \\\n    --image-mirror-country='cn' \\\n    --image-repository='registry.cn-hangzhou.aliyuncs.com/google_containers' \\\n    --registry-mirror='https://ngviu28h.mirror.aliyuncs.com' \\\n    --kubernetes-version=v1.23.8\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1206,1207]},"content":"6.10.minikube常用命令","children":[{"type":"fence","depth":3,"content":"<pre><code>minikube logs\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>minikube status                             \n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>minikube kubectl -- get po -A\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>minikube stop\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>minikube delete --all\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>minikube dashboard\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>minikube stop\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>minikube delete\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>rm -rf ~/.minikube  \n</code></pre>\n"}]}]},{"type":"heading","depth":1,"payload":{"lines":[1245,1246]},"content":"7.kubeadm搭建Kubernetes {#7.}","children":[{"type":"heading","depth":2,"payload":{"lines":[1248,1249]},"content":"7.3.特别说明"},{"type":"heading","depth":2,"payload":{"lines":[1251,1252]},"content":"7.4.所有节点设置对应主机名"},{"type":"heading","depth":2,"payload":{"lines":[1259,1260]},"content":"7.5.所有节点修改hosts"},{"type":"heading","depth":2,"payload":{"lines":[1265,1266]},"content":"7.6.所有节点关闭SELinux","children":[{"type":"fence","depth":3,"content":"<pre><code>setenforce 0\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>sed -i --follow-symlinks 's/SELINUX=enforcing/SELINUX=disabled/g' \\\n/etc/sysconfig/selinux\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1275,1276]},"content":"7.7.所有节点关闭防火墙","children":[{"type":"fence","depth":3,"content":"<pre><code>systemctl stop firewalld &amp;&amp;\nsystemctl disable firewalld\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1280,1281]},"content":"7.8.所有节点安装docker"},{"type":"heading","depth":2,"payload":{"lines":[1292,1293]},"content":"7.9.所有节点安装k8s所需组件","children":[{"type":"fence","depth":3,"content":"<pre><code>cat &lt;&lt;EOF &gt; kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=0\nrepo_gpgcheck=0\ngpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg \nhttps://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>mv kubernetes.repo /etc/yum.repos.d/\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>yum install -y kubelet-1.22.4 kubectl-1.22.4 kubeadm-1.22.4\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubelet --version\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubectl --version\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubeadm --version\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1325,1326]},"content":"7.10.所有节点启动kubelet和docker","children":[{"type":"fence","depth":3,"content":"<pre><code>systemctl enable kubelet &amp;&amp; \nsystemctl start kubelet &amp;&amp;\nsystemctl enable docker &amp;&amp;\nsystemctl start docker\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1332,1333]},"content":"7.11.所有关闭swap","children":[{"type":"fence","depth":3,"content":"<pre><code>swapoff /mnt/swap\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>sed -ri 's/.*swap.*/#&amp;/' /etc/fstab &amp;&amp; systemctl reboot\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>free -m\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1346,1347]},"content":"7.12.用kubeadm 初始化集群","children":[{"type":"fence","depth":3,"content":"<pre><code>kubeadm init \\\n    --apiserver-advertise-address=192.168.0.6 \\\n    --image-repository registry.aliyuncs.com/google_containers \\\n    --kubernetes-version v1.22.4 \\\n    --service-cidr=10.96.0.0/12 \\\n    --pod-network-cidr=10.244.0.0/16 \\\n    --ignore-preflight-errors=all\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1392,1393]},"content":"7.13.其他节点连接到Master节点"},{"type":"heading","depth":2,"payload":{"lines":[1402,1403]},"content":"7.14.在master节点上查看集群","children":[{"type":"fence","depth":3,"content":"<pre><code>kubectl get nodes\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1413,1414]},"content":"7.15.安装网络插件","children":[{"type":"fence","depth":3,"content":"<pre><code>kubectl apply -f \\\n    https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1418,1419]},"content":"7.16.在master上查看集群节点","children":[{"type":"fence","depth":3,"content":"<pre><code>kubectl get nodes\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1432,1433]},"content":"7.17.启动故障解决","children":[{"type":"fence","depth":3,"content":"<pre><code>kubectl get pods -o wide --all-namespaces\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubectl -n kube-system logs PODNAME\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1444,1445]},"content":"7.18.基础命令","children":[{"type":"fence","depth":3,"content":"<pre><code>kubeadm config images list\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubectl get nodes\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubectl get pod\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubectl get pods -o wide --all-namespaces\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubectl describe pod\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1466,1467]},"content":"7.19.部署第一个程序到k8s中","children":[{"type":"fence","depth":3,"content":"<pre><code>kubectl create deployment guestbook --image=ibmcom/guestbook:v1\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubectl get pods\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubectl expose deployment guestbook --type=NodePort --port=3000\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubectl get service guestbook\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1491,1492]},"content":"7.20.可视化面板kuboard","children":[{"type":"fence","depth":3,"content":"<pre><code>kubectl apply -f https://addons.kuboard.cn/kuboard/kuboard-v3.yaml\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubectl get pods -n kuboard\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>http://192.168.0.6:30080    \n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>watch kubectl get pods -n kuboard\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>watch kubectl get pods -n kuboard\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubectl logs -n kuboard kuboard-v3-5fc46b5557-jlsrj\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>docker ps\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>watch kubectl get pods -n kuboard\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>    kubectl delete -f https://addons.kuboard.cn/kuboard/kuboard-v3.yaml\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>rm -rf /usr/share/kuboard\n</code></pre>\n"}]}]},{"type":"heading","depth":1,"payload":{"lines":[1539,1540]},"content":"8.二进制包搭建Kubernetes {#8.}","children":[{"type":"heading","depth":2,"payload":{"lines":[1542,1543]},"content":"8.3.环境配置清单"},{"type":"heading","depth":2,"payload":{"lines":[1556,1557]},"content":"8.4.服务器规划和IP地址规划","children":[{"type":"heading","depth":3,"payload":{"lines":[1558,1559]},"content":"8.4.1服务器规划","children":[{"type":"table","depth":4,"payload":{"lines":[1566,1571]},"content":"","children":[{"type":"thead","depth":5,"payload":{"lines":[1566,1567]},"content":"","children":[{"type":"th","depth":6,"payload":{"lines":[1566,1567]},"content":"角色"},{"type":"th","depth":6,"payload":{"lines":[1566,1567]},"content":"IP"},{"type":"th","depth":6,"payload":{"lines":[1566,1567]},"content":"组件"}]},{"type":"tbody","depth":5,"payload":{"lines":[1568,1571]},"content":"","children":[{"type":"tr","depth":6,"payload":{},"content":"","children":[{"type":"td","depth":7,"payload":{},"content":"binary-k8s-master1"},{"type":"td","depth":7,"payload":{},"content":"192.168.0.9"},{"type":"td","depth":7,"payload":{},"content":"etcd <br> docker <br> kube-apiserver kube-controller-manager kube-scheduler<br> kubelet kube-proxy"}]},{"type":"tr","depth":6,"payload":{},"content":"","children":[{"type":"td","depth":7,"payload":{},"content":"binary-k8s-worker1"},{"type":"td","depth":7,"payload":{},"content":"192.168.0.10"},{"type":"td","depth":7,"payload":{},"content":"etcd <br> docker <br> kubelet kube-proxy"}]},{"type":"tr","depth":6,"payload":{},"content":"","children":[{"type":"td","depth":7,"payload":{},"content":"binary-k8s-worker1"},{"type":"td","depth":7,"payload":{},"content":"192.168.0.11"},{"type":"td","depth":7,"payload":{},"content":"etcd <br> docker <br> kubelet kube-proxy"}]}]}]},{"type":"table","depth":4,"payload":{"lines":[1573,1580]},"content":"","children":[{"type":"thead","depth":5,"payload":{"lines":[1573,1574]},"content":"","children":[{"type":"th","depth":6,"payload":{"lines":[1573,1574]},"content":"角色"},{"type":"th","depth":6,"payload":{"lines":[1573,1574]},"content":"IP"},{"type":"th","depth":6,"payload":{"lines":[1573,1574]},"content":"组件"}]},{"type":"tbody","depth":5,"payload":{"lines":[1575,1580]},"content":"","children":[{"type":"tr","depth":6,"payload":{},"content":"","children":[{"type":"td","depth":7,"payload":{},"content":"binary-k8s-master1"},{"type":"td","depth":7,"payload":{},"content":"192.168.0.9"},{"type":"td","depth":7,"payload":{},"content":"etcd <br> docker <br> kube-apiserver kube-controller-manager kube-scheduler <br> kubelet kube-proxy <br> nginx keepalived"}]},{"type":"tr","depth":6,"payload":{},"content":"","children":[{"type":"td","depth":7,"payload":{},"content":"binary-k8s-master2"},{"type":"td","depth":7,"payload":{},"content":"192.168.0.12"},{"type":"td","depth":7,"payload":{},"content":"etcd <br> docker <br> kube-apiserver kube-controller-manager kube-scheduler <br> kubelet kube-proxy <br> nginx keepalived"}]},{"type":"tr","depth":6,"payload":{},"content":"","children":[{"type":"td","depth":7,"payload":{},"content":"binary-k8s-worker1"},{"type":"td","depth":7,"payload":{},"content":"192.168.0.10"},{"type":"td","depth":7,"payload":{},"content":"etcd <br> docker <br> kubelet kube-proxy"}]},{"type":"tr","depth":6,"payload":{},"content":"","children":[{"type":"td","depth":7,"payload":{},"content":"binary-k8s-worker2"},{"type":"td","depth":7,"payload":{},"content":"192.168.0.11"},{"type":"td","depth":7,"payload":{},"content":"etcd <br> docker <br> kubelet kube-proxy"}]},{"type":"tr","depth":6,"payload":{},"content":"","children":[{"type":"td","depth":7,"payload":{},"content":"负载均衡器(虚拟IP)"},{"type":"td","depth":7,"payload":{},"content":"192.168.0.88"}]}]}]}]},{"type":"heading","depth":3,"payload":{"lines":[1581,1582]},"content":"8.4.2.IP地址规划"}]},{"type":"heading","depth":2,"payload":{"lines":[1612,1613]},"content":"8.5.安装前准备工作","children":[{"type":"heading","depth":3,"payload":{"lines":[1616,1617]},"content":"8.5.1操作系统初始设置","children":[{"type":"fence","depth":4,"content":"<pre><code>systemctl stop firewalld &amp;&amp; systemctl disable firewalld #关闭系统防火墙\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>sed -i 's/enforcing/disabled/' /etc/selinux/config #永久关闭selinux\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>sed -ri 's/.*swap.*/#&amp;/' /etc/fstab #永久关闭swap\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>hostnamectl set-hostname binary-k8s-master1 &amp;&amp; systemctl reboot #binary-k8s-master1（192.168.0.9）\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>hostnamectl set-hostname binary-k8s-worker1  &amp;&amp; systemctl reboot #binary-k8s-worker1 （192.168.0.10）\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>hostnamectl set-hostname binary-k8s-worker2  &amp;&amp; systemctl reboot #binary-k8s-worker2 （192.168.0.11）\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>hostnamectl set-hostname binary-k8s-master2 &amp;&amp; systemctl reboot #binary-k8s-master2（192.168.0.12）\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt;&gt; /etc/hosts &lt;&lt; EOF\n192.168.0.9 binary-k8s-master1\n192.168.0.10 binary-k8s-worker1\n192.168.0.11 binary-k8s-worker2\n192.168.0.12 binary-k8s-master2\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>sysctl --system  \n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>ntpdate ntp.aliyun.com\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[1672,1673]},"content":"8.5.2下载所有用到的软件包","children":[{"type":"fence","depth":4,"content":"<pre><code>yum -y install curl\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>mkdir -p /opt/k8s &amp;&amp;\ncd /opt/k8s &amp;&amp;\ncurl -fL -u software-1658989668964:1db7b96a6698ef06009de91348cb797dfd87fc99 \\\n&quot;https://lingwh-generic.pkg.coding.net/coding-drive/software/kubernetes-all-2022.7.28.tar.gz?version=latest&quot; \\\n-o kubernetes-all.tar.gz\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>tar -zxvf kubernetes-all.tar.gz &amp;&amp;\nmv kubernetes package\n</code></pre>\n"}]}]},{"type":"heading","depth":2,"payload":{"lines":[1694,1695]},"content":"8.6.安装cfssl证书生成工具","children":[{"type":"fence","depth":3,"content":"<pre><code>cd /opt/k8s/package/cfssl-utils &amp;&amp; chmod +x * &amp;&amp;\ncp cfssl_linux-amd64 /usr/local/bin/cfssl &amp;&amp;\ncp cfssljson_linux-amd64 /usr/local/bin/cfssljson &amp;&amp;\ncp cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo\n</code></pre>\n"}]},{"type":"heading","depth":2,"payload":{"lines":[1710,1711]},"content":"8.7.搭建etcd集群","children":[{"type":"heading","depth":3,"payload":{"lines":[1714,1715]},"content":"8.7.1生成CA证书和https证书","children":[{"type":"fence","depth":4,"content":"<pre><code>mkdir -p ~/TLS/{etcd,k8s} &amp;&amp; cd /root/TLS/etcd/\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; ca-config.json &lt;&lt; EOF\n{\n  &quot;signing&quot;: {\n    &quot;default&quot;: {\n      &quot;expiry&quot;: &quot;87600h&quot;\n    },\n    &quot;profiles&quot;: {\n      &quot;www&quot;: {\n         &quot;expiry&quot;: &quot;87600h&quot;,\n         &quot;usages&quot;: [\n            &quot;signing&quot;,\n            &quot;key encipherment&quot;,\n            &quot;server auth&quot;,\n            &quot;client auth&quot;\n        ]\n      }\n    }\n  }\n}\nEOF\n\ncat &gt; ca-csr.json &lt;&lt; EOF\n{\n    &quot;CN&quot;: &quot;etcd CA&quot;,\n    &quot;key&quot;: {\n        &quot;algo&quot;: &quot;rsa&quot;,\n        &quot;size&quot;: 2048\n    },\n    &quot;names&quot;: [\n        {\n            &quot;C&quot;: &quot;CN&quot;,\n            &quot;L&quot;: &quot;YuMingYu&quot;,\n            &quot;ST&quot;: &quot;YuMingYu&quot;\n        }\n    ]\n}\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cfssl gencert -initca ca-csr.json | cfssljson -bare ca -\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; server-csr.json &lt;&lt; EOF\n{\n    &quot;CN&quot;: &quot;etcd&quot;,\n    &quot;hosts&quot;: [\n    &quot;192.168.0.9&quot;,\n    &quot;192.168.0.10&quot;,\n    &quot;192.168.0.11&quot;,\n    &quot;192.168.0.12&quot;\n    ],\n    &quot;key&quot;: {\n        &quot;algo&quot;: &quot;rsa&quot;,\n        &quot;size&quot;: 2048\n    },\n    &quot;names&quot;: [\n        {\n            &quot;C&quot;: &quot;CN&quot;,\n            &quot;L&quot;: &quot;YuMingYu&quot;,\n            &quot;ST&quot;: &quot;YuMingYu&quot;\n        }\n    ]\n}\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem \\\n    -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[1794,1795]},"content":"8.7.2.部署etcd集群","children":[{"type":"fence","depth":4,"content":"<pre><code>    mkdir /opt/etcd/{bin,cfg,ssl} -p\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cd /opt/k8s/package &amp;&amp;\ntar -xf etcd-v3.4.9-linux-amd64.tar.gz &amp;&amp;\nmv etcd-v3.4.9-linux-amd64/{etcd,etcdctl} /opt/etcd/bin/\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; EOF\n#[Member]\nETCD_NAME=&quot;etcd-1&quot;\nETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;\nETCD_LISTEN_PEER_URLS=&quot;https://192.168.0.9:2380&quot;\nETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.0.9:2379&quot;\n\n#[Clustering]\nETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.0.9:2380&quot;\nETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.0.9:2379&quot;\nETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.0.9:2380,\\\netcd-2=https://192.168.0.10:2380,etcd-3=https://192.168.0.11:2380&quot;\nETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;\nETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[1846,1847]},"content":"8.7.4.拷贝etcd所需证书","children":[{"type":"fence","depth":4,"content":"<pre><code>cp ~/TLS/etcd/{server.pem,server-key.pem,ca.pem} /opt/etcd/ssl/\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[1851,1852]},"content":"8.7.5.让systemd管理etcd","children":[{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF\n[Unit]\nDescription=Etcd Server\nAfter=network.target\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nType=notify\nEnvironmentFile=/opt/etcd/cfg/etcd.conf\nExecStart=/opt/etcd/bin/etcd \\\n--cert-file=/opt/etcd/ssl/server.pem \\\n--key-file=/opt/etcd/ssl/server-key.pem \\\n--peer-cert-file=/opt/etcd/ssl/server.pem \\\n--peer-key-file=/opt/etcd/ssl/server-key.pem \\\n--trusted-ca-file=/opt/etcd/ssl/ca.pem \\\n--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\\n--logger=zap\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[1879,1880]},"content":"8.7.6.拷贝etcd安装文件到Worker Node","children":[{"type":"fence","depth":4,"content":"<pre><code>    mkdir /opt/etcd/{bin,cfg,ssl} -p\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>scp -r /opt/etcd/ root@192.168.0.10:/opt &amp;&amp;\nscp /usr/lib/systemd/system/etcd.service root@192.168.0.10:/usr/lib/systemd/system/\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>scp -r /opt/etcd/ root@192.168.0.11:/opt &amp;&amp;\nscp /usr/lib/systemd/system/etcd.service root@192.168.0.11:/usr/lib/systemd/system/\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; EOF\n#[Member]\nETCD_NAME=&quot;etcd-2&quot;\nETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;\nETCD_LISTEN_PEER_URLS=&quot;https://192.168.0.10:2380&quot;\nETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.0.10:2379&quot;\n\n#[Clustering]\nETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.0.10:2380&quot;\nETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.0.10:2379&quot;\nETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.0.9:2380,\\\netcd-2=https://192.168.0.10:2380,etcd-3=https://192.168.0.11:2380&quot;\nETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;\nETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; EOF\n#[Member]\nETCD_NAME=&quot;etcd-3&quot;\nETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;\nETCD_LISTEN_PEER_URLS=&quot;https://192.168.0.11:2380&quot;\nETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.0.11:2379&quot;\n\n#[Clustering]\nETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.0.11:2380&quot;\nETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.0.11:2379&quot;\nETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.0.9:2380,\\\netcd-2=https://192.168.0.10:2380,etcd-3=https://192.168.0.11:2380&quot;\nETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;\nETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[1961,1962]},"content":"8.7.7.启动三个etcd并设置开机自启","children":[{"type":"fence","depth":4,"content":"<pre><code>systemctl daemon-reload &amp;&amp;\nsystemctl start etcd &amp;&amp;\nsystemctl enable etcd\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>ETCDCTL_API=3 /opt/etcd/bin/etcdctl \\\n--cacert=/opt/etcd/ssl/ca.pem \\\n--cert=/opt/etcd/ssl/server.pem \\\n--key=/opt/etcd/ssl/server-key.pem \\\n--endpoints=&quot;https://192.168.0.9:2379,https://192.168.0.10:2379,https://192.168.0.11:2379&quot; \\\nendpoint health --write-out=table\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>journalctl -u etcd\n</code></pre>\n"}]}]},{"type":"heading","depth":2,"payload":{"lines":[1996,1997]},"content":"8.8.安装配置Docker","children":[{"type":"heading","depth":3,"payload":{"lines":[2001,2002]},"content":"8.8.1在Master1上安装docker","children":[{"type":"fence","depth":4,"content":"<pre><code>cd /opt/k8s/package/ &amp;&amp;\ntar -xf docker-19.03.9.tgz &amp;&amp; mv docker/* /usr/bin/\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>sudo mkdir -p /etc/docker &amp;&amp;\nsudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'\n{\n  &quot;registry-mirrors&quot;: [&quot;https://3s9106.mirror.alncs.com&quot;]\n}\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF\n[Unit]\nDescription=Docker Application Container Engine\nDocumentation=https://docs.docker.com\nAfter=network-online.target firewalld.service\nWants=network-online.target\n \n[Service]\nType=notify\nExecStart=/usr/bin/dockerd\nExecReload=/bin/kill -s HUP $MAINPID\nLimitNOFILE=infinity\nLimitNPROC=infinity\nTimeoutStartSec=0\nDelegate=yes\nKillMode=process\nRestart=on-failure\nStartLimitBurst=3\nStartLimitInterval=60s\n \n[Install]\nWantedBy=multi-user.target\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2043,2044]},"content":"8.8.2在所有Worker Node上安装docker","children":[{"type":"fence","depth":4,"content":"<pre><code>mkdir -p /opt/k8s/package &amp;&amp;\nmkdir -p /etc/docker\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>scp /usr/bin/docker* root@192.168.0.10:/usr/bin &amp;&amp;\nscp /usr/bin/runc root@192.168.0.10:/usr/bin &amp;&amp;\nscp /usr/bin/containerd* root@192.168.0.10:/usr/bin &amp;&amp;\nscp /usr/lib/systemd/system/docker.service \\\nroot@192.168.0.10:/usr/lib/systemd/system &amp;&amp;\nscp -r /etc/docker root@192.168.0.10:/etc\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>scp /usr/bin/docker* root@192.168.0.11:/usr/bin &amp;&amp;\nscp /usr/bin/runc root@192.168.0.11:/usr/bin &amp;&amp;\nscp /usr/bin/containerd* root@192.168.0.11:/usr/bin &amp;&amp;\nscp /usr/lib/systemd/system/docker.service \\\nroot@192.168.0.11:/usr/lib/systemd/system &amp;&amp;\nscp -r /etc/docker root@192.168.0.11:/etc\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2073,2074]},"content":"8.8.3启动三台机器上的docker","children":[{"type":"fence","depth":4,"content":"<pre><code>systemctl daemon-reload &amp;&amp;\nsystemctl start docker &amp;&amp;\nsystemctl enable docker\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>systemctl status docker\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>systemctl status docker\n</code></pre>\n"}]}]},{"type":"heading","depth":2,"payload":{"lines":[2090,2091]},"content":"8.9.搭建kube-apiserver","children":[{"type":"heading","depth":3,"payload":{"lines":[2095,2096]},"content":"8.9.1.生成CA证书和Https证书","children":[{"type":"fence","depth":4,"content":"<pre><code>cd ~/TLS/k8s\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; ca-config.json &lt;&lt; EOF\n{\n  &quot;signing&quot;: {\n    &quot;default&quot;: {\n      &quot;expiry&quot;: &quot;87600h&quot;\n    },\n    &quot;profiles&quot;: {\n      &quot;kubernetes&quot;: {\n         &quot;expiry&quot;: &quot;87600h&quot;,\n         &quot;usages&quot;: [\n            &quot;signing&quot;,\n            &quot;key encipherment&quot;,\n            &quot;server auth&quot;,\n            &quot;client auth&quot;\n        ]\n      }\n    }\n  }\n}\nEOF\n\ncat &gt; ca-csr.json &lt;&lt; EOF\n{\n    &quot;CN&quot;: &quot;kubernetes&quot;,\n    &quot;key&quot;: {\n        &quot;algo&quot;: &quot;rsa&quot;,\n        &quot;size&quot;: 2048\n    },\n    &quot;names&quot;: [\n        {\n            &quot;C&quot;: &quot;CN&quot;,\n            &quot;L&quot;: &quot;Beijing&quot;,\n            &quot;ST&quot;: &quot;Beijing&quot;,\n            &quot;O&quot;: &quot;k8s&quot;,\n            &quot;OU&quot;: &quot;System&quot;\n        }\n    ]\n}\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cfssl gencert -initca ca-csr.json | cfssljson -bare ca -\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; server-csr.json &lt;&lt; EOF\n{\n    &quot;CN&quot;: &quot;kubernetes&quot;,\n    &quot;hosts&quot;: [\n      &quot;10.0.0.1&quot;,\n      &quot;127.0.0.1&quot;,\n      &quot;192.168.0.9&quot;,\n      &quot;192.168.0.10&quot;,\n      &quot;192.168.0.11&quot;,\n      &quot;192.168.0.12&quot;,\n      &quot;192.168.0.88&quot;,\n      &quot;192.168.0.13&quot;,\n      &quot;192.168.0.14&quot;,\n      &quot;192.168.0.15&quot;,\n      &quot;192.168.0.16&quot;,\n      &quot;192.168.0.17&quot;,\n      &quot;192.168.0.18&quot;,\n      &quot;192.168.0.19&quot;,\n      &quot;192.168.0.20&quot;,\n      &quot;192.168.0.100&quot;,\n      &quot;192.168.0.101&quot;,\n      &quot;192.168.0.102&quot;,\n      &quot;192.168.0.103&quot;,\n      &quot;192.168.0.104&quot;,\n      &quot;192.168.0.105&quot;,\n      &quot;kubernetes&quot;,\n      &quot;kubernetes.default&quot;,\n      &quot;kubernetes.default.svc&quot;,\n      &quot;kubernetes.default.svc.cluster&quot;,\n      &quot;kubernetes.default.svc.cluster.local&quot;\n    ],\n    &quot;key&quot;: {\n        &quot;algo&quot;: &quot;rsa&quot;,\n        &quot;size&quot;: 2048\n    },\n    &quot;names&quot;: [\n        {\n            &quot;C&quot;: &quot;CN&quot;,\n            &quot;L&quot;: &quot;BeiJing&quot;,\n            &quot;ST&quot;: &quot;BeiJing&quot;,\n            &quot;O&quot;: &quot;k8s&quot;,\n            &quot;OU&quot;: &quot;System&quot;\n        }\n    ]\n}\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json \\\n-profile=kubernetes server-csr.json | cfssljson -bare server\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2235,2236]},"content":"8.9.2.在Master Node1上部署kube-apiserver","children":[{"type":"fence","depth":4,"content":"<pre><code>mkdir -p /opt/kubernetes/{bin,cfg,ssl,logs}\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cd /opt/k8s/package &amp;&amp;\ntar -zxvf kubernetes-server-linux-amd64.tar.gz &amp;&amp;\ncd /opt/k8s/package/kubernetes/server/bin &amp;&amp;\ncp kube-apiserver /opt/kubernetes/bin &amp;&amp;\ncp kubectl /usr/bin/\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /opt/kubernetes/cfg/kube-apiserver.conf &lt;&lt; EOF\nKUBE_APISERVER_OPTS=&quot;--logtostderr=false \\\\\n--v=2 \\\\\n--log-dir=/opt/kubernetes/logs \\\\\n--etcd-servers=https://192.168.0.9:2379,https://192.168.0.10:2379,\\\nhttps://192.168.0.11:2379 \\\\\n--bind-address=192.168.0.9 \\\\\n--secure-port=6443 \\\\\n--advertise-address=192.168.0.9 \\\\\n--allow-privileged=true \\\\\n--service-cluster-ip-range=10.0.0.0/24 \\\\\n--enable-admission-plugins=NamespaceLifecycle,\\\nLimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\\\\n--authorization-mode=RBAC,Node \\\\\n--enable-bootstrap-token-auth=true \\\\\n--token-auth-file=/opt/kubernetes/cfg/token.csv \\\\\n--service-node-port-range=30000-32767 \\\\\n--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\\\\n--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\\\\n--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\\\\n--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\\\\n--client-ca-file=/opt/kubernetes/ssl/ca.pem \\\\\n--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\\\\n--service-account-issuer=api \\\\\n--service-account-signing-key-file=/opt/kubernetes/ssl/server-key.pem \\\\\n--etcd-cafile=/opt/etcd/ssl/ca.pem \\\\\n--etcd-certfile=/opt/etcd/ssl/server.pem \\\\\n--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\\\\n--requestheader-client-ca-file=/opt/kubernetes/ssl/ca.pem \\\\\n--proxy-client-cert-file=/opt/kubernetes/ssl/server.pem \\\\\n--proxy-client-key-file=/opt/kubernetes/ssl/server-key.pem \\\\\n--requestheader-allowed-names=kubernetes \\\\\n--requestheader-extra-headers-prefix=X-Remote-Extra- \\\\\n--requestheader-group-headers=X-Remote-Group \\\\\n--requestheader-username-headers=X-Remote-User \\\\\n--enable-aggregator-routing=true \\\\\n--audit-log-maxage=30 \\\\\n--audit-log-maxbackup=3 \\\\\n--audit-log-maxsize=100 \\\\\n--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&quot;\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2326,2327]},"content":"8.9.3.拷贝所需证书","children":[{"type":"fence","depth":4,"content":"<pre><code>cp ~/TLS/k8s/ca*pem ~/TLS/k8s/server*pem /opt/kubernetes/ssl/\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2330,2331]},"content":"8.9.4.启用TLS bootstrapping","children":[{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /opt/kubernetes/cfg/token.csv &lt;&lt; EOF\n4136692876ad4b01bb9dd0988480ebba,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2347,2348]},"content":"8.9.5.让systemd管理apiserver","children":[{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF\n[Unit]\nDescription=Kubernetes API Server\nDocumentation=https://github.com/kubernetes/kubernetes\n\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf\nExecStart=/opt/kubernetes/bin/kube-apiserver \\$KUBE_APISERVER_OPTS\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2363,2364]},"content":"8.9.6.启动kube-apiserver","children":[{"type":"fence","depth":4,"content":"<pre><code>systemctl daemon-reload &amp;&amp;\nsystemctl start kube-apiserver &amp;&amp;\nsystemctl enable kube-apiserver\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>systemctl status kube-apiserver\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat /var/log/messages|grep kube-apiserver|grep -i error\n</code></pre>\n"}]}]},{"type":"heading","depth":2,"payload":{"lines":[2379,2380]},"content":"8.10.在Master Node1上部署kube-controller-manager","children":[{"type":"heading","depth":3,"payload":{"lines":[2384,2385]},"content":"8.10.1.切换目录并拷贝kube-controller-manager相关文件到/opt/kubernetes/bin","children":[{"type":"fence","depth":4,"content":"<pre><code>cp /opt/k8s/package/kubernetes/server/bin/kube-controller-manager /opt/kubernetes/bin\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2389,2390]},"content":"8.10.2.生成证书","children":[{"type":"fence","depth":4,"content":"<pre><code>cd ~/TLS/k8s\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; kube-controller-manager-csr.json &lt;&lt; EOF\n{\n    &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,\n    &quot;hosts&quot;: [],\n    &quot;key&quot;: {\n    &quot;algo&quot;: &quot;rsa&quot;,\n    &quot;size&quot;: 2048\n    },\n    &quot;names&quot;: [\n    {\n        &quot;C&quot;: &quot;CN&quot;,\n        &quot;L&quot;: &quot;BeiJing&quot;, \n        &quot;ST&quot;: &quot;BeiJing&quot;,\n        &quot;O&quot;: &quot;system:masters&quot;,\n        &quot;OU&quot;: &quot;System&quot;\n    }\n    ]\n}\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem \\\n-config=ca-config.json -profile=kubernetes \\\nkube-controller-manager-csr.json | cfssljson -bare kube-controller-manager\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2424,2425]},"content":"8.10.2.创建kube-controller-manager配置文件","children":[{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /opt/kubernetes/cfg/kube-controller-manager.conf &lt;&lt; EOF\nKUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=false \\\\\n--v=2 \\\\\n--log-dir=/opt/kubernetes/logs \\\\\n--leader-elect=true \\\\\n--kubeconfig=/opt/kubernetes/cfg/kube-controller-manager.kubeconfig \\\\\n--bind-address=127.0.0.1 \\\\\n--allocate-node-cidrs=true \\\\\n--cluster-cidr=10.244.0.0/16 \\\\\n--service-cluster-ip-range=10.0.0.0/24 \\\\\n--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\\\\n--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\\\\n--root-ca-file=/opt/kubernetes/ssl/ca.pem \\\\\n--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\\\\n--cluster-signing-duration=87600h0m0s&quot;\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2449,2450]},"content":"8.10.3.生成配置文件","children":[{"type":"fence","depth":4,"content":"<pre><code>KUBE_CONFIG=&quot;/opt/kubernetes/cfg/kube-controller-manager.kubeconfig&quot;\nKUBE_APISERVER=&quot;https://192.168.0.9:6443&quot;\n\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=${KUBE_CONFIG}\n  \nkubectl config set-credentials kube-controller-manager \\\n  --client-certificate=./kube-controller-manager.pem \\\n  --client-key=./kube-controller-manager-key.pem \\\n  --embed-certs=true \\\n  --kubeconfig=${KUBE_CONFIG}\n  \nkubectl config set-context default \\\n  --cluster=kubernetes \\\n  --user=kube-controller-manager \\\n  --kubeconfig=${KUBE_CONFIG}\n  \nkubectl config use-context default --kubeconfig=${KUBE_CONFIG}\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2476,2477]},"content":"8.10.4.让systemd管理controller-manager","children":[{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF\n[Unit]\nDescription=Kubernetes Controller Manager\nDocumentation=https://github.com/kubernetes/kubernetes\n\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf\nExecStart=/opt/kubernetes/bin/kube-controller-manager \\$KUBE_CONTROLLER_MANAGER_OPTS\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2493,2494]},"content":"8.10.5.启动kube-controller-manager","children":[{"type":"fence","depth":4,"content":"<pre><code>systemctl daemon-reload &amp;&amp;\nsystemctl start kube-controller-manager &amp;&amp;\nsystemctl enable kube-controller-manager\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>systemctl status kube-controller-manager\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat /var/log/messages|grep kube-controller-manager|grep -i error\n</code></pre>\n"}]}]},{"type":"heading","depth":2,"payload":{"lines":[2509,2510]},"content":"8.11.部署kube-scheduler","children":[{"type":"heading","depth":3,"payload":{"lines":[2513,2514]},"content":"8.10.1 切换目录并拷贝kube-dcheduler相关文件到/opt/kubernetes/bin","children":[{"type":"fence","depth":4,"content":"<pre><code>cp /opt/k8s/package/kubernetes/server/bin/kube-scheduler /opt/kubernetes/bin\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2518,2519]},"content":"8.11.2.生成证书","children":[{"type":"fence","depth":4,"content":"<pre><code>cd ~/TLS/k8s\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; kube-scheduler-csr.json &lt;&lt; EOF\n{\n  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,\n  &quot;hosts&quot;: [],\n  &quot;key&quot;: {\n    &quot;algo&quot;: &quot;rsa&quot;,\n    &quot;size&quot;: 2048\n  },\n  &quot;names&quot;: [\n    {\n      &quot;C&quot;: &quot;CN&quot;,\n      &quot;L&quot;: &quot;BeiJing&quot;,\n      &quot;ST&quot;: &quot;BeiJing&quot;,\n      &quot;O&quot;: &quot;system:masters&quot;,\n      &quot;OU&quot;: &quot;System&quot;\n    }\n  ]\n}\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem \\\n-config=ca-config.json -profile=kubernetes \\\nkube-scheduler-csr.json | cfssljson -bare kube-scheduler\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2552,2553]},"content":"8.11.3.创建kube-scheduler.conf配置文件","children":[{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /opt/kubernetes/cfg/kube-scheduler.conf &lt;&lt; EOF\nKUBE_SCHEDULER_OPTS=&quot;--logtostderr=false \\\\\n--v=2 \\\\\n--log-dir=/opt/kubernetes/logs \\\\\n--leader-elect \\\\\n--kubeconfig=/opt/kubernetes/cfg/kube-scheduler.kubeconfig \\\\\n--bind-address=127.0.0.1&quot;\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2567,2568]},"content":"8.11.4.生成kube-scheduler.kubeconfig文件","children":[{"type":"fence","depth":4,"content":"<pre><code>    mkdir ~/.kube\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>KUBE_CONFIG=&quot;/opt/kubernetes/cfg/kube-scheduler.kubeconfig&quot;\nKUBE_APISERVER=&quot;https://192.168.0.9:6443&quot;\n\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=${KUBE_CONFIG}\n  \nkubectl config set-credentials kube-scheduler \\\n  --client-certificate=./kube-scheduler.pem \\\n  --client-key=./kube-scheduler-key.pem \\\n  --embed-certs=true \\\n  --kubeconfig=${KUBE_CONFIG}\n  \nkubectl config set-context default \\\n  --cluster=kubernetes \\\n  --user=kube-scheduler \\\n  --kubeconfig=${KUBE_CONFIG}\n  \nkubectl config use-context default --kubeconfig=${KUBE_CONFIG}\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2598,2599]},"content":"8.11.5.让systemd管理kube-scheduler","children":[{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF\n[Unit]\nDescription=Kubernetes Scheduler\nDocumentation=https://github.com/kubernetes/kubernetes\n\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf\nExecStart=/opt/kubernetes/bin/kube-scheduler \\$KUBE_SCHEDULER_OPTS\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2615,2616]},"content":"8.11.6.启动并设置开机启动","children":[{"type":"fence","depth":4,"content":"<pre><code>systemctl daemon-reload &amp;&amp;\nsystemctl start kube-scheduler &amp;&amp;\nsystemctl enable kube-scheduler\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>systemctl status kube-scheduler\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat /var/log/messages|grep kube-scheduler|grep -i error\n</code></pre>\n"}]}]},{"type":"heading","depth":2,"payload":{"lines":[2631,2632]},"content":"8.12.使用kubectl查看集群状态","children":[{"type":"heading","depth":3,"payload":{"lines":[2636,2637]},"content":"8.12.1.生成所需证书","children":[{"type":"fence","depth":4,"content":"<pre><code>cd ~/TLS/k8s\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; admin-csr.json &lt;&lt;EOF\n{\n    &quot;CN&quot;: &quot;admin&quot;,\n    &quot;hosts&quot;: [],\n    &quot;key&quot;: {\n    &quot;algo&quot;: &quot;rsa&quot;,\n    &quot;size&quot;: 2048\n    },\n    &quot;names&quot;: [\n    {\n        &quot;C&quot;: &quot;CN&quot;,\n        &quot;L&quot;: &quot;BeiJing&quot;,\n        &quot;ST&quot;: &quot;BeiJing&quot;,\n        &quot;O&quot;: &quot;system:masters&quot;,\n        &quot;OU&quot;: &quot;System&quot;\n    }\n    ]\n}\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem \\\n-config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2668,2669]},"content":"8.12.2.在.kube文件夹中生成config文件","children":[{"type":"fence","depth":4,"content":"<pre><code>mkdir /root/.kube\n\nKUBE_CONFIG=&quot;/root/.kube/config&quot;\nKUBE_APISERVER=&quot;https://192.168.0.9:6443&quot;\n\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=${KUBE_CONFIG}\n  \nkubectl config set-credentials cluster-admin \\\n  --client-certificate=./admin.pem \\\n  --client-key=./admin-key.pem \\\n  --embed-certs=true \\\n  --kubeconfig=${KUBE_CONFIG}\n  \nkubectl config set-context default \\\n  --cluster=kubernetes \\\n  --user=cluster-admin \\\n  --kubeconfig=${KUBE_CONFIG}\n  \nkubectl config use-context default --kubeconfig=${KUBE_CONFIG}\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2694,2695]},"content":"8.12.3.通过kubectl工具查看集群组件","children":[{"type":"fence","depth":4,"content":"<pre><code>kubectl get cs\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[2707,2708]},"content":"8.12.4.授权kubelet-bootstrap用户允许请求证书","children":[{"type":"fence","depth":4,"content":"<pre><code>kubectl create clusterrolebinding kubelet-bootstrap \\\n--clusterrole=system:node-bootstrapper \\\n--user=kubelet-bootstrap\n</code></pre>\n"}]}]},{"type":"heading","depth":2,"payload":{"lines":[2727,2728]},"content":"8.13.在Master Node1上部署第一个Worker Node","children":[{"type":"fence","depth":3,"content":"<pre><code>cd /opt/k8s/package/kubernetes/server/bin/\ncp kubelet  kube-proxy /opt/kubernetes/bin/ &amp;&amp;\nscp kubelet  kube-proxy root@192.168.0.10:/opt/kubernetes/bin/ &amp;&amp;\nscp kubelet  kube-proxy root@192.168.0.11:/opt/kubernetes/bin/\n</code></pre>\n"},{"type":"heading","depth":3,"payload":{"lines":[2740,2741]},"content":"8.13.2.在Master Node1部署kubelet","children":[{"type":"heading","depth":4,"payload":{"lines":[2741,2742]},"content":"8.13.2.1.创建kubelet配置文件","children":[{"type":"fence","depth":5,"content":"<pre><code>cat &gt; /opt/kubernetes/cfg/kubelet.conf &lt;&lt; EOF\nKUBELET_OPTS=&quot;--logtostderr=false \\\\\n--v=2 \\\\\n--log-dir=/opt/kubernetes/logs \\\\\n--hostname-override=binary-k8s-master1 \\\\\n--network-plugin=cni \\\\\n--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\\\\n--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\\\\n--config=/opt/kubernetes/cfg/kubelet-config.yml \\\\\n--cert-dir=/opt/kubernetes/ssl \\\\\n--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google-containers/pause-amd64:3.0&quot;\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":4,"payload":{"lines":[2765,2766]},"content":"8.13.2.2.创建kubelet编排文件","children":[{"type":"fence","depth":5,"content":"<pre><code>cat &gt; /opt/kubernetes/cfg/kubelet-config.yml &lt;&lt; EOF\nkind: KubeletConfiguration\napiVersion: kubelet.config.k8s.io/v1beta1\naddress: 0.0.0.0\nport: 10250\nreadOnlyPort: 10255\ncgroupDriver: cgroupfs\nclusterDNS:\n- 10.0.0.2\nclusterDomain: cluster.local \nfailSwapOn: false\nauthentication:\n  anonymous:\n    enabled: false\n  webhook:\n    cacheTTL: 2m0s\n    enabled: true\n  x509:\n    clientCAFile: /opt/kubernetes/ssl/ca.pem \nauthorization:\n  mode: Webhook\n  webhook:\n    cacheAuthorizedTTL: 5m0s\n    cacheUnauthorizedTTL: 30s\nevictionHard:\n  imagefs.available: 15%\n  memory.available: 100Mi\n  nodefs.available: 10%\n  nodefs.inodesFree: 5%\nmaxOpenFiles: 1000000\nmaxPods: 110\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":4,"payload":{"lines":[2801,2802]},"content":"8.13.2.3.生成kubelet初次加入集群引导kubeconfig文件","children":[{"type":"fence","depth":5,"content":"<pre><code>KUBE_CONFIG=&quot;/opt/kubernetes/cfg/bootstrap.kubeconfig&quot;\nKUBE_APISERVER=&quot;https://192.168.0.9:6443&quot; # apiserver IP:PORT\nTOKEN=&quot;4136692876ad4b01bb9dd0988480ebba&quot; # 与token.csv里保持一致  /opt/kubernetes/cfg/token.csv \n\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=${KUBE_CONFIG}\n  \nkubectl config set-credentials &quot;kubelet-bootstrap&quot; \\\n  --token=${TOKEN} \\\n  --kubeconfig=${KUBE_CONFIG}\n  \nkubectl config set-context default \\\n  --cluster=kubernetes \\\n  --user=&quot;kubelet-bootstrap&quot; \\\n  --kubeconfig=${KUBE_CONFIG}\n  \nkubectl config use-context default --kubeconfig=${KUBE_CONFIG}\n</code></pre>\n"}]},{"type":"heading","depth":4,"payload":{"lines":[2826,2827]},"content":"8.13.2.4.systemd管理kubelet","children":[{"type":"fence","depth":5,"content":"<pre><code>cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF\n[Unit]\nDescription=Kubernetes Kubelet\nAfter=docker.service\n\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kubelet.conf\nExecStart=/opt/kubernetes/bin/kubelet \\$KUBELET_OPTS\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":4,"payload":{"lines":[2844,2845]},"content":"8.13.3.5.启动kubelet并设置开机启动","children":[{"type":"fence","depth":5,"content":"<pre><code>systemctl daemon-reload &amp;&amp;\nsystemctl start kubelet &amp;&amp;\nsystemctl enable kubelet\n</code></pre>\n"},{"type":"fence","depth":5,"content":"<pre><code>systemctl status kubelet\n</code></pre>\n"},{"type":"fence","depth":5,"content":"<pre><code>cat /var/log/messages|grep kubelet\n</code></pre>\n"}]},{"type":"heading","depth":4,"payload":{"lines":[2860,2861]},"content":"8.13.2.6.允许kubelet证书申请并加入集群","children":[{"type":"fence","depth":5,"content":"<pre><code>kubectl get csr\n</code></pre>\n"},{"type":"fence","depth":5,"content":"<pre><code>kubectl certificate approve node-csr-IiJqGnj7y-9pMOIaYb9rpYxtIaEuACOITLI-WpfdpDI\n</code></pre>\n"},{"type":"fence","depth":5,"content":"<pre><code>kubectl get csr\n</code></pre>\n"},{"type":"fence","depth":5,"content":"<pre><code>kubectl get nodes\n</code></pre>\n"}]}]},{"type":"heading","depth":3,"payload":{"lines":[2898,2899]},"content":"8.13.3.部署kube-proxy","children":[{"type":"heading","depth":4,"payload":{"lines":[2899,2900]},"content":"8.13.3.1.创建kube-proxy配置文件","children":[{"type":"fence","depth":5,"content":"<pre><code>cat &gt; /opt/kubernetes/cfg/kube-proxy.conf &lt;&lt; EOF\nKUBE_PROXY_OPTS=&quot;--logtostderr=false \\\\\n--v=2 \\\\\n--log-dir=/opt/kubernetes/logs \\\\\n--config=/opt/kubernetes/cfg/kube-proxy-config.yml&quot;\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":4,"payload":{"lines":[2908,2909]},"content":"8.13.3.2.配置参数文件","children":[{"type":"fence","depth":5,"content":"<pre><code>cat &gt; /opt/kubernetes/cfg/kube-proxy-config.yml &lt;&lt; EOF\nkind: KubeProxyConfiguration\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nbindAddress: 0.0.0.0\nmetricsBindAddress: 0.0.0.0:10249\nclientConnection:\n  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig\nhostnameOverride: binary-k8s-master1\nclusterCIDR: 10.244.0.0/16\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":4,"payload":{"lines":[2922,2923]},"content":"8.13.3.3.生成kube-proxy证书文件","children":[{"type":"fence","depth":5,"content":"<pre><code>cd ~/TLS/k8s\n</code></pre>\n"},{"type":"fence","depth":5,"content":"<pre><code>cat &gt; kube-proxy-csr.json &lt;&lt; EOF\n{\n    &quot;CN&quot;: &quot;system:kube-proxy&quot;,\n    &quot;hosts&quot;: [],\n    &quot;key&quot;: {\n    &quot;algo&quot;: &quot;rsa&quot;,\n    &quot;size&quot;: 2048\n    },\n    &quot;names&quot;: [\n    {\n        &quot;C&quot;: &quot;CN&quot;,\n        &quot;L&quot;: &quot;BeiJing&quot;,\n        &quot;ST&quot;: &quot;BeiJing&quot;,\n        &quot;O&quot;: &quot;k8s&quot;,\n        &quot;OU&quot;: &quot;System&quot;\n    }\n   ]\n}\nEOF\n</code></pre>\n"},{"type":"fence","depth":5,"content":"<pre><code>cfssl gencert -ca=ca.pem -ca-key=ca-key.pem \\\n-config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy\n</code></pre>\n"}]},{"type":"heading","depth":4,"payload":{"lines":[2956,2957]},"content":"8.13.3.4.生成kube-proxy.kubeconfig文件","children":[{"type":"fence","depth":5,"content":"<pre><code>KUBE_CONFIG=&quot;/opt/kubernetes/cfg/kube-proxy.kubeconfig&quot;\nKUBE_APISERVER=&quot;https://192.168.0.9:6443&quot;\n\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=${KUBE_CONFIG}\n  \nkubectl config set-credentials kube-proxy \\\n  --client-certificate=./kube-proxy.pem \\\n  --client-key=./kube-proxy-key.pem \\\n  --embed-certs=true \\\n  --kubeconfig=${KUBE_CONFIG}\n  \nkubectl config set-context default \\\n  --cluster=kubernetes \\\n  --user=kube-proxy \\\n  --kubeconfig=${KUBE_CONFIG}\n  \nkubectl config use-context default --kubeconfig=${KUBE_CONFIG}\n</code></pre>\n"}]},{"type":"heading","depth":4,"payload":{"lines":[2981,2982]},"content":"8.13.3.5.systemd管理kube-proxy","children":[{"type":"fence","depth":5,"content":"<pre><code>cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF\n[Unit]\nDescription=Kubernetes Proxy\nAfter=network.target\n\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf\nExecStart=/opt/kubernetes/bin/kube-proxy \\$KUBE_PROXY_OPTS\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\nEOF\n</code></pre>\n"}]},{"type":"heading","depth":4,"payload":{"lines":[2999,3000]},"content":"8.12.3.6.启动kube-proxy并设置开机自启","children":[{"type":"fence","depth":5,"content":"<pre><code>systemctl daemon-reload &amp;&amp;\nsystemctl start kube-proxy &amp;&amp;\nsystemctl enable kube-proxy\n</code></pre>\n"},{"type":"fence","depth":5,"content":"<pre><code>    systemctl status kube-proxy\n</code></pre>\n"}]}]},{"type":"heading","depth":3,"payload":{"lines":[3011,3012]},"content":"8.13.4.部署网络组件(Calico)","children":[{"type":"fence","depth":4,"content":"<pre><code>cd /root/TLS/k8s\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>wget http://docs.projectcalico.org/v3.8/manifests/calico.yaml\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cp calico.yaml calico.yaml.bak &amp;&amp; \nsed -i 's/192.168.0.0/10.244.0.0/g' calico.yaml\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>grep &quot;IPV4POOL_CIDR&quot; calico.yaml  -A 1 \\\n        - name: CALICO_IPV4POOL_CIDR    \\\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl apply -f calico.yaml\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl get pods -n kube-system\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl get nodes\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3063,3064]},"content":"8.13.5.授权apiserver访问kubelet","children":[{"type":"fence","depth":4,"content":"<pre><code>cat &gt; apiserver-to-kubelet-rbac.yaml &lt;&lt; EOF\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n  name: system:kube-apiserver-to-kubelet\nrules:\n  - apiGroups:\n      - &quot;&quot;\n    resources:\n      - nodes/proxy\n      - nodes/stats\n      - nodes/log\n      - nodes/spec\n      - nodes/metrics\n      - pods/log\n    verbs:\n      - &quot;*&quot;\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: system:kube-apiserver\n  namespace: &quot;&quot;\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:kube-apiserver-to-kubelet\nsubjects:\n  - apiGroup: rbac.authorization.k8s.io\n    kind: User\n    name: kubernetes\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl apply -f apiserver-to-kubelet-rbac.yaml\n</code></pre>\n"}]}]},{"type":"heading","depth":2,"payload":{"lines":[3110,3111]},"content":"8.14.增加Worker Node","children":[{"type":"heading","depth":3,"payload":{"lines":[3112,3113]},"content":"8.14.1.在所有Worker Node创建工作目录并拷贝二进制文件","children":[{"type":"fence","depth":4,"content":"<pre><code>mkdir -p /opt/kubernetes/bin &amp;&amp;\nmkdir -p /opt/kubernetes/cfg &amp;&amp;\nmkdir -p /opt/kubernetes/ssl &amp;&amp;\nmkdir -p /opt/kubernetes/logs\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3121,3122]},"content":"8.14.2拷贝Master Node1上部署好的文件到Worker Node","children":[{"type":"fence","depth":4,"content":"<pre><code>scp -r /opt/kubernetes root@192.168.0.10:/opt/ &amp;&amp;\nscp -r /usr/lib/systemd/system/{kubelet,kube-proxy}.service \\\nroot@192.168.0.10:/usr/lib/systemd/system &amp;&amp;\nscp -r /opt/kubernetes/ssl/ca.pem root@192.168.0.10:/opt/kubernetes/ssl/\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>scp -r /opt/kubernetes root@192.168.0.11:/opt/ &amp;&amp;\nscp -r /usr/lib/systemd/system/{kubelet,kube-proxy}.service \\\nroot@192.168.0.11:/usr/lib/systemd/system &amp;&amp;\nscp -r /opt/kubernetes/ssl/ca.pem root@192.168.0.11:/opt/kubernetes/ssl/\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3138,3139]},"content":"8.14.3.删除所有Worker Node中kubelet证书和kubeconfig文件","children":[{"type":"fence","depth":4,"content":"<pre><code>rm -f /opt/kubernetes/cfg/kubelet.kubeconfig &amp;&amp;\nrm -f /opt/kubernetes/ssl/kubelet*\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>rm -f /opt/kubernetes/cfg/kubelet.kubeconfig &amp;&amp;\nrm -f /opt/kubernetes/ssl/kubelet*\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3152,3153]},"content":"8.14.4. 修改Worker Node1和Worker Node2主机名","children":[{"type":"fence","depth":4,"content":"<pre><code>sed -i 's/--hostname-override=binary-k8s-master1/--hostname-override=binary-k8s-worker1/g' \\\n/opt/kubernetes/cfg/kubelet.conf #修改--hostname-override的值为binary-k8s-worker1\nsed -i 's/hostnameOverride: binary-k8s-master1/hostnameOverride: binary-k8s-worker1/g' \\\n/opt/kubernetes/cfg/kube-proxy-config.yml #修改hostnameOverride的值binary-k8s-worker1\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>sed -i 's/--hostname-override=binary-k8s-master1/--hostname-override=binary-k8s-worker2/g' \\\n/opt/kubernetes/cfg/kubelet.conf #修改--hostname-override的值为binary-k8s-worker2\nsed -i 's/hostnameOverride: binary-k8s-master1/hostnameOverride: binary-k8s-worker2/g' \\\n/opt/kubernetes/cfg/kube-proxy-config.yml #修改hostnameOverride的值binary-k8s-worker2\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3169,3170]},"content":"8.14.5.启动Worker Node1和Worker Node2中kubelet并设置开机自启","children":[{"type":"fence","depth":4,"content":"<pre><code>systemctl daemon-reload &amp;&amp; \nsystemctl start kubelet kube-proxy &amp;&amp; \nsystemctl enable kubelet kube-proxy\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>systemctl status kubelet\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>systemctl status kube-proxy\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat /var/log/messages|grep kube-proxy\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3188,3189]},"content":"8.14.6.在Master1上同意新的Node kubelet证书申请","children":[{"type":"fence","depth":4,"content":"<pre><code>kubectl get csr\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl certificate approve node-csr-TlSHYrzacOBQbJyQcfVwuArXPKRbjcoMESZykQ3Qr0w\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl certificate approve node-csr-vb-rAPL-grn0NxFGBs-_5pScCDkICmvHRnbhn_bRdsc\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl get nodes\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3225,3226]},"content":"8.14.7.在Master1上部署kubernetes-dashboard","children":[{"type":"fence","depth":4,"content":"<pre><code>cd /opt/k8s/package &amp;&amp;\nwget https://raw.githubusercontent.com/kubernetes/dashboard/v2.4.0/aio/deploy/recommended.yaml\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>vim recommended.yaml\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl apply -f recommended.yaml   \n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl get pods,svc -n kubernetes-dashboard\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl create serviceaccount dashboard-admin -n kube-system\nkubectl create clusterrolebinding dashboard-admin \\\n    --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin\nkubectl describe secrets -n kube-system \\\n$(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}')\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl describe secrets -n kube-system \\\n$(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}')\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3278,3279]},"content":"8.14.8.在Master1上部署CoreDNS","children":[{"type":"fence","depth":4,"content":"<pre><code>cd /opt/k8s/package/kubernetes &amp;&amp; \nmkdir  kubernetes-src &amp;&amp;\ntar fx kubernetes-src.tar.gz -C ./kubernetes-src &amp;&amp;\ncd kubernetes-src/cluster/addons/dns/coredns/ &amp;&amp;\ncp coredns.yaml.base coredns.yaml\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>CLUSTER_DNS_DOMAIN=&quot;cluster.local&quot;\nCLUSTER_DNS_SVC_IP=&quot;10.0.0.2&quot;\nCLUSTER_DNS_LIMIT_MEMORY=&quot;170Mi&quot;\n\nsed -i -e &quot;s@__DNS__DOMAIN__@${CLUSTER_DNS_DOMAIN}@&quot; \\\n        -e &quot;s@__DNS__SERVER__@${CLUSTER_DNS_SVC_IP}@&quot; \\\n        -e &quot;s@__DNS__MEMORY__LIMIT__@${CLUSTER_DNS_LIMIT_MEMORY}@&quot; \\\n        coredns.yaml\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>vim coredns.yaml\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl create serviceaccount coredns -n kube-system\nkubectl create clusterrolebinding coredns \\\n    --clusterrole=cluster-admin --serviceaccount=kube-system:coredns\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl apply -f coredns.yaml\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl get pods -n kube-system\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl logs PODNAME -n kube-system\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl scale deployment coredns --replicas=2 -n kube-system\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl create clusterrolebinding kube-apiserver:kubelet-apis \\\n--clusterrole=system:kubelet-api-admin --user kubernetes\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; busybox.yaml &lt;&lt; EOF\napiVersion: v1\nkind: Pod\nmetadata:\n  name: busybox\n  namespace: default\nspec:\n  containers:\n  - name: busybox\n    image: busybox:1.28.4\n    command:\n      - sleep\n      - &quot;3600&quot;\n    imagePullPolicy: IfNotPresent\n  restartPolicy: Always\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl create -f busybox.yaml\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl exec -it busybox -- sh\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl get deployments -n kube-system\n</code></pre>\n"}]}]},{"type":"heading","depth":2,"payload":{"lines":[3397,3398]},"content":"8.15.增加Master2节点","children":[{"type":"heading","depth":3,"payload":{"lines":[3402,3403]},"content":"8.15.1.Kubernetes集群架构简介","children":[{"type":"thead","depth":4,"payload":{"lines":[3416,3417]},"content":"","children":[{"type":"th","depth":5,"payload":{"lines":[3416,3417]},"content":"角色"},{"type":"th","depth":5,"payload":{"lines":[3416,3417]},"content":"IP"},{"type":"th","depth":5,"payload":{"lines":[3416,3417]},"content":"组件"}]},{"type":"tbody","depth":4,"payload":{"lines":[3418,3423]},"content":"","children":[{"type":"tr","depth":5,"payload":{},"content":"","children":[{"type":"td","depth":6,"payload":{},"content":"binary-k8s-master1"},{"type":"td","depth":6,"payload":{},"content":"192.168.0.9"},{"type":"td","depth":6,"payload":{},"content":"etcd <br> docker <br> kube-apiserver kube-controller-manager kube-scheduler <br> kubelet kube-proxy <br> nginx keepalived"}]},{"type":"tr","depth":5,"payload":{},"content":"","children":[{"type":"td","depth":6,"payload":{},"content":"binary-k8s-master2"},{"type":"td","depth":6,"payload":{},"content":"192.168.0.12"},{"type":"td","depth":6,"payload":{},"content":"etcd <br> docker <br> kube-apiserver kube-controller-manager kube-scheduler <br> kubelet kube-proxy <br> nginx keepalived"}]},{"type":"tr","depth":5,"payload":{},"content":"","children":[{"type":"td","depth":6,"payload":{},"content":"binary-k8s-worker1"},{"type":"td","depth":6,"payload":{},"content":"192.168.0.10"},{"type":"td","depth":6,"payload":{},"content":"etcd <br> docker <br> kubelet kube-proxy"}]},{"type":"tr","depth":5,"payload":{},"content":"","children":[{"type":"td","depth":6,"payload":{},"content":"binary-k8s-worker2"},{"type":"td","depth":6,"payload":{},"content":"192.168.0.11"},{"type":"td","depth":6,"payload":{},"content":"etcd <br> docker <br> kubelet kube-proxy"}]},{"type":"tr","depth":5,"payload":{},"content":"","children":[{"type":"td","depth":6,"payload":{},"content":"负载均衡器(虚拟IP)"},{"type":"td","depth":6,"payload":{},"content":"192.168.0.88"}]}]}]},{"type":"heading","depth":3,"payload":{"lines":[3430,3431]},"content":"8.15.2.给Master Node2安装Docker","children":[{"type":"fence","depth":4,"content":"<pre><code>scp /usr/bin/docker* root@192.168.0.12:/usr/bin &amp;&amp;\nscp /usr/bin/runc root@192.168.0.12:/usr/bin &amp;&amp;\nscp /usr/bin/containerd* root@192.168.0.12:/usr/bin &amp;&amp;\nscp /usr/lib/systemd/system/docker.service \\\nroot@192.168.0.12:/usr/lib/systemd/system &amp;&amp;\nscp -r /etc/docker root@192.168.0.12:/etc\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>systemctl daemon-reload &amp;&amp; systemctl start docker &amp;&amp; systemctl enable docker\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>    systemctl status docker\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3450,3451]},"content":"8.15.5.给Master Node2节点拷贝所有需要的证书","children":[{"type":"fence","depth":4,"content":"<pre><code>mkdir -p /opt/etcd/ssl\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>scp -r /opt/kubernetes root@192.168.0.12:/opt &amp;&amp;\nscp -r /opt/etcd/ssl root@192.168.0.12:/opt/etcd &amp;&amp;\nscp /usr/lib/systemd/system/kube* \\\nroot@192.168.0.12:/usr/lib/systemd/system &amp;&amp;\nscp /usr/bin/kubectl  root@192.168.0.12:/usr/bin &amp;&amp;\nscp -r ~/.kube root@192.168.0.12:~\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>rm -f /opt/kubernetes/cfg/kubelet.kubeconfig &amp;&amp;\nrm -f /opt/kubernetes/ssl/kubelet*\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>vi /opt/kubernetes/cfg/kube-apiserver.conf \n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>vi /opt/kubernetes/cfg/kube-controller-manager.kubeconfig\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>vi /opt/kubernetes/cfg/kube-scheduler.kubeconfig\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>vi /opt/kubernetes/cfg/kubelet.conf\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>vi /opt/kubernetes/cfg/kube-proxy-config.yml\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>vi ~/.kube/config\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3510,3511]},"content":"8.15.6.启动Master所有服务并设置开机自启","children":[{"type":"fence","depth":4,"content":"<pre><code>systemctl daemon-reload &amp;&amp;\nsystemctl start kube-apiserver &amp;&amp;\nsystemctl start kube-controller-manager &amp;&amp;\nsystemctl start kube-scheduler &amp;&amp;\nsystemctl start kubelet kube-proxy &amp;&amp;\nsystemctl enable kube-apiserver &amp;&amp;\nsystemctl enable kube-controller-manager &amp;&amp;\nsystemctl enable kube-scheduler &amp;&amp;\nsystemctl enable kubelet &amp;&amp;\nsystemctl enable kube-proxy\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3524,3525]},"content":"8.15.7.在Master查看集群组件状态","children":[{"type":"fence","depth":4,"content":"<pre><code>kubectl get cs\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3540,3541]},"content":"8.15.8.审批所有Worker  Node上的kubelet证书申请","children":[{"type":"fence","depth":4,"content":"<pre><code>kubectl get csr\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl certificate approve node-csr-Pkp1fPd9NZApJVRqRFlIIjskZ_gL_qDmcSWGvSuN-VQ\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl get csr\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl get pods -n kube-system\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl get nodes\n</code></pre>\n"}]}]},{"type":"heading","depth":2,"payload":{"lines":[3586,3587]},"content":"8.16.部署Nginx+Keepalived高可用负载均衡器","children":[{"type":"heading","depth":3,"payload":{"lines":[3588,3589]},"content":"8.16.1.Nginx和Keepalived简介"},{"type":"heading","depth":3,"payload":{"lines":[3595,3596]},"content":"8.16.2.在两台Master Node上安装软件","children":[{"type":"fence","depth":4,"content":"<pre><code>yum install epel-release -y &amp;&amp;\nyum install nginx keepalived -y\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /etc/nginx/nginx.conf &lt;&lt; &quot;EOF&quot;\nuser nginx;\nworker_processes auto;\nerror_log /var/log/nginx/error.log;\npid /run/nginx.pid;\n\ninclude /usr/share/nginx/modules/*.conf;\n\nevents {\n    worker_connections 1024;\n}\n\nstream {\n\n    log_format main '$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent';\n\n    access_log  /var/log/nginx/k8s-access.log  main;\n\n    upstream k8s-apiserver {\n       server 192.168.0.9:6443;   # Master1 APISERVER IP:PORT\n       server 192.168.0.12:6443;   # Master2 APISERVER IP:PORT\n    }\n    \n    server {\n       listen 16443; # 由于nginx与master节点复用，这个监听端口不能是6443，否则会冲突\n       proxy_pass k8s-apiserver;\n    }\n}\n\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '\n                      '$status $body_bytes_sent &quot;$http_referer&quot; '\n                      '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n\n    server {\n        listen       80 default_server;\n        server_name  _;\n\n        location / {\n        }\n    }\n}\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF\nglobal_defs { \n   notification_email { \n     acassen@firewall.loc \n     failover@firewall.loc \n     sysadmin@firewall.loc \n   } \n   notification_email_from Alexandre.Cassen@firewall.loc  \n   smtp_server 127.0.0.1 \n   smtp_connect_timeout 30 \n   router_id NGINX_MASTER\n} \n\nvrrp_script check_nginx {\n    script &quot;/etc/keepalived/check_nginx.sh&quot;\n}\n\nvrrp_instance VI_1 { \n    state MASTER \n    interface ens33  # 修改为实际网卡名\n    virtual_router_id 51 # VRRP 路由 ID实例，每个实例是唯一的 \n    priority 100    # 优先级，备服务器设置 90 \n    advert_int 1    # 指定VRRP 心跳包通告间隔时间，默认1秒 \n    authentication { \n        auth_type PASS      \n        auth_pass 1111 \n    }  \n    # 虚拟IP\n    virtual_ipaddress { \n        192.168.0.88/24\n    } \n    track_script {\n        check_nginx\n    } \n}\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF\nglobal_defs { \n   notification_email { \n     acassen@firewall.loc \n     failover@firewall.loc \n     sysadmin@firewall.loc \n   } \n   notification_email_from Alexandre.Cassen@firewall.loc  \n   smtp_server 127.0.0.1 \n   smtp_connect_timeout 30 \n   router_id NGINX_BACKUP\n} \n\nvrrp_script check_nginx {\n    script &quot;/etc/keepalived/check_nginx.sh&quot;\n}\n\nvrrp_instance VI_1 { \n    state BACKUP \n    interface ens33\n    virtual_router_id 51 # VRRP 路由 ID实例，每个实例是唯一的 \n    priority 90\n    advert_int 1\n    authentication { \n        auth_type PASS      \n        auth_pass 1111 \n    }  \n    virtual_ipaddress { \n        192.168.0.88/24\n    } \n    track_script {\n        check_nginx\n    } \n}\nEOF\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>cat &gt; /etc/keepalived/check_nginx.sh  &lt;&lt; &quot;EOF&quot;\n#!/bin/bash\ncount=$(ss -antp |grep 16443 |egrep -cv &quot;grep|$$&quot;)\n\nif [ &quot;$count&quot; -eq 0 ];then\n    exit 1\nelse\n    exit 0\nfi\nEOF\n\nchmod +x /etc/keepalived/check_nginx.sh\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3760,3761]},"content":"8.16.3.Nginx增加Steam模块","children":[{"type":"heading","depth":4,"payload":{"lines":[3761,3762]},"content":"8.16.3.1.查看Nginx版本模块"},{"type":"heading","depth":4,"payload":{"lines":[3764,3765]},"content":"8.16.3.2.Master1和Master2安装Stream模块","children":[{"type":"fence","depth":5,"content":"<pre><code>mv /usr/sbin/nginx /usr/sbin/nginx.bak &amp;&amp;\ncp -r /etc/nginx{,.bak}\n</code></pre>\n"},{"type":"fence","depth":5,"content":"<pre><code>cd /opt/k8s/package/\n</code></pre>\n"},{"type":"fence","depth":5,"content":"<pre><code>yum -y install libxml2 libxml2-dev libxslt-devel \nyum -y install gd-devel \nyum -y install perl-devel perl-ExtUtils-Embed \nyum -y install GeoIP GeoIP-devel GeoIP-data\nyum -y install pcre-devel\nyum -y install openssl openssl-devel\nyum -y install gcc make\n</code></pre>\n"},{"type":"fence","depth":5,"content":"<pre><code>tar -xf nginx-1.20.1.tar.gz\ncd nginx-1.20.1/\n./configure --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx \\\n--modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf  --with-stream\nmake\n</code></pre>\n"},{"type":"fence","depth":5,"content":"<pre><code>./objs/nginx -t\n</code></pre>\n"},{"type":"fence","depth":5,"content":"<pre><code>cp ./objs/nginx /usr/sbin/ &amp;&amp;\nscp objs/nginx root@192.168.0.12:/usr/sbin/\n</code></pre>\n"},{"type":"fence","depth":5,"content":"<pre><code>rm -rf /usr/lib/systemd/system/nginx.service &amp;&amp;\ncat &gt;&gt; /usr/lib/systemd/system/nginx.service &lt;&lt; EOF\n[Unit]\nDescription=The nginx HTTP and reverse proxy server\nAfter=network.target remote-fs.target nss-lookup.target\n[Service]\nType=forking\nPIDFile=/run/nginx.pid\nExecStartPre=/usr/bin/rm -rf /run/nginx.pid\nExecStartPre=/usr/sbin/nginx -t\nExecStart=/usr/sbin/nginx\nExecStop=/usr/sbin/nginx -s stop\nExecReload=/usr/sbin/nginx -s reload\nPrivateTmp=true\n[Install]\nWantedBy=multi-user.target\nEOF\n</code></pre>\n"}]}]},{"type":"heading","depth":3,"payload":{"lines":[3835,3836]},"content":"8.16.4.启动nginx、keepalived并设置开机自启(master1/master2)","children":[{"type":"fence","depth":4,"content":"<pre><code>systemctl daemon-reload &amp;&amp;\nsystemctl start nginx keepalived &amp;&amp;\nsystemctl enable nginx keepalived\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3841,3842]},"content":"8.16.5.查看keepalived工作状态","children":[{"type":"fence","depth":4,"content":"<pre><code>ip addr\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>ip addr\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3885,3886]},"content":"8.16.6.Nginx+keepalived高可用测试","children":[{"type":"fence","depth":4,"content":"<pre><code>pkill nginx\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>ip addr\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3918,3919]},"content":"8.16.7.测试负载均衡器","children":[{"type":"fence","depth":4,"content":"<pre><code>curl -k https://192.168.0.88:16443/version\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>tailf /var/log/nginx/k8s-access.log\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[3995,3996]},"content":"8.16.8.修改所有的Worker Node连接LB VIP","children":[{"type":"fence","depth":4,"content":"<pre><code>sed -i 's#192.168.0.9:6443#192.168.0.88:16443#' /opt/kubernetes/cfg/* &amp;&amp;\nsystemctl restart kubelet kube-proxy\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>kubectl get nodes\n</code></pre>\n"}]}]},{"type":"heading","depth":2,"payload":{"lines":[4032,4033]},"content":"8.17.部署常见问题","children":[{"type":"heading","depth":3,"payload":{"lines":[4033,4034]},"content":"8.17.1系统断电后,某个etcd节点无法启动","children":[{"type":"fence","depth":4,"content":"<pre><code>cd /var/lib/etcd/default.etcd/member/ &amp;&amp;\ncp * /data/bak/\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>rm -rf /var/lib/etcd/default.etcd/member/*\n</code></pre>\n"},{"type":"fence","depth":4,"content":"<pre><code>systemctl stop etcd &amp;&amp;\nsystemctl restart etcd\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[4055,4056]},"content":"8.17.2 The connection to the server localhost:8080 was refused - did you specify the right host or port?"}]},{"type":"heading","depth":2,"payload":{"lines":[4059,4060]},"content":"8.18.部署测试程序","children":[{"type":"fence","depth":3,"content":"<pre><code>kubectl create deployment guestbook --image=ibmcom/guestbook:v1\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubectl get pods\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubectl expose deployment guestbook --type=NodePort --port=3000\n</code></pre>\n"},{"type":"fence","depth":3,"content":"<pre><code>kubectl get service guestbook\n</code></pre>\n"}]}]}],"payload":{}},{})</script>
</body>
</html>
